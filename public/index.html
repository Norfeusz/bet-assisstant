<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League Configuration - Bet Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .summary {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .summary-item .label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .actions {
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .countries-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-height: 700px;
            overflow-y: auto;
        }

        .countries-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .country-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .country-item:hover {
            background: #f7fafc;
        }

        .country-item.active {
            background: #667eea;
            color: white;
        }

        .country-name {
            font-weight: 500;
        }

        .country-badge {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .leagues-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-height: 700px;
            overflow-y: auto;
        }

        .leagues-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .league-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .league-item:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .league-item.selected {
            background: #ebf4ff;
            border-color: #667eea;
        }

        .league-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .league-logo {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            object-fit: contain;
        }

        .league-info {
            flex: 1;
        }

        .league-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .league-type {
            font-size: 12px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #48bb78;
        }

        .toast.error {
            border-left: 4px solid #f56565;
        }

        /* Tabs */
        .tabs {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-button {
            flex: 1;
            padding: 15px 30px;
            background: white;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tab-button:hover {
            background: #f9fafb;
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Database Filters */
        .database-filters {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .filter-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            background: #f9fafb;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .filter-search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .filter-search-input::placeholder {
            color: #9ca3af;
            font-size: 12px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:hover {
            border-color: #667eea;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select option {
            padding: 10px;
        }

        /* Limit buttons */
        .limit-buttons-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .limit-buttons-container label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-right: 5px;
        }

        .limit-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 50px;
        }

        .limit-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .limit-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Bet Finder Styles */
        .match-count-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .match-count-btn {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 60px;
        }

        .match-count-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .match-count-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .date-range-selector {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .date-input {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .bet-finder-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .bet-finder-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .bet-finder-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.5);
        }

        .bet-finder-btn:active {
            transform: translateY(-1px);
        }

        .btn-with-info {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            font-weight: 700;
            cursor: help;
            transition: all 0.2s;
        }

        .info-icon:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .info-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            white-space: normal;
            text-align: center;
            line-height: 1.4;
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
        }

        .btn-with-info:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: 130%;
        }

        /* Team Statistics Panel */
        .team-stats-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .team-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .team-stats-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .team-stats-league-select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .team-stats-league-select:hover {
            border-color: #667eea;
        }

        .team-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* Group backgrounds */
        .stat-card.group-points {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #bfdbfe 100%);
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.08);
        }

        .stat-card.group-halves {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #a7f3d0 100%);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.08);
        }

        .stat-card.group-goals {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 50%, #fdba74 100%);
            box-shadow: 0 4px 6px rgba(249, 115, 22, 0.08);
        }

        .stat-card.group-corners {
            background: linear-gradient(135deg, #faf5ff 0%, #e9d5ff 50%, #d8b4fe 100%);
            box-shadow: 0 4px 6px rgba(168, 85, 247, 0.08);
        }

        .stat-card.group-shots {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 50%, #e5e7eb 100%);
            box-shadow: 0 4px 6px rgba(107, 114, 128, 0.08);
        }

        .stat-card.group-other {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fde68a 100%);
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.08);
        }

        .stat-card.group-overunder {
            background: linear-gradient(135deg, #fef8f3 0%, #fde8d7 50%, #fcd9c0 100%);
            box-shadow: 0 4px 6px rgba(194, 120, 57, 0.12);
        }

        /* Colored borders */
        .stat-card.border-green {
            border: 2px solid #10b981;
        }

        .stat-card.border-red {
            border: 2px solid #ef4444;
        }

        .stat-card.border-yellow {
            border: 2px solid #f59e0b;
        }

        /* Dynamic text colors */
        .stat-card-value.text-green {
            color: #10b981 !important;
        }

        .stat-card-value.text-yellow {
            color: #f59e0b !important;
        }

        .stat-card-value.text-red {
            color: #ef4444 !important;
        }

        .stat-card-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.highlight .stat-card-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-card-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .stat-card.highlight .stat-card-value {
            color: white;
        }

        .stat-card-subtitle {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .stat-card.highlight .stat-card-subtitle {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Stat cards clickable */
        .stat-card {
            cursor: pointer;
            user-select: none;
        }

        .stat-card:active {
            transform: translateY(0);
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            animation: fadeIn 0.2s ease-in-out;
        }

        .modal-backdrop.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-match-item {
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-match-item:last-child {
            border-bottom: none;
        }

        .modal-match-date {
            font-size: 13px;
            color: #6b7280;
            min-width: 90px;
        }

        .modal-match-opponent {
            flex: 1;
            margin: 0 15px;
            font-size: 14px;
            color: #333;
        }

        .modal-match-result {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            margin: 0 10px;
        }

        .modal-match-result.win {
            background: #d1fae5;
            color: #065f46;
        }

        .modal-match-result.draw {
            background: #fef3c7;
            color: #92400e;
        }

        .modal-match-result.loss {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal-match-value {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            min-width: 50px;
            text-align: right;
        }

        .modal-match-value.highlight {
            color: #667eea;
            font-weight: 800;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-minimize {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
        }

        .modal-minimize:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Minimized Modal Card */
        .minimized-card {
            position: fixed;
            bottom: 20px;
            right: -240px;
            /* Hide more of the card - only ~60px visible */
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 0 0 12px;
            /* Only left corners rounded */
            box-shadow: -4px 4px 20px rgba(245, 87, 108, 0.4);
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInRight 0.3s ease-out;
            opacity: 0.35;
        }

        .minimized-card:hover {
            right: 0;
            /* Slide in fully on hover */
            box-shadow: -6px 6px 25px rgba(245, 87, 108, 0.5);
            opacity: 1;
        }

        /* Add a visible tab handle on the edge */
        .minimized-card::before {
            content: '‚óÄ';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: inherit;
            color: white;
            padding: 8px 6px;
            border-radius: 8px 0 0 8px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0.9;
        }

        .minimized-card-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .minimized-card-icon {
            font-size: 24px;
        }

        .minimized-card-text {
            font-size: 14px;
            font-weight: 600;
        }

        .minimized-card-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .minimized-card-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        @keyframes slideInRight {
            from {
                right: -300px;
                opacity: 0;
            }

            to {
                right: -240px;
                opacity: 0.35;
            }
        }

        /* Team Link Styles */
        .team-link {
            color: inherit;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: inline-block;
        }

        .team-link:hover {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Bet Finder Modal Styles */
        #bet-finder-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Minimized cards for match details - left side */
        .minimized-match-card {
            position: fixed;
            left: -220px;
            /* Hide more of the card - only ~60px visible */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 0 12px 12px 0;
            /* Only right corners rounded */
            box-shadow: 4px 4px 20px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInFromLeft 0.3s ease-out;
            opacity: 0.35;
            min-width: 280px;
            /* Ensure minimum width for visibility */
        }

        /* Add a visible tab handle on the edge */
        .minimized-match-card::before {
            content: '‚ñ∂';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: inherit;
            color: white;
            padding: 8px 6px;
            border-radius: 0 8px 8px 0;
            font-size: 12px;
            pointer-events: none;
            opacity: 0.9;
        }

        .minimized-match-card:hover {
            left: 0;
            /* Slide in fully on hover */
            box-shadow: 6px 6px 25px rgba(102, 126, 234, 0.5);
            opacity: 1;
        }

        @keyframes slideInFromLeft {
            from {
                left: -300px;
                opacity: 0;
            }

            to {
                left: -220px;
                opacity: 0.35;
            }
        }

        /* Match details modal styles */
        #match-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10002;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #match-details-modal .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
        }

        #match-details-modal .modal-dialog {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 1400px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10002;
            animation: slideIn 0.3s ease-out;
        }

        /* Watched matches modal styles */
        #watched-matches-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10002;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #watched-matches-modal .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
        }

        #watched-matches-modal .modal-dialog {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 1800px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10002;
            animation: slideIn 0.3s ease-out;
            margin-top: 40px;
        }

        #bet-finder-modal .modal-backdrop {
            display: block;
            z-index: 9999;
        }

        #bet-finder-modal .modal-dialog {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10001;
            animation: slideIn 0.3s ease-out;
        }

        #bet-finder-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }

        #bet-finder-modal .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        #bet-finder-modal .modal-body {
            padding: 25px 30px;
            overflow-y: auto;
            flex: 1;
        }

        #bet-finder-modal .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #bet-finder-modal .results-table th {
            background: #f9fafb;
            padding: 12px 10px;
            text-align: left;
            font-weight: 700;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        #bet-finder-modal .results-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f3f4f6;
        }

        #bet-finder-modal .results-table tr:hover {
            background: #fef3f4;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Matches Section Styles */
        .matches-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin: 20px 0 15px 0;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Matches Table Styles */
        .matches-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .matches-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .matches-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .matches-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .matches-table tbody tr:hover {
            background: #f9fafb;
        }

        .matches-table tbody tr:last-child td {
            border-bottom: none;
        }

        .match-date {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
        }

        .match-teams {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team-name {
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .team-name.win {
            background: #d1fae5;
            color: #065f46;
        }

        .team-name.loss {
            background: #fee2e2;
            color: #991b1b;
        }

        .team-name.draw {
            background: #fef3c7;
            color: #92400e;
        }

        .match-score {
            font-weight: 700;
            font-size: 16px;
            white-space: nowrap;
        }

        .score-main {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .score-main.win {
            background: #d1fae5;
            color: #065f46;
        }

        .score-main.loss {
            background: #fee2e2;
            color: #991b1b;
        }

        .score-main.draw {
            background: #fef3c7;
            color: #92400e;
        }

        .score-ht {
            font-size: 12px;
            color: #666;
            margin-left: 4px;
        }

        .match-league {
            color: #667eea;
            font-size: 13px;
            font-weight: 500;
        }

        .match-status {
            text-align: center;
            font-size: 18px;
        }

        .expand-icon {
            cursor: pointer;
            font-size: 18px;
            text-align: center;
            transition: transform 0.3s;
            user-select: none;
        }

        .expand-icon:hover {
            transform: scale(1.2);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .results-count {
            color: #666;
            font-size: 14px;
            font-weight: 600;
        }

        /* Background Jobs Styles */
        .job-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .job-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .job-title {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }

        .job-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .job-status-pending {
            background: #e3f2fd;
            color: #1976d2;
        }

        .job-status-running {
            background: #c8e6c9;
            color: #388e3c;
        }

        .job-status-paused {
            background: #fff9c4;
            color: #f57f17;
        }

        .job-status-completed {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .job-status-failed {
            background: #ffcdd2;
            color: #c62828;
        }

        .job-status-rate_limited {
            background: #ffe0b2;
            color: #e65100;
        }

        .job-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
            font-size: 13px;
            color: #666;
        }

        .job-progress {
            margin: 10px 0;
        }

        .job-progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        .job-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .job-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .job-action-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .job-action-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .job-action-btn.danger {
            color: #d32f2f;
            border-color: #ffcdd2;
        }

        .job-action-btn.danger:hover {
            background: #ffebee;
            border-color: #d32f2f;
        }

        #background-import-modal .modal-body {
            max-height: 500px;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚öΩ Bet Assistant</h1>
            <p>System zarzƒÖdzania danymi mecz√≥w pi≈Çkarskich</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tabs-header">
                <button class="tab-button" onclick="switchTab('import')">
                    üì• Import
                </button>
                <button class="tab-button" onclick="switchTab('database')">
                    üóÑÔ∏è Baza Danych
                </button>
                <button class="tab-button active" onclick="switchTab('bet-finder')">
                    üîç Wyszukiwarka Typ√≥w
                </button>
            </div>
        </div>

        <!-- Tab Content: Import -->
        <div class="tab-content" id="tab-import">
            <!-- Summary -->
            <div class="summary" id="summary">
                <div class="summary-item">
                    <div class="number" id="total-leagues">0</div>
                    <div class="label">Wszystkie Ligi</div>
                </div>
                <div class="summary-item">
                    <div class="number" id="enabled-leagues">0</div>
                    <div class="label">Wybrane</div>
                </div>
                <div class="summary-item">
                    <div class="number" id="disabled-leagues">0</div>
                    <div class="label">Niewybrane</div>
                </div>
            </div>

            <!-- API Rate Limit Info -->
            <div class="summary" id="rate-limit-info" style="display: none;"
                title="Statystyki u≈ºycia API - od≈õwie≈ºane co 30 sekund">
                <div class="summary-item" style="color: white;">
                    <div class="number" id="daily-remaining" style="color: white;">-</div>
                    <div class="label" style="color: rgba(255,255,255,0.9);">Pozosta≈Ço Token√≥w Dziennie</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 3px;">
                        <span id="daily-used">-</span> / <span id="daily-limit">-</span> u≈ºyte
                    </div>
                </div>
                <div class="summary-item" style="color: white;">
                    <div class="number" id="hourly-remaining" style="color: white;">-</div>
                    <div class="label" style="color: rgba(255,255,255,0.9);">Pozosta≈Ço Token√≥w na Godzinƒô</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 3px;">
                        <span id="hourly-used">-</span> / <span id="hourly-limit">-</span> u≈ºyte
                    </div>
                </div>
                <div class="summary-item" style="color: white;">
                    <div class="number" id="next-reset" style="color: white; font-size: 24px;">-</div>
                    <div class="label" style="color: rgba(255,255,255,0.9);">Reset Godzinowy Za</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 3px;">
                        Reset dzienny o p√≥≈Çnocy
                    </div>
                </div>
            </div>

            <!-- Background Jobs Section -->
            <div
                style="background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    ü§ñ Zadania w Tle
                    <button class="btn" style="background: #10b981; color: white; margin-left: auto; padding: 8px 16px;"
                        onclick="showBackgroundImportDialog()">
                        ‚ûï Nowe Zadanie
                    </button>
                    <button class="btn" id="toggle-hidden-btn"
                        style="background: #6b7280; color: white; padding: 8px 16px;" onclick="toggleHiddenJobs()">
                        üëÅÔ∏è Poka≈º Ukryte
                    </button>
                    <button class="btn" style="background: #3b82f6; color: white; padding: 8px 16px;"
                        onclick="refreshBackgroundJobs()">
                        üîÑ Od≈õwie≈º
                    </button>
                </h2>
                <div id="background-jobs-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        ≈Åadowanie zada≈Ñ...
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-primary" onclick="autoSelect()">
                    ü§ñ Auto-wyb√≥r Rekomendowanych
                </button>
                <button class="btn" style="background: #10b981; color: white;" onclick="showSavePresetDialog()">
                    üíæ Zapisz Wyb√≥r
                </button>
                <button class="btn" style="background: #3b82f6; color: white;" onclick="showLoadPresetDialog()">
                    üìÇ Wczytaj Wyb√≥r
                </button>
                <button class="btn btn-success" onclick="showImportDialog()">
                    üì• Importuj Mecze
                </button>
                <button class="btn" id="resume-btn" style="background: #f59e0b; color: white; display: none;"
                    onclick="resumeImport()">
                    üîÑ Wzn√≥w Import
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    üóëÔ∏è Wyczy≈õƒá Wszystkie
                </button>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Countries -->
                <div class="countries-panel">
                    <h2>üåç Kraje</h2>
                    <div id="countries-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            ≈Åadowanie kraj√≥w...
                        </div>
                    </div>
                </div>

                <!-- Leagues -->
                <div class="leagues-panel">
                    <h2>üèÜ Ligi</h2>
                    <div id="leagues-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üëà</div>
                            <p>Wybierz kraj aby zobaczyƒá dostƒôpne ligi</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab Content: Import -->

        <!-- Tab Content: Database -->
        <div class="tab-content" id="tab-database">
            <!-- Database Filters -->
            <div class="database-filters">
                <h2 style="margin-bottom: 20px; color: #333;">üîç Filtruj Mecze</h2>

                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filter-country">üåç Kraj</label>
                        <input type="text" id="filter-country-search" class="filter-search-input"
                            placeholder="üîç Wyszukaj kraj..."
                            oninput="filterSelectOptions('filter-country', 'filter-country-search')" />
                        <select id="filter-country" class="filter-select" onchange="onCountryFilterChange()">
                            <option value="">Wszystkie Kraje</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-league">üèÜ Liga</label>
                        <input type="text" id="filter-league-search" class="filter-search-input"
                            placeholder="üîç Wyszukaj ligƒô..."
                            oninput="filterSelectOptions('filter-league', 'filter-league-search')" />
                        <select id="filter-league" class="filter-select" onchange="onLeagueFilterChange()">
                            <option value="">Wszystkie Ligi</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-team">‚öΩ Dru≈ºyna</label>
                        <input type="text" id="filter-team-search" class="filter-search-input"
                            placeholder="üîç Wyszukaj dru≈ºynƒô..."
                            oninput="filterSelectOptions('filter-team', 'filter-team-search')" />
                        <select id="filter-team" class="filter-select" onchange="onTeamFilterChange()">
                            <option value="">Wszystkie Dru≈ºyny</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        ÔøΩ Szukaj
                    </button>
                    <button class="btn" style="background: #6b7280; color: white;" onclick="resetFilters()">
                        üîÑ Resetuj Filtry
                    </button>
                </div>
            </div>

            <!-- Database Results -->
            <div class="database-filters" style="min-height: 300px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">üìä Wyniki</h2>
                    <div class="limit-buttons-container" style="margin: 0;">
                        <button class="limit-btn" onclick="setLimitAndFilter(5)">5</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(10)">10</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(15)">15</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(20)">20</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(25)">25</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(30)">30</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(40)">40</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(50)">50</button>
                        <button class="limit-btn" onclick="setLimitAndFilter(100)">100</button>
                        <span style="color: #999; margin: 0 5px;">‚Ä¢‚Ä¢‚Ä¢</span>
                        <button class="limit-btn active" onclick="setLimitAndFilter(null)">00</button>
                    </div>
                </div>

                <!-- Team Statistics Panel (hidden by default) -->
                <div id="team-stats-container" style="display: none;"></div>

                <div id="database-results">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>Wybierz filtry i kliknij Szukaj aby zobaczyƒá mecze</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab Content: Database -->

        <!-- Tab Content: Bet Finder -->
        <div class="tab-content active" id="tab-bet-finder">
            <div class="container">
                <h2 style="margin-bottom: 20px;">üîç Wyszukiwarka Typ√≥w</h2>

                <!-- Match Count Selection -->
                <div class="section">
                    <h3>Liczba mecz√≥w do analizy</h3>
                    <div class="match-count-selector">
                        <button class="match-count-btn" data-count="5">5</button>
                        <button class="match-count-btn active" data-count="10">10</button>
                        <button class="match-count-btn" data-count="15">15</button>
                        <button class="match-count-btn" data-count="20">20</button>
                        <button class="match-count-btn" data-count="30">30</button>
                        <button class="match-count-btn" data-count="50">50</button>
                        <button class="match-count-btn" data-count="all">Wszystkie</button>
                    </div>
                </div>

                <!-- Date Range Selection -->
                <div class="section">
                    <h3>Zakres dat nadchodzƒÖcych mecz√≥w</h3>
                    <div class="date-range-selector">
                        <div class="date-input-group">
                            <label for="bet-finder-date-from">Od:</label>
                            <input type="date" id="bet-finder-date-from" class="date-input">
                        </div>
                        <div class="date-input-group">
                            <label for="bet-finder-date-to">Do:</label>
                            <input type="date" id="bet-finder-date-to" class="date-input">
                        </div>
                    </div>
                </div>

                <!-- Search Buttons -->
                <div class="section">
                    <h3>Wyszukaj typy</h3>
                    <div class="bet-finder-buttons">
                        <button class="bet-finder-btn btn-with-info" onclick="findMostGoals()">
                            üî• Najwiƒôcej bramek
                            <span class="info-icon">i</span>
                            <span class="info-tooltip">
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najwy≈ºszƒÖ ≈õredniƒÖ bramek w ostatnich meczach
                            </span>
                        </button>
                        <button class="bet-finder-btn btn-with-info" onclick="findLeastGoals()"
                            style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);">
                            üßä Najmniej bramek
                            <span class="info-icon">i</span>
                            <span class="info-tooltip">
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najni≈ºszƒÖ ≈õredniƒÖ bramek w ostatnich meczach
                            </span>
                        </button>
                        <button class="bet-finder-btn btn-with-info" onclick="findGoalAdvantage()"
                            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            ‚ö° Przewaga bramek
                            <span class="info-icon">i</span>
                            <span class="info-tooltip">
                                Znajduje mecze gdzie jedna dru≈ºyna du≈ºo strzela, a druga du≈ºo traci - idealny moment na
                                zak≈Çad
                            </span>
                        </button>
                        <button class="bet-finder-btn btn-with-info" onclick="findHandicap15()"
                            style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            üéØ Handi 1.5
                            <span class="info-icon">i</span>
                            <span class="info-tooltip">
                                Znajduje mecze gdzie jedna dru≈ºyna czƒôsto wygrywa r√≥≈ºnicƒÖ ‚â•2, a druga czƒôsto przegrywa
                                r√≥≈ºnicƒÖ ‚â•2
                            </span>
                        </button>
                        <button class="bet-finder-btn btn-with-info" onclick="findMostCorners()"
                            style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                            ‚öΩ Najwiƒôcej ro≈ºnych
                            <span class="info-icon">i</span>
                            <span class="info-tooltip">
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najwy≈ºszƒÖ ≈õredniƒÖ rzut√≥w ro≈ºnych w ostatnich
                                meczach
                            </span>
                        </button>
                        <button class="bet-finder-btn btn-with-info" onclick="findLeastCorners()"
                            style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);">
                            üéØ Najmniej ro≈ºnych
                            <span class="info-icon">i</span>
                            <span class="info-tooltip">
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najni≈ºszƒÖ ≈õredniƒÖ rzut√≥w ro≈ºnych w ostatnich
                                meczach
                            </span>
                        </button>

                        <button class="bet-finder-btn" onclick="showWatchedMatchesModal();"
                            style="background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);">
                            <span style="font-size: 24px;">‚≠ê</span>
                            <span style="font-weight: 700; font-size: 16px;">Obserwowane mecze</span>
                            <span class="info-icon">‚ìò</span>
                            <span class="info-tooltip">
                                Wy≈õwietla wszystkie mecze dodane do obserwowanych z r√≥≈ºnych wyszukiwa≈Ñ
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Results will be shown in modal -->
            </div>
        </div>
        <!-- End Tab Content: Bet Finder -->

    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Import Dialog -->
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <h2>üì• Importuj Mecze</h2>
            <p style="color: #666; margin-bottom: 20px;">Wybierz zakres dat aby zaimportowaƒá dane meczowe</p>

            <div class="quick-dates">
                <button class="quick-date-btn" onclick="setQuickDate('week')">Ostatnie 7 dni</button>
                <button class="quick-date-btn" onclick="setQuickDate('2weeks')">Ostatnie 2 tygodnie</button>
                <button class="quick-date-btn" onclick="setQuickDate('month')">Ostatni miesiƒÖc</button>
                <button class="quick-date-btn" onclick="setQuickDate('3months')">Ostatnie 3 miesiƒÖce</button>
            </div>

            <div class="date-inputs">
                <div class="date-input-group">
                    <label for="start-date">Data PoczƒÖtkowa:</label>
                    <input type="date" id="start-date" class="date-input">
                </div>
                <div class="date-input-group">
                    <label for="end-date">Data Ko≈Ñcowa:</label>
                    <input type="date" id="end-date" class="date-input">
                </div>
            </div>

            <div class="import-info">
                <p>üìä <strong id="league-count">0</strong> wybranych lig</p>
                <p>üîÑ <strong>Auto-ponowienie:</strong> Automatycznie poczeka 1 godzinƒô po osiƒÖgniƒôciu limitu</p>
                <p>‚ö†Ô∏è Import mo≈ºe zajƒÖƒá kilka godzin w zale≈ºno≈õci od zakresu dat</p>
                <p>ÔøΩ You can close this window - import will continue in background</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="startImport()">
                    ‚úÖ Rozpocznij Import
                </button>
                <button class="btn" style="background: #718096; color: white;" onclick="closeImportDialog()">
                    ‚ùå Anuluj
                </button>
            </div>
        </div>
    </div>

    <!-- Import Progress Dialog -->
    <div class="modal" id="progress-modal">
        <div class="modal-content">
            <h2>üì• Importowanie Mecz√≥w...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text" style="text-align: center; margin-top: 15px; color: #666;">Rozpoczynam import...</p>
            <p style="text-align: center; margin-top: 10px; font-size: 12px; color: #999;">
                Import dzia≈Ça w tle z automatycznym ponowieniem. Mo≈ºesz zamknƒÖƒá to okno.
            </p>
            <div style="text-align: center; margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn" style="background: #f56565; color: white;" onclick="stopImport()">
                    ‚è∏Ô∏è Zatrzymaj import
                </button>
                <button class="btn" style="background: #e53e3e; color: white;" onclick="cancelImport()">
                    ‚ùå Zako≈Ñcz import
                </button>
                <button class="btn" style="background: #718096; color: white;" onclick="closeProgressDialog()">
                    ‚úÖ Zamknij okno
                </button>
            </div>
        </div>
    </div>

    <!-- Save Preset Dialog -->
    <div class="modal" id="save-preset-modal">
        <div class="modal-content">
            <h2>üíæ Zapisz Wyb√≥r Lig</h2>
            <p style="color: #666; margin-bottom: 20px;">Zapisz bie≈ºƒÖcy wyb√≥r jako szablon dla szybkiego dostƒôpu</p>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nazwa Szablonu *</label>
                <input type="text" id="preset-name" placeholder="np. Top 5 Lig"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Opis (opcjonalnie)</label>
                <input type="text" id="preset-description" placeholder="np. Premier League, La Liga, Bundesliga..."
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" style="background: #10b981; color: white;" onclick="savePreset()">
                    ‚úÖ Zapisz
                </button>
                <button class="btn" style="background: #718096; color: white;" onclick="closeSavePresetDialog()">
                    Anuluj
                </button>
            </div>
        </div>
    </div>

    <!-- Load Preset Dialog -->
    <div class="modal" id="load-preset-modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>üìÇ Wczytaj Wyb√≥r Lig</h2>
            <p style="color: #666; margin-bottom: 20px;">Wybierz zapisany szablon do zastosowania</p>

            <div id="presets-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Presets will be loaded here -->
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn" style="background: #718096; color: white;" onclick="closeLoadPresetDialog()">
                    Zamknij
                </button>
            </div>
        </div>
    </div>

    <!-- Background Import Dialog -->
    <div class="modal" id="background-import-modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>ü§ñ Nowe Zadanie Importu w Tle</h2>
            <p style="color: #666; margin-bottom: 20px;">Skonfiguruj automatyczny import danych</p>

            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px;">
                        Wybierz Ligi:
                    </label>
                    <div
                        style="background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 200px; overflow-y: auto;">
                        <div id="background-leagues-list">
                            <!-- Leagues will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="date-inputs">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                            Data od:
                        </label>
                        <input type="date" id="background-date-from" class="btn" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                            Data do:
                        </label>
                        <input type="date" id="background-date-to" class="btn" style="width: 100%;">
                    </div>
                </div>

                <div
                    style="background: #e3f2fd; border-left: 4px solid #1976d2; padding: 12px; border-radius: 4px; margin-top: 15px;">
                    <p style="margin: 0; font-size: 13px; color: #1565c0;">
                        ‚ÑπÔ∏è <strong>Informacja:</strong> Zadanie bƒôdzie wykonywane w tle. Po zako≈Ñczeniu otrzymasz
                        powiadomienie email na adres <strong>norf.cobain@gmail.com</strong>
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn" style="background: #10b981; color: white;" onclick="createBackgroundJob()">
                    ‚ñ∂Ô∏è Uruchom Import
                </button>
                <button class="btn" style="background: #718096; color: white;" onclick="closeBackgroundImportDialog()">
                    Anuluj
                </button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .quick-dates {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .quick-date-btn {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .quick-date-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .date-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .date-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .import-info {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .import-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #4a5568;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>

    <script>
        let selectedCountry = null;
        let configuredLeagues = new Set();
        let leagues = []; // Global leagues array for presets

        // Load initial data
        async function init() {
            await loadCountries();
            await loadConfiguredLeagues();
            await updateSummary();
            await updateRateLimit();
            await checkIncompleteImport();

            // Update rate limit every 30 seconds
            setInterval(updateRateLimit, 30000);
        }

        // Update rate limit display
        async function updateRateLimit() {
            try {
                const response = await fetch('/api/rate-limit');
                const data = await response.json();

                // Update main numbers
                document.getElementById('daily-remaining').textContent = data.dailyRemaining;
                document.getElementById('hourly-remaining').textContent = data.hourlyRemaining;

                // Update usage details
                document.getElementById('daily-used').textContent = data.dailyRequests;
                document.getElementById('daily-limit').textContent = data.dailyLimit;
                document.getElementById('hourly-used').textContent = data.hourlyRequests;
                document.getElementById('hourly-limit').textContent = data.hourlyLimit;

                // Update reset timer
                const minutes = data.nextHourlyReset.minutes;
                document.getElementById('next-reset').textContent = `${minutes}m`;

                // Change colors based on remaining tokens
                const dailyElem = document.getElementById('daily-remaining');
                const hourlyElem = document.getElementById('hourly-remaining');

                // Reset to white first
                dailyElem.style.color = 'white';
                hourlyElem.style.color = 'white';

                // Daily warnings
                if (data.dailyRemaining < 100) {
                    dailyElem.style.color = '#fbbf24'; // Yellow warning
                }
                if (data.dailyRemaining < 50) {
                    dailyElem.style.color = '#ef4444'; // Red alert
                }

                // Hourly warnings
                if (data.hourlyRemaining < 10) {
                    hourlyElem.style.color = '#fbbf24'; // Yellow warning
                }
                if (data.hourlyRemaining === 0) {
                    hourlyElem.style.color = '#ef4444'; // Red alert
                }
            } catch (error) {
                console.error('Error updating rate limit:', error);
            }
        }

        // Check for incomplete import
        async function checkIncompleteImport() {
            try {
                const response = await fetch('/api/import/status');
                const data = await response.json();

                if (data.hasIncomplete) {
                    const resumeBtn = document.getElementById('resume-btn');
                    resumeBtn.style.display = 'block';

                    showToast(`Znaleziono wstrzymany import (${data.progress}% uko≈Ñczone). Kliknij "Wzn√≥w Import" aby kontynuowaƒá.`, 'success');
                }
            } catch (error) {
                console.error('Error checking import status:', error);
            }
        }

        // Load countries
        async function loadCountries() {
            try {
                const response = await fetch('/api/countries');
                const countries = await response.json();

                const html = countries.map(country => `
          <div class="country-item" onclick="selectCountry('${country.name}')">
            <span class="country-name">${country.flag} ${country.name}</span>
            <span class="country-badge" id="badge-${country.name}">0</span>
          </div>
        `).join('');

                document.getElementById('countries-list').innerHTML = html;
            } catch (error) {
                showToast('B≈ÇƒÖd podczas ≈Çadowania kraj√≥w', 'error');
            }
        }

        // Select country
        async function selectCountry(country) {
            selectedCountry = country;

            // Update UI
            document.querySelectorAll('.country-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.country-item').classList.add('active');

            // Load leagues
            await loadLeagues(country);
        }

        // Load leagues for country
        async function loadLeagues(country) {
            const container = document.getElementById('leagues-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading leagues...</div>';

            try {
                const response = await fetch(`/api/countries/${encodeURIComponent(country)}/leagues`);
                leagues = await response.json(); // Update global leagues array

                // Add enabled property based on configuredLeagues
                leagues.forEach(league => {
                    league.enabled = configuredLeagues.has(league.id);
                });

                if (leagues.length === 0) {
                    container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üòï</div>
              <p>No leagues found for ${country}</p>
            </div>
          `;
                    return;
                }

                const html = leagues.map(league => `
          <div class="league-item ${configuredLeagues.has(league.id) ? 'selected' : ''}" id="league-${league.id}">
            <input 
              type="checkbox" 
              class="league-checkbox" 
              ${configuredLeagues.has(league.id) ? 'checked' : ''}
              onchange="toggleLeague(${league.id}, '${league.name}', '${country}', '${league.type}', this.checked)"
            >
            <img src="${league.logo}" alt="${league.name}" class="league-logo" onerror="this.style.display='none'">
            <div class="league-info">
              <div class="league-name">${league.name}</div>
              <div class="league-type">${league.type}</div>
            </div>
          </div>
        `).join('');

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <p>Error loading leagues</p>
          </div>
        `;
            }
        }

        // Toggle league
        async function toggleLeague(id, name, country, type, enabled) {
            try {
                if (enabled) {
                    // Add league
                    await fetch('/api/leagues', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id,
                            name,
                            country,
                            type,
                            priority: 3,
                            enabled: true
                        })
                    });
                    configuredLeagues.add(id);

                    // Update global leagues array
                    const league = leagues.find(l => l.id === id);
                    if (league) {
                        league.enabled = true;
                    }

                    document.getElementById(`league-${id}`).classList.add('selected');
                    showToast(`Dodano: ${name}`, 'success');
                } else {
                    // Remove league
                    await fetch(`/api/leagues/${id}`, { method: 'DELETE' });
                    configuredLeagues.delete(id);

                    // Update global leagues array
                    const league = leagues.find(l => l.id === id);
                    if (league) {
                        league.enabled = false;
                    }

                    document.getElementById(`league-${id}`).classList.remove('selected');
                    showToast(`Usuniƒôto: ${name}`, 'success');
                }

                await updateSummary();
                await updateCountryBadges();
            } catch (error) {
                showToast('B≈ÇƒÖd podczas aktualizacji ligi', 'error');
            }
        }

        // Load configured leagues
        async function loadConfiguredLeagues() {
            try {
                const response = await fetch('/api/leagues/configured');
                const leagues = await response.json();
                configuredLeagues = new Set(leagues.map(l => l.id));
            } catch (error) {
                showToast('B≈ÇƒÖd podczas ≈Çadowania skonfigurowanych lig', 'error');
            }
        }

        // Update summary
        async function updateSummary() {
            try {
                const response = await fetch('/api/leagues/summary');
                const summary = await response.json();

                document.getElementById('total-leagues').textContent = summary.total;
                document.getElementById('enabled-leagues').textContent = summary.enabled;
                document.getElementById('disabled-leagues').textContent = summary.disabled;
            } catch (error) {
                console.error('Error updating summary', error);
            }
        }

        // Update country badges
        async function updateCountryBadges() {
            try {
                const response = await fetch('/api/leagues/configured');
                const leagues = await response.json();

                const counts = leagues.reduce((acc, league) => {
                    acc[league.country] = (acc[league.country] || 0) + 1;
                    return acc;
                }, {});

                Object.keys(counts).forEach(country => {
                    const badge = document.getElementById(`badge-${country}`);
                    if (badge) {
                        badge.textContent = counts[country];
                    }
                });
            } catch (error) {
                console.error('Error updating badges', error);
            }
        }

        // Auto-select recommended leagues
        async function autoSelect() {
            if (!confirm('Auto-wyb√≥r rekomendowanych lig? U≈ºyje to zapyta≈Ñ API.')) {
                return;
            }

            try {
                showToast('Auto-wybieranie lig...', 'success');
                const response = await fetch('/api/leagues/auto-select', { method: 'POST' });
                const data = await response.json();

                await loadConfiguredLeagues();
                await updateSummary();
                await updateCountryBadges();

                if (selectedCountry) {
                    await loadLeagues(selectedCountry);
                }

                showToast(`Auto-wybrano ${data.leagues.length} lig`, 'success');
            } catch (error) {
                showToast('B≈ÇƒÖd podczas auto-wybierania lig', 'error');
            }
        }

        // Clear all
        async function clearAll() {
            if (!confirm('UsunƒÖƒá wszystkie skonfigurowane ligi?')) {
                return;
            }

            try {
                const response = await fetch('/api/leagues/configured');
                const leagues = await response.json();

                for (const league of leagues) {
                    await fetch(`/api/leagues/${league.id}`, { method: 'DELETE' });
                }

                configuredLeagues.clear();
                await updateSummary();
                await updateCountryBadges();

                if (selectedCountry) {
                    await loadLeagues(selectedCountry);
                }

                showToast('Wszystkie ligi wyczyszczone', 'success');
            } catch (error) {
                showToast('B≈ÇƒÖd podczas czyszczenia lig', 'error');
            }
        }

        // Save and close
        function saveAndClose() {
            showToast('Konfiguracja zapisana!', 'success');
            setTimeout(() => {
                alert('Konfiguracja zapisana! Mo≈ºesz zamknƒÖƒá to okno i uruchomiƒá: npm run import');
            }, 1000);
        }

        // Show import dialog
        async function showImportDialog() {
            const enabled = await fetch('/api/leagues/summary').then(r => r.json());

            if (enabled.enabled === 0) {
                showToast('Proszƒô najpierw wybraƒá przynajmniej jednƒÖ ligƒô', 'error');
                return;
            }

            document.getElementById('league-count').textContent = enabled.enabled;

            // Set default dates (last 2 weeks)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 14);

            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];

            document.getElementById('import-modal').classList.add('show');
        }

        // Close import dialog
        function closeImportDialog() {
            document.getElementById('import-modal').classList.remove('show');
        }

        // Set quick date ranges
        function setQuickDate(range) {
            const endDate = new Date();
            const startDate = new Date();

            switch (range) {
                case 'week':
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case '2weeks':
                    startDate.setDate(startDate.getDate() - 14);
                    break;
                case 'month':
                    startDate.setDate(startDate.getDate() - 30);
                    break;
                case '3months':
                    startDate.setMonth(startDate.getMonth() - 3);
                    break;
            }

            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
        }

        // Start import
        async function startImport() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                showToast('Proszƒô wybraƒá datƒô poczƒÖtkowƒÖ i ko≈ÑcowƒÖ', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('Data poczƒÖtkowa musi byƒá przed datƒÖ ko≈ÑcowƒÖ', 'error');
                return;
            }

            await executeImport({ startDate, endDate, resume: false });
        }

        // Resume import
        async function resumeImport() {
            if (!confirm('Wznowiƒá wstrzymany import?')) {
                return;
            }

            await executeImport({ resume: true });
        }

        // Execute import (common function)
        async function executeImport(params) {
            // Close import dialog if open, show progress
            closeImportDialog();
            document.getElementById('progress-modal').classList.add('show');
            document.getElementById('progress-text').textContent = params.resume ? 'Wznawianie importu...' : 'Rozpoczynam import z automatycznym ponowieniem...';
            document.getElementById('progress-fill').style.width = '10%';

            try {
                // Add autoRetry flag
                params.autoRetry = true;

                // Start/resume import
                const response = await fetch('/api/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('progress-fill').style.width = '30%';
                    document.getElementById('progress-text').textContent = 'Import w toku z automatycznym ponowieniem...';

                    showToast('Import rozpoczƒôty! Bƒôdzie kontynuowany w tle z automatycznym ponowieniem.', 'success');

                    // Poll for completion
                    let checkCount = 0;
                    const checkInterval = setInterval(async () => {
                        checkCount++;

                        try {
                            const statusResp = await fetch('/api/import/status');
                            const status = await statusResp.json();

                            if (!status.hasIncomplete || checkCount > 1000) { // Check for long time
                                clearInterval(checkInterval);

                                if (!status.hasIncomplete) {
                                    document.getElementById('progress-fill').style.width = '100%';
                                    document.getElementById('progress-text').textContent = 'Import zako≈Ñczony pomy≈õlnie!';

                                    setTimeout(() => {
                                        document.getElementById('progress-modal').classList.remove('show');
                                        document.getElementById('resume-btn').style.display = 'none';
                                        showToast('Wszystkie mecze zaimportowane pomy≈õlnie!', 'success');
                                    }, 2000);
                                }
                            } else {
                                // Update progress
                                const progress = status.progress || 30;
                                document.getElementById('progress-fill').style.width = `${progress}%`;

                                let statusText = `Importing... ${progress}% (${status.state.matchesImported} matches)`;
                                if (status.state.error?.includes('waiting')) {
                                    statusText = `‚è∞ Waiting for rate limit... (${status.state.matchesImported} matches imported)`;
                                }

                                document.getElementById('progress-text').textContent = statusText;
                            }
                        } catch (error) {
                            // Continue checking even if there's an error
                        }
                    }, 10000); // Check every 10 seconds
                } else {
                    throw new Error('Import failed');
                }
            } catch (error) {
                document.getElementById('progress-modal').classList.remove('show');
                showToast('B≈ÇƒÖd importu. Sprawd≈∫ konsolƒô serwera aby zobaczyƒá szczeg√≥≈Çy.', 'error');
                await checkIncompleteImport();
            }
        }

        // Close progress dialog
        function closeProgressDialog() {
            document.getElementById('progress-modal').classList.remove('show');
            showToast('Import kontynuowany w tle z automatycznym ponowieniem', 'success');
        }

        // Stop import (pause)
        async function stopImport() {
            if (!confirm('Zatrzymaƒá import? Mo≈ºesz go wznowiƒá p√≥≈∫niej.')) {
                return;
            }

            try {
                const response = await fetch('/api/import/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Import zostanie zatrzymany po aktualnej lidze', 'info');
                    document.getElementById('progress-modal').classList.remove('show');
                }
            } catch (error) {
                showToast('B≈ÇƒÖd podczas zatrzymywania importu', 'error');
            }
        }

        // Cancel import (clear state)
        async function cancelImport() {
            if (!confirm('Zako≈Ñczyƒá import i wyczy≈õciƒá stan? Nie bƒôdzie mo≈ºna wznowiƒá.')) {
                return;
            }

            try {
                const response = await fetch('/api/import/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Import zosta≈Ç zako≈Ñczony', 'success');
                    document.getElementById('progress-modal').classList.remove('show');
                    await checkIncompleteImport();
                }
            } catch (error) {
                showToast('B≈ÇƒÖd podczas ko≈Ñczenia importu', 'error');
            }
        }

        // ===== PRESETS =====

        // Show save preset dialog
        function showSavePresetDialog() {
            const enabled = leagues.filter(l => l.enabled);
            if (enabled.length === 0) {
                showToast('Proszƒô najpierw wybraƒá przynajmniej jednƒÖ ligƒô', 'error');
                return;
            }
            document.getElementById('save-preset-modal').classList.add('show');
            document.getElementById('preset-name').value = '';
            document.getElementById('preset-description').value = '';
        }

        // Close save preset dialog
        function closeSavePresetDialog() {
            document.getElementById('save-preset-modal').classList.remove('show');
        }

        // Save preset
        async function savePreset() {
            const name = document.getElementById('preset-name').value.trim();
            const description = document.getElementById('preset-description').value.trim();

            if (!name) {
                showToast('Proszƒô podaƒá nazwƒô szablonu', 'error');
                return;
            }

            const enabled = leagues.filter(l => l.enabled);
            const leagueIds = enabled.map(l => l.id);

            try {
                const response = await fetch('/api/presets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, leagueIds })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`Szablon "${name}" zapisany pomy≈õlnie!`, 'success');
                    closeSavePresetDialog();
                } else {
                    showToast('Nie uda≈Ço siƒô zapisaƒá szablonu', 'error');
                }
            } catch (error) {
                showToast('B≈ÇƒÖd podczas zapisywania szablonu', 'error');
            }
        }

        // Show load preset dialog
        async function showLoadPresetDialog() {
            try {
                const response = await fetch('/api/presets');
                const presets = await response.json();

                const list = document.getElementById('presets-list');

                if (presets.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No saved presets. Create one first!</p>';
                } else {
                    list.innerHTML = presets.map(preset => `
                        <div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 5px 0; font-size: 16px; color: #2d3748;">${preset.name}</h3>
                                    <p style="margin: 0 0 5px 0; color: #718096; font-size: 13px;">${preset.description || 'No description'}</p>
                                    <p style="margin: 0; color: #a0aec0; font-size: 12px;">${preset.leagueIds.length} leagues ‚Ä¢ ${new Date(preset.createdAt).toLocaleDateString()}</p>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn load-preset-btn" data-preset-name="${preset.name}" style="background: #3b82f6; color: white; padding: 8px 16px; font-size: 13px;">
                                        üìÇ Load
                                    </button>
                                    <button class="btn delete-preset-btn" data-preset-name="${preset.name}" style="background: #ef4444; color: white; padding: 8px 16px; font-size: 13px;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // Add event listeners after HTML is set
                    setTimeout(() => {
                        document.querySelectorAll('.load-preset-btn').forEach(btn => {
                            btn.addEventListener('click', function () {
                                const name = this.getAttribute('data-preset-name');
                                loadPreset(name);
                            });
                        });

                        document.querySelectorAll('.delete-preset-btn').forEach(btn => {
                            btn.addEventListener('click', function () {
                                const name = this.getAttribute('data-preset-name');
                                deletePreset(name);
                            });
                        });
                    }, 0);
                }

                document.getElementById('load-preset-modal').classList.add('show');
            } catch (error) {
                showToast('B≈ÇƒÖd podczas ≈Çadowania szablon√≥w', 'error');
            }
        }

        // Close load preset dialog
        function closeLoadPresetDialog() {
            document.getElementById('load-preset-modal').classList.remove('show');
        }

        // Load a preset
        async function loadPreset(name) {
            console.log('üîÑ Loading preset:', name);

            try {
                const response = await fetch(`/api/presets/${encodeURIComponent(name)}/load`, {
                    method: 'POST'
                });

                console.log('üì• Response status:', response.status);

                const data = await response.json();

                console.log('üì¶ Response data:', data);

                if (data.success) {
                    showToast(`Szablon "${name}" wczytany! (${data.stats.enabled} w≈ÇƒÖczonych, ${data.stats.added} dodanych)`, 'success');
                    closeLoadPresetDialog();

                    // Reload configured leagues and update UI
                    await loadConfiguredLeagues();
                    await updateSummary();
                    await updateCountryBadges();

                    // If a country is selected, reload its leagues
                    if (selectedCountry) {
                        await loadLeagues(selectedCountry);
                    }
                } else {
                    showToast('Nie uda≈Ço siƒô wczytaƒá szablonu', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error loading preset:', error);
                showToast('B≈ÇƒÖd podczas ≈Çadowania szablonu', 'error');
            }
        }

        // Delete a preset
        async function deletePreset(name) {
            if (!confirm(`UsunƒÖƒá szablon "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/presets/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`Szablon "${name}" usuniƒôty`, 'success');
                    showLoadPresetDialog(); // Refresh list
                } else {
                    showToast('Nie uda≈Ço siƒô usunƒÖƒá szablonu', 'error');
                }
            } catch (error) {
                showToast('B≈ÇƒÖd podczas usuwania szablonu', 'error');
            }
        }

        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const messageEl = document.getElementById('toast-message');

            messageEl.textContent = message;
            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // =====================================
        // TAB SWITCHING
        // =====================================

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Activate selected button
            event.target.classList.add('active');

            // Load data if database tab
            if (tabName === 'database') {
                loadDatabaseFilters();
            }

            // Initialize bet finder tab
            if (tabName === 'bet-finder') {
                initBetFinder();
            }
        }

        // =====================================
        // DATABASE FILTERS
        // =====================================

        let databaseCountries = [];
        let databaseLeagues = [];
        let databaseTeams = [];
        let selectedLimit = null; // null = all, number = limit
        let lastFetchedMatches = []; // Store all fetched matches
        let selectedTeamForColoring = null; // Store selected team for coloring
        let homeAwayFilter = 'all'; // 'all', 'home', 'away'

        function setLimit(limit) {
            selectedLimit = limit;

            // Update active button
            document.querySelectorAll('.limit-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function setLimitAndFilter(limit) {
            selectedLimit = limit;

            // Update active button
            document.querySelectorAll('.limit-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // If we have matches, re-filter them with new limit
            if (lastFetchedMatches.length > 0) {
                applyLimitToResults();
            }
        }

        function setHomeAwayFilter(filter) {
            homeAwayFilter = filter;

            // Re-apply filters with new home/away setting
            if (lastFetchedMatches.length > 0) {
                applyLimitToResults();
            }
        }

        function applyLimitToResults() {
            let matches = [...lastFetchedMatches];

            // Apply home/away filter if team is selected
            if (selectedTeamForColoring && homeAwayFilter !== 'all') {
                matches = matches.filter(match => {
                    if (homeAwayFilter === 'home') {
                        return match.home_team === selectedTeamForColoring;
                    } else if (homeAwayFilter === 'away') {
                        return match.away_team === selectedTeamForColoring;
                    }
                    return true;
                });
            }

            // Split matches into upcoming and finished
            const upcomingMatches = matches.filter(m => m.is_finished === 'no');
            const finishedMatches = matches.filter(m => m.is_finished === 'yes');

            // Apply limit ONLY to finished matches
            let limitedFinishedMatches = finishedMatches;
            if (selectedLimit) {
                // Sort by date descending (most recent first) and take limit
                limitedFinishedMatches = finishedMatches
                    .sort((a, b) => new Date(b.match_date) - new Date(a.match_date))
                    .slice(0, selectedLimit);
            } else {
                // If no limit, still sort finished matches
                limitedFinishedMatches = finishedMatches
                    .sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
            }

            // Combine: all upcoming matches + limited finished matches
            const finalMatches = [...upcomingMatches, ...limitedFinishedMatches];

            // Recalculate team statistics for filtered matches if team is selected
            if (selectedTeamForColoring) {
                const availableLeagues = [...new Set(finalMatches.map(m => m.league))];
                const currentLeagueFilter = document.getElementById('stats-league-filter')?.value || 'all';
                const stats = calculateTeamStatistics(selectedTeamForColoring, finalMatches, currentLeagueFilter);
                displayTeamStatistics(stats, availableLeagues);
                // Restore league filter selection
                if (document.getElementById('stats-league-filter')) {
                    document.getElementById('stats-league-filter').value = currentLeagueFilter;
                }
            }

            // Display results
            displayDatabaseResults(finalMatches, selectedTeamForColoring);

            const limitText = selectedLimit ? ` (limit zako≈Ñczonych: ${selectedLimit})` : '';
            const homeAwayText = homeAwayFilter === 'home' ? ' (domowe)' : homeAwayFilter === 'away' ? ' (wyjazdowe)' : '';
            showToast(`Wy≈õwietlono ${finalMatches.length} mecz√≥w (${upcomingMatches.length} nadchodzƒÖcych, ${limitedFinishedMatches.length} zako≈Ñczonych)${limitText}${homeAwayText}`, 'success');
        }

        // Debounce timers for search inputs
        let searchDebounceTimers = {};

        function filterSelectOptions(selectId, searchInputId) {
            // Clear existing timer for this search input
            if (searchDebounceTimers[searchInputId]) {
                clearTimeout(searchDebounceTimers[searchInputId]);
            }

            // Set new timer - execute after 500ms of no typing
            searchDebounceTimers[searchInputId] = setTimeout(() => {
                const searchInput = document.getElementById(searchInputId);
                const select = document.getElementById(selectId);
                const searchTerm = searchInput.value.toLowerCase();

                // Get all options except the first one (default "Wszystkie...")
                const options = Array.from(select.options);

                options.forEach((option, index) => {
                    if (index === 0) {
                        // Always show the default option
                        option.style.display = '';
                        return;
                    }

                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }, 500); // 500ms = 0.5 seconds
        }

        async function loadDatabaseFilters() {
            try {
                // Load all countries
                const countriesResponse = await fetch('/api/database/countries');
                if (!countriesResponse.ok) throw new Error('Failed to load countries');
                databaseCountries = await countriesResponse.json();

                // Load all leagues
                const leaguesResponse = await fetch('/api/database/leagues');
                if (!leaguesResponse.ok) throw new Error('Failed to load leagues');
                databaseLeagues = await leaguesResponse.json();

                // Load all teams
                const teamsResponse = await fetch('/api/database/teams');
                if (!teamsResponse.ok) throw new Error('Failed to load teams');
                databaseTeams = await teamsResponse.json();

                // Populate country dropdown
                const countrySelect = document.getElementById('filter-country');
                countrySelect.innerHTML = '<option value="">Wszystkie Kraje</option>';
                databaseCountries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    countrySelect.appendChild(option);
                });

                // Populate league dropdown
                const leagueSelect = document.getElementById('filter-league');
                leagueSelect.innerHTML = '<option value="">Wszystkie Ligi</option>';
                databaseLeagues.forEach(league => {
                    const option = document.createElement('option');
                    option.value = league;
                    option.textContent = league;
                    leagueSelect.appendChild(option);
                });

                // Populate team dropdown
                const teamSelect = document.getElementById('filter-team');
                teamSelect.innerHTML = '<option value="">Wszystkie Dru≈ºyny</option>';
                databaseTeams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamSelect.appendChild(option);
                });

                console.log('‚úÖ Loaded filters:', databaseCountries.length, 'countries,', databaseLeagues.length, 'leagues,', databaseTeams.length, 'teams');
            } catch (error) {
                console.error('Error loading database filters:', error);
                showToast('Nie uda≈Ço siƒô za≈Çadowaƒá filtr√≥w: ' + error.message, 'error');
            }
        }

        async function onCountryFilterChange() {
            const country = document.getElementById('filter-country').value;

            // Reset league and team when country changes
            document.getElementById('filter-league').value = '';
            document.getElementById('filter-team').value = '';

            if (!country) {
                // Restore all leagues and teams
                await loadDatabaseFilters();
                return;
            }

            try {
                // Load leagues for selected country
                const leaguesResponse = await fetch(`/api/database/leagues?country=${encodeURIComponent(country)}`);
                if (!leaguesResponse.ok) throw new Error('Failed to load leagues');
                const leagues = await leaguesResponse.json();

                // Populate league dropdown
                const leagueSelect = document.getElementById('filter-league');
                leagueSelect.innerHTML = '<option value="">Wszystkie Ligi</option>';
                leagues.forEach(league => {
                    const option = document.createElement('option');
                    option.value = league;
                    option.textContent = league;
                    leagueSelect.appendChild(option);
                });

                // Load teams for selected country
                const teamsResponse = await fetch(`/api/database/teams?country=${encodeURIComponent(country)}`);
                if (!teamsResponse.ok) throw new Error('Failed to load teams');
                const teams = await teamsResponse.json();

                // Populate team dropdown
                const teamSelect = document.getElementById('filter-team');
                teamSelect.innerHTML = '<option value="">Wszystkie Dru≈ºyny</option>';
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamSelect.appendChild(option);
                });

                console.log('‚úÖ Loaded', leagues.length, 'leagues and', teams.length, 'teams for', country);
            } catch (error) {
                console.error('Error loading leagues/teams:', error);
                showToast('Nie uda≈Ço siƒô za≈Çadowaƒá lig/dru≈ºyn: ' + error.message, 'error');
            }
        }

        async function onLeagueFilterChange() {
            const country = document.getElementById('filter-country').value;
            const league = document.getElementById('filter-league').value;

            // Reset team when league changes
            document.getElementById('filter-team').value = '';

            if (!league) {
                // If no league selected, reload teams based on country only
                if (country) {
                    await onCountryFilterChange();
                } else {
                    await loadDatabaseFilters();
                }
                return;
            }

            try {
                // Load teams for selected league (and optionally country)
                const params = new URLSearchParams();
                if (country) params.append('country', country);
                if (league) params.append('league', league);

                const response = await fetch(`/api/database/teams?${params}`);
                if (!response.ok) throw new Error('Failed to load teams');

                const teams = await response.json();

                // Populate team dropdown
                const teamSelect = document.getElementById('filter-team');
                teamSelect.innerHTML = '<option value="">Wszystkie Dru≈ºyny</option>';
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamSelect.appendChild(option);
                });

                console.log('‚úÖ Loaded', teams.length, 'teams for', league);
            } catch (error) {
                console.error('Error loading teams:', error);
                showToast('Nie uda≈Ço siƒô za≈Çadowaƒá dru≈ºyn: ' + error.message, 'error');
            }
        }

        function onTeamFilterChange() {
            // Team selected - ready to search
            console.log('Team filter changed:', document.getElementById('filter-team').value);
        }

        // Helper function to find mode (most frequent value) in array
        function findMode(arr) {
            if (arr.length === 0) return { value: 'N/A', count: 0 };

            const frequency = {};
            let maxFreq = 0;
            let mode = arr[0];

            arr.forEach(val => {
                frequency[val] = (frequency[val] || 0) + 1;
                if (frequency[val] > maxFreq) {
                    maxFreq = frequency[val];
                    mode = val;
                }
            });

            return { value: mode, count: maxFreq };
        }

        function calculateTeamStatistics(teamName, matches, leagueFilter = null) {
            // Filter only finished matches
            let teamMatches = matches.filter(m => m.is_finished === 'yes');

            // Apply league filter if specified
            if (leagueFilter && leagueFilter !== 'all') {
                teamMatches = teamMatches.filter(m => m.league === leagueFilter);
            }

            const totalMatches = teamMatches.length;
            if (totalMatches === 0) {
                return null;
            }

            let points = 0, homePoints = 0, awayPoints = 0;
            let homeMatches = 0, awayMatches = 0;
            let wins = 0, draws = 0, losses = 0;
            let goalsScored = 0, goalsConceded = 0;
            let goalsScored1H = 0, goalsScored2H = 0;
            let goalsConceded1H = 0, goalsConceded2H = 0;
            let firstHalfWins = 0, secondHalfWins = 0, bothHalvesWins = 0;
            let comebackWins = 0, comebackLosses = 0;
            let firstHalfAndFullWins = 0; // Wygrana 1H i ca≈Çy mecz

            // Over/Under stats
            let bothTeamsScored = 0; // BTS - obie dru≈ºyny strzeli≈Çy
            let noGoalsScored = 0; // 0 goli strzelonych
            let atLeast1GoalScored = 0; // ‚â•1 gol strzelony
            let atLeast2GoalsScored = 0; // ‚â•2 gole strzelone
            let cleanSheet = 0; // Czyste konto (0 straconych)
            let atLeast1GoalConceded = 0; // ‚â•1 gol stracony
            let atLeast2GoalsConceded = 0; // ‚â•2 gole stracone

            // Advanced stats with availability tracking
            let cornersFor = 0, cornersAgainst = 0, cornersCount = 0;
            let offsidesFor = 0, offsidesAgainst = 0, offsidesCount = 0;
            let shotsFor = 0, shotsAgainst = 0, shotsCount = 0;
            let shotsOnTargetFor = 0, shotsOnTargetAgainst = 0, shotsOnTargetCount = 0;
            let xgFor = 0, xgAgainst = 0, xgCount = 0;
            let possessionSum = 0, possessionCount = 0;

            // Arrays for mode (most frequent) calculations
            let cornersForArray = [];
            let cornersAgainstArray = [];

            // Detailed match data for modal
            let matchDetails = [];

            teamMatches.forEach(match => {
                const isHome = match.home_team === teamName;
                const homeGoals = match.home_goals || 0;
                const awayGoals = match.away_goals || 0;
                const homeGoalsHT = match.home_goals_ht || 0;
                const awayGoalsHT = match.away_goals_ht || 0;

                // Match result
                const matchPoints = isHome
                    ? (homeGoals > awayGoals ? 3 : homeGoals === awayGoals ? 1 : 0)
                    : (awayGoals > homeGoals ? 3 : homeGoals === awayGoals ? 1 : 0);

                points += matchPoints;

                if (isHome) {
                    homeMatches++;
                    homePoints += matchPoints;
                    goalsScored += homeGoals;
                    goalsConceded += awayGoals;
                    goalsScored1H += homeGoalsHT;
                    goalsConceded1H += awayGoalsHT;
                    goalsScored2H += (homeGoals - homeGoalsHT);
                    goalsConceded2H += (awayGoals - awayGoalsHT);

                    // Advanced stats - home
                    if (match.home_corners != null && match.away_corners != null) {
                        cornersFor += match.home_corners;
                        cornersAgainst += match.away_corners;
                        cornersForArray.push(match.home_corners);
                        cornersAgainstArray.push(match.away_corners);
                        cornersCount++;
                    }
                    if (match.home_possession != null) {
                        possessionSum += match.home_possession;
                        possessionCount++;
                    }
                    if (match.home_offsides != null && match.away_offsides != null) {
                        offsidesFor += match.home_offsides;
                        offsidesAgainst += match.away_offsides;
                        offsidesCount++;
                    }
                    if (match.home_shots != null && match.away_shots != null) {
                        shotsFor += match.home_shots;
                        shotsAgainst += match.away_shots;
                        shotsCount++;
                    }
                    if (match.home_shots_on_target != null && match.away_shots_on_target != null) {
                        shotsOnTargetFor += match.home_shots_on_target;
                        shotsOnTargetAgainst += match.away_shots_on_target;
                        shotsOnTargetCount++;
                    }
                    if (match.home_xg != null && match.away_xg != null) {
                        xgFor += parseFloat(match.home_xg);
                        xgAgainst += parseFloat(match.away_xg);
                        xgCount++;
                    }
                } else {
                    awayMatches++;
                    awayPoints += matchPoints;
                    goalsScored += awayGoals;
                    goalsConceded += homeGoals;
                    goalsScored1H += awayGoalsHT;
                    goalsConceded1H += homeGoalsHT;
                    goalsScored2H += (awayGoals - awayGoalsHT);
                    goalsConceded2H += (homeGoals - homeGoalsHT);

                    // Advanced stats - away
                    if (match.home_corners != null && match.away_corners != null) {
                        cornersFor += match.away_corners;
                        cornersAgainst += match.home_corners;
                        cornersForArray.push(match.away_corners);
                        cornersAgainstArray.push(match.home_corners);
                        cornersCount++;
                    }
                    if (match.away_possession != null) {
                        possessionSum += match.away_possession;
                        possessionCount++;
                    }
                    if (match.home_offsides != null && match.away_offsides != null) {
                        offsidesFor += match.away_offsides;
                        offsidesAgainst += match.home_offsides;
                        offsidesCount++;
                    }
                    if (match.home_shots != null && match.away_shots != null) {
                        shotsFor += match.away_shots;
                        shotsAgainst += match.home_shots;
                        shotsCount++;
                    }
                    if (match.home_shots_on_target != null && match.away_shots_on_target != null) {
                        shotsOnTargetFor += match.away_shots_on_target;
                        shotsOnTargetAgainst += match.home_shots_on_target;
                        shotsOnTargetCount++;
                    }
                    if (match.home_xg != null && match.away_xg != null) {
                        xgFor += parseFloat(match.away_xg);
                        xgAgainst += parseFloat(match.home_xg);
                        xgCount++;
                    }
                }

                // Win/Draw/Loss
                if (matchPoints === 3) wins++;
                else if (matchPoints === 1) draws++;
                else losses++;

                // Half-time analysis
                const teamGoalsHT = isHome ? homeGoalsHT : awayGoalsHT;
                const oppGoalsHT = isHome ? awayGoalsHT : homeGoalsHT;
                const teamGoalsFT = isHome ? homeGoals : awayGoals;
                const oppGoalsFT = isHome ? awayGoals : homeGoals;

                // First half win
                if (teamGoalsHT > oppGoalsHT) firstHalfWins++;

                // Second half win (goals scored in 2nd half)
                const teamGoals2H = teamGoalsFT - teamGoalsHT;
                const oppGoals2H = oppGoalsFT - oppGoalsHT;
                if (teamGoals2H > oppGoals2H) secondHalfWins++;

                // Both halves wins
                if (teamGoalsHT > oppGoalsHT && teamGoals2H > oppGoals2H) bothHalvesWins++;

                // First half and full match win
                if (teamGoalsHT > oppGoalsHT && matchPoints === 3) firstHalfAndFullWins++;

                // Comebacks
                const isComebackWin = teamGoalsHT < oppGoalsHT && teamGoalsFT > oppGoalsFT;
                const isComebackLoss = teamGoalsHT > oppGoalsHT && teamGoalsFT < oppGoalsFT;
                if (isComebackWin) comebackWins++;
                if (isComebackLoss) comebackLosses++;

                // Over/Under stats
                const teamGoalsScored = isHome ? homeGoals : awayGoals;
                const oppGoalsScored = isHome ? awayGoals : homeGoals;

                // BTS - Both Teams to Score
                if (homeGoals > 0 && awayGoals > 0) bothTeamsScored++;

                // Goals scored
                if (teamGoalsScored === 0) noGoalsScored++;
                if (teamGoalsScored >= 1) atLeast1GoalScored++;
                if (teamGoalsScored >= 2) atLeast2GoalsScored++;

                // Goals conceded
                if (oppGoalsScored === 0) cleanSheet++;
                if (oppGoalsScored >= 1) atLeast1GoalConceded++;
                if (oppGoalsScored >= 2) atLeast2GoalsConceded++;

                // Store detailed match data for modal
                const matchDate = new Date(match.match_date);
                const formattedDate = `${matchDate.getDate().toString().padStart(2, '0')}.${(matchDate.getMonth() + 1).toString().padStart(2, '0')}.${matchDate.getFullYear()}`;
                const opponent = isHome ? match.away_team : match.home_team;
                const homeAway = isHome ? 'D' : 'W';
                const result = matchPoints === 3 ? 'W' : matchPoints === 1 ? 'R' : 'P';
                const resultClass = matchPoints === 3 ? 'win' : matchPoints === 1 ? 'draw' : 'loss';

                matchDetails.push({
                    date: formattedDate,
                    opponent: opponent,
                    homeAway: homeAway,
                    result: result,
                    resultClass: resultClass,
                    isHome: isHome,
                    // Goals
                    goalsScored: isHome ? homeGoals : awayGoals,
                    goalsConceded: isHome ? awayGoals : homeGoals,
                    goalsTotal: homeGoals + awayGoals,
                    goalsScored1H: isHome ? homeGoalsHT : awayGoalsHT,
                    goalsScored2H: teamGoals2H,
                    goalsTotal1H: homeGoalsHT + awayGoalsHT,
                    goalsTotal2H: teamGoals2H + oppGoals2H,
                    // Comeback flags
                    isComebackWin: isComebackWin,
                    isComebackLoss: isComebackLoss,
                    // Half-time results
                    firstHalfWin: teamGoalsHT > oppGoalsHT ? 1 : 0,
                    secondHalfWin: teamGoals2H > oppGoals2H ? 1 : 0,
                    bothHalvesWin: (teamGoalsHT > oppGoalsHT && teamGoals2H > oppGoals2H) ? 1 : 0,
                    firstHalfAndFullWin: (teamGoalsHT > oppGoalsHT && matchPoints === 3) ? 1 : 0,
                    // Over/Under flags
                    bothTeamsScored: (homeGoals > 0 && awayGoals > 0) ? 1 : 0,
                    noGoalsScored: (isHome ? homeGoals : awayGoals) === 0 ? 1 : 0,
                    atLeast1GoalScored: (isHome ? homeGoals : awayGoals) >= 1 ? 1 : 0,
                    atLeast2GoalsScored: (isHome ? homeGoals : awayGoals) >= 2 ? 1 : 0,
                    cleanSheet: (isHome ? awayGoals : homeGoals) === 0 ? 1 : 0,
                    atLeast1GoalConceded: (isHome ? awayGoals : homeGoals) >= 1 ? 1 : 0,
                    atLeast2GoalsConceded: (isHome ? awayGoals : homeGoals) >= 2 ? 1 : 0,
                    // Advanced stats
                    cornersFor: isHome ? match.home_corners : match.away_corners,
                    cornersAgainst: isHome ? match.away_corners : match.home_corners,
                    offsidesFor: isHome ? match.home_offsides : match.away_offsides,
                    offsidesAgainst: isHome ? match.away_offsides : match.home_offsides,
                    shotsFor: isHome ? match.home_shots : match.away_shots,
                    shotsAgainst: isHome ? match.away_shots : match.home_shots,
                    shotsOnTargetFor: isHome ? match.home_shots_on_target : match.away_shots_on_target,
                    shotsOnTargetAgainst: isHome ? match.away_shots_on_target : match.home_shots_on_target,
                    xgFor: isHome ? match.home_xg : match.away_xg,
                    xgAgainst: isHome ? match.away_xg : match.home_xg,
                    possession: isHome ? match.home_possession : match.away_possession,
                    // Half-time results
                    firstHalfWin: teamGoalsHT > oppGoalsHT ? 1 : 0,
                    secondHalfWin: teamGoals2H > oppGoals2H ? 1 : 0,
                    bothHalvesWin: (teamGoalsHT > oppGoalsHT && teamGoals2H > oppGoals2H) ? 1 : 0
                });
            });

            // Sort matchDetails by date descending (newest first)
            matchDetails.sort((a, b) => {
                const dateA = a.date.split('.').reverse().join('');
                const dateB = b.date.split('.').reverse().join('');
                return dateB.localeCompare(dateA);
            });

            // Calculate mode (most frequent) for corners
            const cornersForMode = findMode(cornersForArray);
            const cornersAgainstMode = findMode(cornersAgainstArray);

            // Calculate percentage of matches above mode for corners+
            const matchesAboveCornersForMode = cornersForArray.filter(c => c > cornersForMode.value).length;
            const percentAboveCornersForMode = cornersForArray.length > 0
                ? ((matchesAboveCornersForMode / cornersForArray.length) * 100).toFixed(1)
                : 'N/A';

            return {
                teamName,
                totalMatches,
                avgPoints: (points / totalMatches).toFixed(2),
                avgPointsHome: homeMatches > 0 ? (homePoints / homeMatches).toFixed(2) : '0.00',
                avgPointsAway: awayMatches > 0 ? (awayPoints / awayMatches).toFixed(2) : '0.00',
                winPercentage: ((wins / totalMatches) * 100).toFixed(1),
                lossPercentage: ((losses / totalMatches) * 100).toFixed(1),
                drawPercentage: ((draws / totalMatches) * 100).toFixed(1),
                avgGoalsScored: (goalsScored / totalMatches).toFixed(2),
                avgGoalsConceded: (goalsConceded / totalMatches).toFixed(2),
                avgGoalsTotal: ((goalsScored + goalsConceded) / totalMatches).toFixed(2),
                avgGoalsScored1H: (goalsScored1H / totalMatches).toFixed(2),
                avgGoalsScored2H: (goalsScored2H / totalMatches).toFixed(2),
                avgGoalsTotal1H: ((goalsScored1H + goalsConceded1H) / totalMatches).toFixed(2),
                avgGoalsTotal2H: ((goalsScored2H + goalsConceded2H) / totalMatches).toFixed(2),
                firstHalfWinPercentage: ((firstHalfWins / totalMatches) * 100).toFixed(1),
                secondHalfWinPercentage: ((secondHalfWins / totalMatches) * 100).toFixed(1),
                bothHalvesWinPercentage: ((bothHalvesWins / totalMatches) * 100).toFixed(1),
                firstHalfAndFullWinPercentage: ((firstHalfAndFullWins / totalMatches) * 100).toFixed(1),
                comebackWinPercentage: ((comebackWins / totalMatches) * 100).toFixed(1),
                comebackLossPercentage: ((comebackLosses / totalMatches) * 100).toFixed(1),
                // Over/Under stats
                bothTeamsScoredPercentage: ((bothTeamsScored / totalMatches) * 100).toFixed(1),
                noGoalsScoredPercentage: ((noGoalsScored / totalMatches) * 100).toFixed(1),
                atLeast1GoalScoredPercentage: ((atLeast1GoalScored / totalMatches) * 100).toFixed(1),
                atLeast2GoalsScoredPercentage: ((atLeast2GoalsScored / totalMatches) * 100).toFixed(1),
                cleanSheetPercentage: ((cleanSheet / totalMatches) * 100).toFixed(1),
                atLeast1GoalConcededPercentage: ((atLeast1GoalConceded / totalMatches) * 100).toFixed(1),
                atLeast2GoalsConcededPercentage: ((atLeast2GoalsConceded / totalMatches) * 100).toFixed(1),
                // Advanced stats
                avgCornersFor: cornersCount > 0 ? (cornersFor / cornersCount).toFixed(2) : 'N/A',
                avgCornersAgainst: cornersCount > 0 ? (cornersAgainst / cornersCount).toFixed(2) : 'N/A',
                cornersAvailable: `${cornersCount}/${totalMatches}`,
                avgOffsidesFor: offsidesCount > 0 ? (offsidesFor / offsidesCount).toFixed(2) : 'N/A',
                avgOffsidesAgainst: offsidesCount > 0 ? (offsidesAgainst / offsidesCount).toFixed(2) : 'N/A',
                offsidesAvailable: `${offsidesCount}/${totalMatches}`,
                avgShotsFor: shotsCount > 0 ? (shotsFor / shotsCount).toFixed(2) : 'N/A',
                avgShotsAgainst: shotsCount > 0 ? (shotsAgainst / shotsCount).toFixed(2) : 'N/A',
                shotsAvailable: `${shotsCount}/${totalMatches}`,
                avgShotsOnTargetFor: shotsOnTargetCount > 0 ? (shotsOnTargetFor / shotsOnTargetCount).toFixed(2) : 'N/A',
                avgShotsOnTargetAgainst: shotsOnTargetCount > 0 ? (shotsOnTargetAgainst / shotsOnTargetCount).toFixed(2) : 'N/A',
                shotsOnTargetAvailable: `${shotsOnTargetCount}/${totalMatches}`,
                avgXgFor: xgCount > 0 ? (xgFor / xgCount).toFixed(2) : 'N/A',
                avgXgAgainst: xgCount > 0 ? (xgAgainst / xgCount).toFixed(2) : 'N/A',
                xgAvailable: `${xgCount}/${totalMatches}`,
                // Possession
                avgPossession: possessionCount > 0 ? (possessionSum / possessionCount).toFixed(2) : 'N/A',
                possessionAvailable: `${possessionCount}/${totalMatches}`,
                // Corners mode (most frequent)
                mostFrequentCornersFor: cornersForMode.value !== 'N/A' ? `${cornersForMode.value} (${cornersForMode.count}x)` : 'N/A',
                mostFrequentCornersAgainst: cornersAgainstMode.value !== 'N/A' ? `${cornersAgainstMode.value} (${cornersAgainstMode.count}x)` : 'N/A',
                percentAboveCornersForMode: percentAboveCornersForMode,
                // Detailed match data for modal
                matchDetails: matchDetails,
                cornersForMode: cornersForMode,
                cornersAgainstMode: cornersAgainstMode
            };
        }

        // Prepare modal data for specific stat type
        function prepareModalData(stats, statType) {
            if (!stats || !stats.matchDetails) return [];

            return stats.matchDetails.map(match => {
                let value, displayValue;

                switch (statType) {
                    case 'goalsScored':
                        value = match.goalsScored;
                        displayValue = value.toString();
                        break;
                    case 'goalsConceded':
                        value = match.goalsConceded;
                        displayValue = value.toString();
                        break;
                    case 'goalsTotal':
                        value = match.goalsTotal;
                        displayValue = value.toString();
                        break;
                    case 'goalsScored1H':
                        value = match.goalsScored1H;
                        displayValue = value.toString();
                        break;
                    case 'goalsScored2H':
                        value = match.goalsScored2H;
                        displayValue = value.toString();
                        break;
                    case 'goalsTotal1H':
                        value = match.goalsTotal1H;
                        displayValue = value.toString();
                        break;
                    case 'goalsTotal2H':
                        value = match.goalsTotal2H;
                        displayValue = value.toString();
                        break;
                    case 'cornersFor':
                        value = match.cornersFor;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'cornersAgainst':
                        value = match.cornersAgainst;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'offsidesFor':
                        value = match.offsidesFor;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'offsidesAgainst':
                        value = match.offsidesAgainst;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'shotsFor':
                        value = match.shotsFor;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'shotsAgainst':
                        value = match.shotsAgainst;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'shotsOnTargetFor':
                        value = match.shotsOnTargetFor;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'shotsOnTargetAgainst':
                        value = match.shotsOnTargetAgainst;
                        displayValue = value != null ? value.toString() : 'N/A';
                        break;
                    case 'xgFor':
                        value = match.xgFor;
                        displayValue = value != null ? parseFloat(value).toFixed(2) : 'N/A';
                        break;
                    case 'xgAgainst':
                        value = match.xgAgainst;
                        displayValue = value != null ? parseFloat(value).toFixed(2) : 'N/A';
                        break;
                    case 'possession':
                        value = match.possession;
                        displayValue = value != null ? value + '%' : 'N/A';
                        break;
                    default:
                        value = 0;
                        displayValue = 'N/A';
                }

                return {
                    date: match.date,
                    opponent: match.opponent,
                    homeAway: match.homeAway,
                    result: match.result,
                    resultClass: match.resultClass,
                    value: value,
                    displayValue: displayValue
                };
            }).filter(m => m.displayValue !== 'N/A');
        }

        // Prepare modal data for percentage stats (show only matching results)
        function preparePercentageModalData(stats, statType) {
            if (!stats || !stats.matchDetails) return [];

            return stats.matchDetails.filter(match => {
                switch (statType) {
                    case 'wins':
                        return match.result === 'W';
                    case 'draws':
                        return match.result === 'R';
                    case 'losses':
                        return match.result === 'P';
                    case 'firstHalfWin':
                        return match.firstHalfWin === 1;
                    case 'secondHalfWin':
                        return match.secondHalfWin === 1;
                    case 'bothHalvesWin':
                        return match.bothHalvesWin === 1;
                    case 'firstHalfAndFullWin':
                        return match.firstHalfAndFullWin === 1;
                    case 'bothTeamsScored':
                        return match.bothTeamsScored === 1;
                    case 'noGoalsScored':
                        return match.noGoalsScored === 1;
                    case 'atLeast1GoalScored':
                        return match.atLeast1GoalScored === 1;
                    case 'atLeast2GoalsScored':
                        return match.atLeast2GoalsScored === 1;
                    case 'cleanSheet':
                        return match.cleanSheet === 1;
                    case 'atLeast1GoalConceded':
                        return match.atLeast1GoalConceded === 1;
                    case 'atLeast2GoalsConceded':
                        return match.atLeast2GoalsConceded === 1;
                    default:
                        return false;
                }
            }).map(match => ({
                date: match.date,
                opponent: match.opponent,
                homeAway: match.homeAway,
                result: match.result,
                resultClass: match.resultClass,
                value: `${match.goalsScored}-${match.goalsConceded}`,
                displayValue: `${match.goalsScored}-${match.goalsConceded}`
            }));
        }

        function displayTeamStatistics(stats, availableLeagues) {
            if (!stats) {
                document.getElementById('team-stats-container').style.display = 'none';
                return;
            }

            // Store stats globally for modal access
            window.currentTeamStats = stats;

            // Helper function to get color class based on percentage
            const getPercentageColorClass = (percentage) => {
                const value = parseFloat(percentage);
                if (value >= 67) return 'text-green';
                if (value >= 34) return 'text-yellow';
                return 'text-red';
            };

            const container = document.getElementById('team-stats-container');
            container.style.display = 'block';

            let leagueOptions = '<option value="all">Wszystkie rozgrywki</option>';
            availableLeagues.forEach(league => {
                leagueOptions += `<option value="${league}">${league}</option>`;
            });

            container.innerHTML = `
                <div class="team-stats-panel">
                    <div class="team-stats-header">
                        <h3>‚öΩ Statystyki: ${stats.teamName}</h3>
                        <select class="team-stats-league-select" id="stats-league-filter" onchange="onStatsLeagueChange()">
                            ${leagueOptions}
                        </select>
                    </div>
                    <div class="team-stats-grid">
                        <!-- Mecze - highlight -->
                        <div class="stat-card highlight">
                            <div class="stat-card-label">Mecze</div>
                            <div class="stat-card-value">${stats.totalMatches}</div>
                        </div>

                        <!-- GRUPA 1: PUNKTY (niebieskie t≈Ço) -->
                        <div class="stat-card group-points">
                            <div class="stat-card-label">≈ör. punkt√≥w</div>
                            <div class="stat-card-value">${stats.avgPoints}</div>
                            <div class="stat-card-subtitle">og√≥lnie</div>
                        </div>
                        <div class="stat-card group-points">
                            <div class="stat-card-label">≈ör. punkt√≥w</div>
                            <div class="stat-card-value">${stats.avgPointsHome}</div>
                            <div class="stat-card-subtitle">u siebie</div>
                        </div>
                        <div class="stat-card group-points">
                            <div class="stat-card-label">≈ör. punkt√≥w</div>
                            <div class="stat-card-value">${stats.avgPointsAway}</div>
                            <div class="stat-card-subtitle">na wyje≈∫dzie</div>
                        </div>
                        <div class="stat-card group-points border-green">
                            <div class="stat-card-label">% Wygranych</div>
                            <div class="stat-card-value">${stats.winPercentage}%</div>
                        </div>
                        <div class="stat-card group-points border-yellow">
                            <div class="stat-card-label">% Remis√≥w</div>
                            <div class="stat-card-value">${stats.drawPercentage}%</div>
                        </div>
                        <div class="stat-card group-points border-red">
                            <div class="stat-card-label">% Pora≈ºek</div>
                            <div class="stat-card-value">${stats.lossPercentage}%</div>
                        </div>

                        <!-- GRUPA 2: PO≈ÅOWY (zielone t≈Ço) -->
                        <div class="stat-card group-halves">
                            <div class="stat-card-label">% Wygr. 1 po≈Ç.</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.firstHalfWinPercentage)}">${stats.firstHalfWinPercentage}%</div>
                        </div>
                        <div class="stat-card group-halves">
                            <div class="stat-card-label">% Wygr. 2 po≈Ç.</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.secondHalfWinPercentage)}">${stats.secondHalfWinPercentage}%</div>
                        </div>
                        <div class="stat-card group-halves">
                            <div class="stat-card-label">% Wygr. obu po≈Ç.</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.bothHalvesWinPercentage)}">${stats.bothHalvesWinPercentage}%</div>
                        </div>
                        <div class="stat-card group-halves">
                            <div class="stat-card-label">% Wygr. 1 po≈Ç. i ca≈Çy mecz</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.firstHalfAndFullWinPercentage)}">${stats.firstHalfAndFullWinPercentage}%</div>
                        </div>
                        <div class="stat-card group-halves border-green">
                            <div class="stat-card-label">% Prze≈Çama≈Ñ +</div>
                            <div class="stat-card-value">${stats.comebackWinPercentage}%</div>
                            <div class="stat-card-subtitle">przegr.‚Üíwygr.</div>
                        </div>
                        <div class="stat-card group-halves border-red">
                            <div class="stat-card-label">% Prze≈Çama≈Ñ -</div>
                            <div class="stat-card-value">${stats.comebackLossPercentage}%</div>
                            <div class="stat-card-subtitle">wygr.‚Üíprzegr.</div>
                        </div>

                        <!-- GRUPA 3: GOLE (pomara≈Ñczowe t≈Ço) -->
                        <div class="stat-card group-goals border-green">
                            <div class="stat-card-label">≈ör. goli</div>
                            <div class="stat-card-value">${stats.avgGoalsScored}</div>
                            <div class="stat-card-subtitle">strzelonych</div>
                        </div>
                        <div class="stat-card group-goals border-red">
                            <div class="stat-card-label">≈ör. goli</div>
                            <div class="stat-card-value">${stats.avgGoalsConceded}</div>
                            <div class="stat-card-subtitle">straconych</div>
                        </div>
                        <div class="stat-card group-goals">
                            <div class="stat-card-label">≈ör. goli</div>
                            <div class="stat-card-value">${stats.avgGoalsTotal}</div>
                            <div class="stat-card-subtitle">w sumie</div>
                        </div>
                        <div class="stat-card group-goals border-green">
                            <div class="stat-card-label">≈ör. goli 1H</div>
                            <div class="stat-card-value">${stats.avgGoalsScored1H}</div>
                            <div class="stat-card-subtitle">strzelonych</div>
                        </div>
                        <div class="stat-card group-goals border-green">
                            <div class="stat-card-label">≈ör. goli 2H</div>
                            <div class="stat-card-value">${stats.avgGoalsScored2H}</div>
                            <div class="stat-card-subtitle">strzelonych</div>
                        </div>
                        <div class="stat-card group-goals">
                            <div class="stat-card-label">≈ör. goli 1H</div>
                            <div class="stat-card-value">${stats.avgGoalsTotal1H}</div>
                            <div class="stat-card-subtitle">w sumie</div>
                        </div>
                        <div class="stat-card group-goals">
                            <div class="stat-card-label">≈ör. goli 2H</div>
                            <div class="stat-card-value">${stats.avgGoalsTotal2H}</div>
                            <div class="stat-card-subtitle">w sumie</div>
                        </div>
                        <div class="stat-card group-goals">
                            <div class="stat-card-label">% mecz√≥w BTS</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.bothTeamsScoredPercentage)}">${stats.bothTeamsScoredPercentage}%</div>
                            <div class="stat-card-subtitle">obie strzeli≈Çy</div>
                        </div>
                        <div class="stat-card group-goals border-green">
                            <div class="stat-card-label">≈ör. xG +</div>
                            <div class="stat-card-value">${stats.avgXgFor}</div>
                            <div class="stat-card-subtitle">(${stats.xgAvailable})</div>
                        </div>
                        <div class="stat-card group-goals border-red">
                            <div class="stat-card-label">≈ör. xG -</div>
                            <div class="stat-card-value">${stats.avgXgAgainst}</div>
                            <div class="stat-card-subtitle">(${stats.xgAvailable})</div>
                        </div>

                        <!-- GRUPA 3a: OVER/UNDER (brƒÖzowe t≈Ço) -->
                        <div class="stat-card group-overunder">
                            <div class="stat-card-label">% mecz√≥w bez strzelonej bramki</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.noGoalsScoredPercentage)}">${stats.noGoalsScoredPercentage}%</div>
                            <div class="stat-card-subtitle">0 goli</div>
                        </div>
                        <div class="stat-card group-overunder">
                            <div class="stat-card-label">% mecz√≥w ze strzelonƒÖ bramkƒÖ</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.atLeast1GoalScoredPercentage)}">${stats.atLeast1GoalScoredPercentage}%</div>
                            <div class="stat-card-subtitle">‚â•1 gol</div>
                        </div>
                        <div class="stat-card group-overunder">
                            <div class="stat-card-label">% mecz√≥w ze strzelonymi 2 bramkami</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.atLeast2GoalsScoredPercentage)}">${stats.atLeast2GoalsScoredPercentage}%</div>
                            <div class="stat-card-subtitle">‚â•2 gole</div>
                        </div>
                        <div class="stat-card group-overunder">
                            <div class="stat-card-label">% mecz√≥w z czystym kontem</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.cleanSheetPercentage)}">${stats.cleanSheetPercentage}%</div>
                            <div class="stat-card-subtitle">0 straconych</div>
                        </div>
                        <div class="stat-card group-overunder">
                            <div class="stat-card-label">% mecz√≥w ze straconƒÖ bramkƒÖ</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.atLeast1GoalConcededPercentage)}">${stats.atLeast1GoalConcededPercentage}%</div>
                            <div class="stat-card-subtitle">‚â•1 stracony</div>
                        </div>
                        <div class="stat-card group-overunder">
                            <div class="stat-card-label">% mecz√≥w ze straconymi 2 bramkami</div>
                            <div class="stat-card-value ${getPercentageColorClass(stats.atLeast2GoalsConcededPercentage)}">${stats.atLeast2GoalsConcededPercentage}%</div>
                            <div class="stat-card-subtitle">‚â•2 stracone</div>
                        </div>

                        <!-- GRUPA 4: RO≈ªNE (fioletowe t≈Ço) -->
                        <div class="stat-card group-corners border-green">
                            <div class="stat-card-label">≈ör. ro≈ºnych +</div>
                            <div class="stat-card-value">${stats.avgCornersFor}</div>
                            <div class="stat-card-subtitle">(${stats.cornersAvailable})</div>
                        </div>
                        <div class="stat-card group-corners border-red">
                            <div class="stat-card-label">≈ör. ro≈ºnych -</div>
                            <div class="stat-card-value">${stats.avgCornersAgainst}</div>
                            <div class="stat-card-subtitle">(${stats.cornersAvailable})</div>
                        </div>
                        <div class="stat-card group-corners border-green">
                            <div class="stat-card-label">Najczƒô≈õciej ro≈ºnych +</div>
                            <div class="stat-card-value">${stats.mostFrequentCornersFor}</div>
                        </div>
                        <div class="stat-card group-corners border-red">
                            <div class="stat-card-label">Najczƒô≈õciej ro≈ºnych -</div>
                            <div class="stat-card-value">${stats.mostFrequentCornersAgainst}</div>
                        </div>
                        <div class="stat-card group-corners">
                            <div class="stat-card-label">% mecz√≥w powy≈ºej ro≈ºnych +</div>
                            <div class="stat-card-value">${stats.percentAboveCornersForMode}%</div>
                            <div class="stat-card-subtitle">powy≈ºej najczƒôstszej</div>
                        </div>

                        <!-- GRUPA 5: STRZA≈ÅY (szare t≈Ço) -->
                        <div class="stat-card group-shots border-green">
                            <div class="stat-card-label">≈ör. strza≈Ç√≥w +</div>
                            <div class="stat-card-value">${stats.avgShotsFor}</div>
                            <div class="stat-card-subtitle">(${stats.shotsAvailable})</div>
                        </div>
                        <div class="stat-card group-shots border-red">
                            <div class="stat-card-label">≈ör. strza≈Ç√≥w -</div>
                            <div class="stat-card-value">${stats.avgShotsAgainst}</div>
                            <div class="stat-card-subtitle">(${stats.shotsAvailable})</div>
                        </div>
                        <div class="stat-card group-shots border-green">
                            <div class="stat-card-label">≈ör. strza≈Ç√≥w celnych +</div>
                            <div class="stat-card-value">${stats.avgShotsOnTargetFor}</div>
                            <div class="stat-card-subtitle">(${stats.shotsOnTargetAvailable})</div>
                        </div>
                        <div class="stat-card group-shots border-red">
                            <div class="stat-card-label">≈ör. strza≈Ç√≥w celnych -</div>
                            <div class="stat-card-value">${stats.avgShotsOnTargetAgainst}</div>
                            <div class="stat-card-subtitle">(${stats.shotsOnTargetAvailable})</div>
                        </div>

                        <!-- GRUPA 6: SPALENI I POSIADANIE (brƒÖzowe t≈Ço) -->
                        <div class="stat-card group-other">
                            <div class="stat-card-label">≈ör. spalonych +</div>
                            <div class="stat-card-value">${stats.avgOffsidesFor}</div>
                            <div class="stat-card-subtitle">(${stats.offsidesAvailable})</div>
                        </div>
                        <div class="stat-card group-other">
                            <div class="stat-card-label">≈ör. spalonych -</div>
                            <div class="stat-card-value">${stats.avgOffsidesAgainst}</div>
                            <div class="stat-card-subtitle">(${stats.offsidesAvailable})</div>
                        </div>
                        <div class="stat-card group-other">
                            <div class="stat-card-label">≈ör. posiadanie pi≈Çki</div>
                            <div class="stat-card-value">${stats.avgPossession}%</div>
                            <div class="stat-card-subtitle">(${stats.possessionAvailable})</div>
                        </div>
                    </div>
                </div>
            `;

            // Add click handlers to all stat cards
            setTimeout(() => {
                const statCards = container.querySelectorAll('.stat-card:not(.highlight)');
                statCards.forEach((card, index) => {
                    const label = card.querySelector('.stat-card-label')?.textContent;
                    const subtitle = card.querySelector('.stat-card-subtitle')?.textContent;
                    const fullLabel = subtitle ? `${label} - ${subtitle}` : label;

                    card.style.cursor = 'pointer';
                    card.onclick = () => {
                        let modalData = [];
                        let highlightValue = null;

                        // Determine which stat type based on label
                        if (label.includes('≈ör. punkt√≥w')) {
                            // Show all matches with result
                            modalData = stats.matchDetails.map(m => ({
                                ...m,
                                value: m.result === 'W' ? 3 : m.result === 'R' ? 1 : 0,
                                displayValue: `${m.goalsScored}-${m.goalsConceded} (${m.result === 'W' ? '3 pkt' : m.result === 'R' ? '1 pkt' : '0 pkt'})`
                            }));
                        } else if (label.includes('% Wygranych')) {
                            modalData = preparePercentageModalData(stats, 'wins');
                        } else if (label.includes('% Remis√≥w')) {
                            modalData = preparePercentageModalData(stats, 'draws');
                        } else if (label.includes('% Pora≈ºek')) {
                            modalData = preparePercentageModalData(stats, 'losses');
                        } else if (label.includes('% Wygr. 1 po≈Ç.')) {
                            modalData = preparePercentageModalData(stats, 'firstHalfWin');
                        } else if (label.includes('% Wygr. 2 po≈Ç.')) {
                            modalData = preparePercentageModalData(stats, 'secondHalfWin');
                        } else if (label.includes('% Wygr. obu po≈Ç.')) {
                            modalData = preparePercentageModalData(stats, 'bothHalvesWin');
                        } else if (label.includes('% Wygr. 1 po≈Ç. i ca≈Çy mecz')) {
                            modalData = preparePercentageModalData(stats, 'firstHalfAndFullWin');
                        } else if (label.includes('% Prze≈Çama≈Ñ +')) {
                            // Show only matches with comeback wins (przegr.‚Üíwygr.)
                            modalData = stats.matchDetails
                                .filter(m => m.isComebackWin)
                                .map(m => ({
                                    ...m,
                                    displayValue: `${m.goalsScored}-${m.goalsConceded}`,
                                    highlight: true
                                }));
                        } else if (label.includes('% Prze≈Çama≈Ñ -')) {
                            // Show only matches with comeback losses (wygr.‚Üíprzegr.)
                            modalData = stats.matchDetails
                                .filter(m => m.isComebackLoss)
                                .map(m => ({
                                    ...m,
                                    displayValue: `${m.goalsScored}-${m.goalsConceded}`,
                                    highlight: true
                                }));
                        } else if (label.includes('% Prze≈Çama≈Ñ')) {
                            // Fallback for general "% Prze≈Çama≈Ñ" (should not happen with + or -)
                            modalData = stats.matchDetails
                                .filter(m => m.isComebackWin || m.isComebackLoss)
                                .map(m => ({
                                    ...m,
                                    displayValue: `${m.goalsScored}-${m.goalsConceded}`
                                }));
                        } else if (label.includes('≈ör. goli') && subtitle?.includes('strzelonych')) {
                            if (subtitle.includes('1H')) {
                                modalData = prepareModalData(stats, 'goalsScored1H');
                            } else if (subtitle.includes('2H')) {
                                modalData = prepareModalData(stats, 'goalsScored2H');
                            } else {
                                modalData = prepareModalData(stats, 'goalsScored');
                            }
                        } else if (label.includes('≈ör. goli') && subtitle?.includes('straconych')) {
                            modalData = prepareModalData(stats, 'goalsConceded');
                        } else if (label.includes('≈ör. goli') && subtitle?.includes('w sumie')) {
                            if (subtitle.includes('1H')) {
                                modalData = prepareModalData(stats, 'goalsTotal1H');
                            } else if (subtitle.includes('2H')) {
                                modalData = prepareModalData(stats, 'goalsTotal2H');
                            } else {
                                modalData = prepareModalData(stats, 'goalsTotal');
                            }
                        } else if (label.includes('≈ör. xG +')) {
                            modalData = prepareModalData(stats, 'xgFor');
                        } else if (label.includes('≈ör. xG -')) {
                            modalData = prepareModalData(stats, 'xgAgainst');
                        } else if (label.includes('% mecz√≥w BTS')) {
                            modalData = preparePercentageModalData(stats, 'bothTeamsScored');
                        } else if (label.includes('% mecz√≥w bez strzelonej bramki')) {
                            modalData = preparePercentageModalData(stats, 'noGoalsScored');
                        } else if (label.includes('% mecz√≥w ze strzelonƒÖ bramkƒÖ') && !label.includes('2 bramkami')) {
                            modalData = preparePercentageModalData(stats, 'atLeast1GoalScored');
                        } else if (label.includes('% mecz√≥w ze strzelonymi 2 bramkami')) {
                            modalData = preparePercentageModalData(stats, 'atLeast2GoalsScored');
                        } else if (label.includes('% mecz√≥w z czystym kontem')) {
                            modalData = preparePercentageModalData(stats, 'cleanSheet');
                        } else if (label.includes('% mecz√≥w ze straconƒÖ bramkƒÖ') && !label.includes('2 bramkami')) {
                            modalData = preparePercentageModalData(stats, 'atLeast1GoalConceded');
                        } else if (label.includes('% mecz√≥w ze straconymi 2 bramkami')) {
                            modalData = preparePercentageModalData(stats, 'atLeast2GoalsConceded');
                        } else if (label.includes('≈ör. ro≈ºnych +')) {
                            modalData = prepareModalData(stats, 'cornersFor');
                        } else if (label.includes('≈ör. ro≈ºnych -')) {
                            modalData = prepareModalData(stats, 'cornersAgainst');
                        } else if (label.includes('Najczƒô≈õciej ro≈ºnych +')) {
                            modalData = prepareModalData(stats, 'cornersFor');
                            highlightValue = stats.cornersForMode.value;
                        } else if (label.includes('Najczƒô≈õciej ro≈ºnych -')) {
                            modalData = prepareModalData(stats, 'cornersAgainst');
                            highlightValue = stats.cornersAgainstMode.value;
                        } else if (label.includes('% mecz√≥w powy≈ºej')) {
                            modalData = prepareModalData(stats, 'cornersFor');
                            highlightValue = stats.cornersForMode.value;
                        } else if (label.includes('≈ör. strza≈Ç√≥w celnych +')) {
                            modalData = prepareModalData(stats, 'shotsOnTargetFor');
                        } else if (label.includes('≈ör. strza≈Ç√≥w celnych -')) {
                            modalData = prepareModalData(stats, 'shotsOnTargetAgainst');
                        } else if (label.includes('≈ör. strza≈Ç√≥w +')) {
                            modalData = prepareModalData(stats, 'shotsFor');
                        } else if (label.includes('≈ör. strza≈Ç√≥w -')) {
                            modalData = prepareModalData(stats, 'shotsAgainst');
                        } else if (label.includes('≈ör. spalonych +')) {
                            modalData = prepareModalData(stats, 'offsidesFor');
                        } else if (label.includes('≈ör. spalonych -')) {
                            modalData = prepareModalData(stats, 'offsidesAgainst');
                        } else if (label.includes('≈ör. posiadanie')) {
                            modalData = prepareModalData(stats, 'possession');
                        }

                        if (modalData.length > 0) {
                            showStatModal(fullLabel, modalData, highlightValue);
                        }
                    };
                });
            }, 100);
        }

        function onStatsLeagueChange() {
            const leagueFilter = document.getElementById('stats-league-filter').value;
            if (selectedTeamForColoring && lastFetchedMatches.length > 0) {
                // Get currently displayed matches (with limit applied)
                let matches = [...lastFetchedMatches];
                if (selectedLimit) {
                    matches = matches
                        .sort((a, b) => new Date(b.match_date) - new Date(a.match_date))
                        .slice(0, selectedLimit);
                }

                const stats = calculateTeamStatistics(selectedTeamForColoring, matches, leagueFilter);
                const availableLeagues = [...new Set(matches.map(m => m.league))];
                displayTeamStatistics(stats, availableLeagues);
                // Preserve selected league
                document.getElementById('stats-league-filter').value = leagueFilter;
            }
        }

        async function applyFilters() {
            const country = document.getElementById('filter-country').value;
            const league = document.getElementById('filter-league').value;
            const team = document.getElementById('filter-team').value;

            console.log('Applying filters:', { country, league, team, limit: selectedLimit });

            try {
                // Build query parameters
                const params = new URLSearchParams();
                if (country) params.append('country', country);
                if (league) params.append('league', league);
                if (team) params.append('team', team);

                // Fetch matches
                const response = await fetch(`/api/database/matches?${params}`);
                if (!response.ok) throw new Error('Failed to load matches');

                const allMatches = await response.json();

                // Store fetched matches and selected team for later filtering
                lastFetchedMatches = allMatches;
                selectedTeamForColoring = team;
                homeAwayFilter = 'all'; // Reset home/away filter when changing team

                // Display team statistics if a specific team is selected
                if (team) {
                    const availableLeagues = [...new Set(allMatches.map(m => m.league))];
                    const stats = calculateTeamStatistics(team, allMatches, 'all');
                    displayTeamStatistics(stats, availableLeagues);
                } else {
                    document.getElementById('team-stats-container').style.display = 'none';
                }

                // Apply limit
                applyLimitToResults();

                showToast(`Znaleziono ${allMatches.length} mecz√≥w`, 'success');
            } catch (error) {
                console.error('Error applying filters:', error);
                showToast('Nie uda≈Ço siƒô za≈Çadowaƒá mecz√≥w: ' + error.message, 'error');
            }
        }

        function resetFilters() {
            document.getElementById('filter-country').value = '';
            document.getElementById('filter-league').value = '';
            document.getElementById('filter-team').value = '';

            // Clear search inputs
            document.getElementById('filter-country-search').value = '';
            document.getElementById('filter-league-search').value = '';
            document.getElementById('filter-team-search').value = '';

            // Reset all select options visibility
            filterSelectOptions('filter-country', 'filter-country-search');
            filterSelectOptions('filter-league', 'filter-league-search');
            filterSelectOptions('filter-team', 'filter-team-search');

            // Reset limit to "00" (all)
            selectedLimit = null;
            lastFetchedMatches = [];
            selectedTeamForColoring = null;
            homeAwayFilter = 'all'; // Reset home/away filter

            // Hide team statistics
            document.getElementById('team-stats-container').style.display = 'none';

            document.querySelectorAll('.limit-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Set "00" button as active
            document.querySelector('.limit-btn[onclick="setLimitAndFilter(null)"]').classList.add('active');

            // Reload all filters to restore full lists
            loadDatabaseFilters();

            // Clear results
            document.getElementById('database-results').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <p>Wybierz filtry i kliknij Szukaj aby zobaczyƒá mecze</p>
                </div>
            `;

            showToast('Filtry zresetowane', 'success');
        }

        function displayDatabaseResults(matches, selectedTeam = null) {
            const resultsDiv = document.getElementById('database-results');

            if (matches.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Nie znaleziono mecz√≥w dla wybranych filtr√≥w</p>
                    </div>
                `;
                return;
            }

            // Split matches into upcoming and finished
            const upcomingMatches = matches.filter(m => m.is_finished === 'no');
            const finishedMatches = matches.filter(m => m.is_finished === 'yes');

            // Build table HTML
            let tableHTML = `
                <div class="results-header">
                    <div class="results-count">üìä Wy≈õwietlam ${matches.length} mecz√≥w (${upcomingMatches.length} nadchodzƒÖcych, ${finishedMatches.length} zako≈Ñczonych)</div>
                    ${selectedTeam ? `
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="limit-btn ${homeAwayFilter === 'all' ? 'active' : ''}" 
                                    onclick="setHomeAwayFilter('all')" 
                                    style="flex: 1;">
                                Wszystkie
                            </button>
                            <button class="limit-btn ${homeAwayFilter === 'home' ? 'active' : ''}" 
                                    onclick="setHomeAwayFilter('home')" 
                                    style="flex: 1;">
                                üè† Mecze domowe
                            </button>
                            <button class="limit-btn ${homeAwayFilter === 'away' ? 'active' : ''}" 
                                    onclick="setHomeAwayFilter('away')" 
                                    style="flex: 1;">
                                ‚úàÔ∏è Mecze wyjazdowe
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            // Function to render matches table
            function renderMatchesTable(matchesList, sectionTitle) {
                if (matchesList.length === 0) return '';

                let html = `
                    <div class="matches-section">
                        <h3 class="section-title">${sectionTitle}</h3>
                        <div style="overflow-x: auto;">
                            <table class="matches-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Mecz</th>
                                        <th>Wynik</th>
                                        <th>Liga</th>
                                        <th style="text-align: center;">Status</th>
                                        <th style="text-align: center;">Szczeg√≥≈Çy</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                matchesList.forEach(match => {
                    const date = new Date(match.match_date).toLocaleDateString('pl-PL', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    const result = match.result || 'draw';
                    const isFinished = match.is_finished === 'yes';

                    // Determine team colors based on context
                    let homeClass = '';
                    let awayClass = '';

                    if (selectedTeam) {
                        // Coloring for specific team view - only color the selected team
                        if (match.home_team === selectedTeam) {
                            // Selected team is home
                            if (result === 'home_win' || result === 'h-win') {
                                homeClass = 'win';
                            } else if (result === 'away_win' || result === 'a-win') {
                                homeClass = 'loss';
                            } else {
                                homeClass = 'draw';
                            }
                            awayClass = ''; // Opponent not colored
                        } else if (match.away_team === selectedTeam) {
                            // Selected team is away
                            if (result === 'away_win' || result === 'a-win') {
                                awayClass = 'win';
                            } else if (result === 'home_win' || result === 'h-win') {
                                awayClass = 'loss';
                            } else {
                                awayClass = 'draw';
                            }
                            homeClass = ''; // Opponent not colored
                        }
                    } else {
                        // Coloring for league/country view - color both teams
                        if (result === 'home_win' || result === 'h-win') {
                            homeClass = 'win';
                            awayClass = 'loss';
                        } else if (result === 'away_win' || result === 'a-win') {
                            homeClass = 'loss';
                            awayClass = 'win';
                        } else if (result === 'draw') {
                            homeClass = 'draw';
                            awayClass = 'draw';
                        }
                    }

                    // Build score display
                    const homeGoals = match.home_goals !== null && match.home_goals !== undefined ? match.home_goals : '-';
                    const awayGoals = match.away_goals !== null && match.away_goals !== undefined ? match.away_goals : '-';

                    const homeGoalsHT = match.home_goals_ht;
                    const awayGoalsHT = match.away_goals_ht;

                    // Show HT score only if both values exist and are not null
                    const htScoreDisplay = (homeGoalsHT !== null && homeGoalsHT !== undefined && awayGoalsHT !== null && awayGoalsHT !== undefined)
                        ? `(${homeGoalsHT}:${awayGoalsHT})`
                        : '';

                    const statusIcon = isFinished ? '‚úÖ' : '‚ùì';

                    html += `
                        <tr>
                            <td class="match-date">${date}</td>
                            <td>
                                <div class="match-teams">
                                    <span class="team-name ${homeClass}">${match.home_team}</span>
                                    <span>-</span>
                                    <span class="team-name ${awayClass}">${match.away_team}</span>
                                </div>
                            </td>
                            <td class="match-score">
                                <span class="score-main ${homeClass}">${homeGoals}</span>
                                <span>:</span>
                                <span class="score-main ${awayClass}">${awayGoals}</span>
                                ${htScoreDisplay ? `<span class="score-ht">${htScoreDisplay}</span>` : ''}
                            </td>
                            <td class="match-league">${match.league}</td>
                            <td class="match-status">${statusIcon}</td>
                            <td class="expand-icon" onclick="alert('Szczeg√≥≈Çy meczu - wkr√≥tce!')">üìä</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                return html;
            }

            // Render upcoming matches section
            if (upcomingMatches.length > 0) {
                tableHTML += renderMatchesTable(upcomingMatches, 'üîú NadchodzƒÖce mecze');
            }

            // Render finished matches section
            if (finishedMatches.length > 0) {
                tableHTML += renderMatchesTable(finishedMatches, '‚úÖ Zako≈Ñczone mecze');
            }

            resultsDiv.innerHTML = tableHTML;
        }

        // Initialize
        init();

        // =====================================
        // BET FINDER
        // =====================================
        let selectedMatchCount = 10;

        function initBetFinder() {
            // Set default dates (today + 7 days)
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);

            document.getElementById('bet-finder-date-from').valueAsDate = today;
            document.getElementById('bet-finder-date-to').valueAsDate = nextWeek;

            // Add event listeners for match count buttons
            document.querySelectorAll('.match-count-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.match-count-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedMatchCount = this.dataset.count === 'all' ? null : parseInt(this.dataset.count);
                });
            });
        }

        async function findMostGoals() {
            const dateFrom = document.getElementById('bet-finder-date-from').value;
            const dateTo = document.getElementById('bet-finder-date-to').value;

            if (!dateFrom || !dateTo) {
                showToast('Wybierz zakres dat', 'error');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                showToast('Data "od" nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º "do"', 'error');
                return;
            }

            showToast('Wyszukujƒô mecze...', 'info');

            try {
                // Fetch upcoming matches (use high limit to get all matches)
                const upcomingResponse = await fetch(`/api/database/matches?date_from=${dateFrom}&date_to=${dateTo}&is_finished=no&limit=10000`);

                if (!upcomingResponse.ok) {
                    const errorData = await upcomingResponse.json();
                    console.error('API Error:', errorData);
                    showToast(`B≈ÇƒÖd serwera: ${errorData.error || 'Nieznany b≈ÇƒÖd'}`, 'error');
                    return;
                }

                const upcomingMatches = await upcomingResponse.json();

                // Check if response is an array
                if (!Array.isArray(upcomingMatches)) {
                    console.error('Invalid response format:', upcomingMatches);
                    showToast('B≈ÇƒÖd: Nieprawid≈Çowy format odpowiedzi z serwera', 'error');
                    return;
                }

                if (upcomingMatches.length === 0) {
                    showToast('Nie znaleziono nadchodzƒÖcych mecz√≥w w wybranym zakresie', 'warning');
                    return;
                }

                showToast(`Znaleziono ${upcomingMatches.length} nadchodzƒÖcych mecz√≥w. Analizujƒô...`, 'info');

                // Calculate goal statistics for each match
                const matchStats = [];

                for (const match of upcomingMatches) {
                    const homeTeam = match.home_team;
                    const awayTeam = match.away_team;
                    const league = match.league;

                    // Fetch historical matches for both teams from the same league
                    const homeHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(homeTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const homeHistory = await homeHistoryResponse.json();

                    const awayHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(awayTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const awayHistory = await awayHistoryResponse.json();

                    // Calculate goal statistics
                    const homeStats = calculateGoalStats(homeHistory, homeTeam);
                    const awayStats = calculateGoalStats(awayHistory, awayTeam);

                    const totalGoals = homeStats.totalGoals + awayStats.totalGoals;
                    const totalMatches = homeStats.matchCount + awayStats.matchCount;
                    const averageGoals = totalMatches > 0 ? (totalGoals / totalMatches).toFixed(2) : 0;

                    // Skip if either team has less than 5 matches
                    if (homeStats.matchCount < 5 || awayStats.matchCount < 5) {
                        continue;
                    }

                    matchStats.push({
                        date: match.match_date,
                        league: match.league,
                        country: match.country || '',
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        homeStats,
                        awayStats,
                        totalGoals,
                        averageGoals: parseFloat(averageGoals)
                    });
                }

                // Check if we have any valid matches
                if (matchStats.length === 0) {
                    showToast('Nie znaleziono mecz√≥w spe≈ÇniajƒÖcych kryteria (obie dru≈ºyny muszƒÖ mieƒá min. 5 zako≈Ñczonych mecz√≥w)', 'warning');
                    return;
                }

                // Sort by average goals (descending) and take top 10
                matchStats.sort((a, b) => b.averageGoals - a.averageGoals);
                const top10 = matchStats.slice(0, 10);

                // Show results in modal
                showMostGoalsModal(top10, dateFrom, dateTo);

            } catch (error) {
                console.error('Error finding most goals:', error);
                showToast('B≈ÇƒÖd podczas wyszukiwania', 'error');
            }
        }

        async function findLeastGoals() {
            const dateFrom = document.getElementById('bet-finder-date-from').value;
            const dateTo = document.getElementById('bet-finder-date-to').value;

            if (!dateFrom || !dateTo) {
                showToast('Wybierz zakres dat', 'error');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                showToast('Data "od" nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º "do"', 'error');
                return;
            }

            showToast('Wyszukujƒô mecze...', 'info');

            try {
                // Fetch upcoming matches (use high limit to get all matches)
                const upcomingResponse = await fetch(`/api/database/matches?date_from=${dateFrom}&date_to=${dateTo}&is_finished=no&limit=10000`);

                if (!upcomingResponse.ok) {
                    const errorData = await upcomingResponse.json();
                    console.error('API Error:', errorData);
                    showToast(`B≈ÇƒÖd serwera: ${errorData.error || 'Nieznany b≈ÇƒÖd'}`, 'error');
                    return;
                }

                const upcomingMatches = await upcomingResponse.json();

                // Check if response is an array
                if (!Array.isArray(upcomingMatches)) {
                    console.error('Invalid response format:', upcomingMatches);
                    showToast('B≈ÇƒÖd: Nieprawid≈Çowy format odpowiedzi z serwera', 'error');
                    return;
                }

                if (upcomingMatches.length === 0) {
                    showToast('Nie znaleziono nadchodzƒÖcych mecz√≥w w wybranym zakresie', 'warning');
                    return;
                }

                showToast(`Znaleziono ${upcomingMatches.length} nadchodzƒÖcych mecz√≥w. Analizujƒô...`, 'info');

                // Calculate goal statistics for each match
                const matchStats = [];

                for (const match of upcomingMatches) {
                    const homeTeam = match.home_team;
                    const awayTeam = match.away_team;
                    const league = match.league;

                    // Fetch historical matches for both teams from the same league
                    const homeHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(homeTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const homeHistory = await homeHistoryResponse.json();

                    const awayHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(awayTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const awayHistory = await awayHistoryResponse.json();

                    // Calculate goal statistics
                    const homeStats = calculateGoalStats(homeHistory, homeTeam);
                    const awayStats = calculateGoalStats(awayHistory, awayTeam);

                    const totalGoals = homeStats.totalGoals + awayStats.totalGoals;
                    const totalMatches = homeStats.matchCount + awayStats.matchCount;
                    const averageGoals = totalMatches > 0 ? (totalGoals / totalMatches).toFixed(2) : 0;

                    // Skip if either team has less than 5 matches
                    if (homeStats.matchCount < 5 || awayStats.matchCount < 5) {
                        continue;
                    }

                    matchStats.push({
                        date: match.match_date,
                        league: match.league,
                        country: match.country || '',
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        homeStats,
                        awayStats,
                        totalGoals,
                        averageGoals: parseFloat(averageGoals)
                    });
                }

                // Check if we have any valid matches
                if (matchStats.length === 0) {
                    showToast('Nie znaleziono mecz√≥w spe≈ÇniajƒÖcych kryteria (obie dru≈ºyny muszƒÖ mieƒá min. 5 zako≈Ñczonych mecz√≥w)', 'warning');
                    return;
                }

                // Sort by average goals (ASCENDING for least goals) and take top 10
                matchStats.sort((a, b) => a.averageGoals - b.averageGoals);
                const top10 = matchStats.slice(0, 10);

                // Show results in modal
                showLeastGoalsModal(top10, dateFrom, dateTo);

            } catch (error) {
                console.error('Error finding least goals:', error);
                showToast('B≈ÇƒÖd podczas wyszukiwania', 'error');
            }
        }

        async function findGoalAdvantage() {
            const dateFrom = document.getElementById('bet-finder-date-from').value;
            const dateTo = document.getElementById('bet-finder-date-to').value;

            if (!dateFrom || !dateTo) {
                showToast('Wybierz zakres dat', 'error');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                showToast('Data "od" nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º "do"', 'error');
                return;
            }

            showToast('Wyszukujƒô mecze z przewagƒÖ...', 'info');

            try {
                // Fetch upcoming matches (use high limit to get all matches)
                const upcomingResponse = await fetch(`/api/database/matches?date_from=${dateFrom}&date_to=${dateTo}&is_finished=no&limit=10000`);

                if (!upcomingResponse.ok) {
                    const errorData = await upcomingResponse.json();
                    console.error('API Error:', errorData);
                    showToast(`B≈ÇƒÖd serwera: ${errorData.error || 'Nieznany b≈ÇƒÖd'}`, 'error');
                    return;
                }

                const upcomingMatches = await upcomingResponse.json();

                // Check if response is an array
                if (!Array.isArray(upcomingMatches)) {
                    console.error('Invalid response format:', upcomingMatches);
                    showToast('B≈ÇƒÖd: Nieprawid≈Çowy format odpowiedzi z serwera', 'error');
                    return;
                }

                if (upcomingMatches.length === 0) {
                    showToast('Nie znaleziono nadchodzƒÖcych mecz√≥w w wybranym zakresie', 'warning');
                    return;
                }

                showToast(`Znaleziono ${upcomingMatches.length} nadchodzƒÖcych mecz√≥w. Analizujƒô...`, 'info');

                // Calculate goal advantage for each match
                const matchStats = [];

                for (const match of upcomingMatches) {
                    const homeTeam = match.home_team;
                    const awayTeam = match.away_team;
                    const league = match.league;

                    // Fetch historical matches for both teams from the same league
                    const homeHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(homeTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const homeHistory = await homeHistoryResponse.json();

                    const awayHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(awayTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const awayHistory = await awayHistoryResponse.json();

                    // Calculate goal statistics
                    const homeStats = calculateGoalStats(homeHistory, homeTeam);
                    const awayStats = calculateGoalStats(awayHistory, awayTeam);

                    // Skip if either team has less than 5 matches
                    if (homeStats.matchCount < 5 || awayStats.matchCount < 5) {
                        continue;
                    }

                    // Calculate averages for both teams
                    const homeScoredAvg = homeStats.matchCount > 0 ? (homeStats.totalGoalsScored / homeStats.matchCount) : 0;
                    const homeConcededAvg = homeStats.matchCount > 0 ? (homeStats.totalGoalsConceded / homeStats.matchCount) : 0;
                    const awayScoredAvg = awayStats.matchCount > 0 ? (awayStats.totalGoalsScored / awayStats.matchCount) : 0;
                    const awayConcededAvg = awayStats.matchCount > 0 ? (awayStats.totalGoalsConceded / awayStats.matchCount) : 0;

                    // Calculate advantage in both directions:
                    // 1. Home scores a lot + Away concedes a lot (home advantage)
                    const homeAdvantageScore = homeScoredAvg + awayConcededAvg;

                    // 2. Away scores a lot + Home concedes a lot (away advantage)
                    const awayAdvantageScore = awayScoredAvg + homeConcededAvg;

                    // Take the higher advantage
                    const advantageScore = Math.max(homeAdvantageScore, awayAdvantageScore);
                    const advantageType = homeAdvantageScore > awayAdvantageScore ? 'home' : 'away';
                    const strongTeam = advantageType === 'home' ? match.home_team : match.away_team;
                    const weakTeam = advantageType === 'home' ? match.away_team : match.home_team;
                    const strongTeamScored = advantageType === 'home' ? homeScoredAvg : awayScoredAvg;
                    const weakTeamConceded = advantageType === 'home' ? awayConcededAvg : homeConcededAvg;

                    matchStats.push({
                        date: match.match_date,
                        league: match.league,
                        country: match.country || '',
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        homeStats,
                        awayStats,
                        advantageScore: parseFloat(advantageScore.toFixed(2)),
                        advantageType, // 'home' or 'away'
                        strongTeam,
                        weakTeam,
                        strongTeamScored: parseFloat(strongTeamScored.toFixed(2)),
                        weakTeamConceded: parseFloat(weakTeamConceded.toFixed(2))
                    });
                }

                // Check if we have any valid matches
                if (matchStats.length === 0) {
                    showToast('Nie znaleziono mecz√≥w spe≈ÇniajƒÖcych kryteria (obie dru≈ºyny muszƒÖ mieƒá min. 5 zako≈Ñczonych mecz√≥w)', 'warning');
                    return;
                }

                // Sort by advantage score (descending) and take top 10
                matchStats.sort((a, b) => b.advantageScore - a.advantageScore);
                const top10 = matchStats.slice(0, 10);

                // Show results in modal
                showGoalAdvantageModal(top10, dateFrom, dateTo);

            } catch (error) {
                console.error('Error finding goal advantage:', error);
                showToast('B≈ÇƒÖd podczas wyszukiwania', 'error');
            }
        }

        async function findHandicap15() {
            const dateFrom = document.getElementById('bet-finder-date-from').value;
            const dateTo = document.getElementById('bet-finder-date-to').value;

            if (!dateFrom || !dateTo) {
                showToast('Wybierz zakres dat', 'error');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                showToast('Data "od" nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º "do"', 'error');
                return;
            }

            showToast('Wyszukujƒô mecze dla Handicap 1.5...', 'info');

            try {
                // Fetch upcoming matches
                const upcomingResponse = await fetch(`/api/database/matches?date_from=${dateFrom}&date_to=${dateTo}&is_finished=no&limit=10000`);

                if (!upcomingResponse.ok) {
                    const errorData = await upcomingResponse.json();
                    console.error('API Error:', errorData);
                    showToast(`B≈ÇƒÖd serwera: ${errorData.error || 'Nieznany b≈ÇƒÖd'}`, 'error');
                    return;
                }

                const upcomingMatches = await upcomingResponse.json();

                if (!Array.isArray(upcomingMatches)) {
                    console.error('Invalid response format:', upcomingMatches);
                    showToast('B≈ÇƒÖd: Nieprawid≈Çowy format odpowiedzi z serwera', 'error');
                    return;
                }

                if (upcomingMatches.length === 0) {
                    showToast('Nie znaleziono nadchodzƒÖcych mecz√≥w w wybranym zakresie', 'warning');
                    return;
                }

                showToast(`Znaleziono ${upcomingMatches.length} nadchodzƒÖcych mecz√≥w. Analizujƒô...`, 'info');

                // Calculate handicap statistics for each match
                const matchStats = [];

                for (const match of upcomingMatches) {
                    const homeTeam = match.home_team;
                    const awayTeam = match.away_team;
                    const league = match.league;

                    // Fetch historical matches for both teams
                    const homeHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(homeTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const homeHistory = await homeHistoryResponse.json();

                    const awayHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(awayTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const awayHistory = await awayHistoryResponse.json();

                    // Calculate handicap statistics
                    const homeStats = calculateHandicapStats(homeHistory, homeTeam);
                    const awayStats = calculateHandicapStats(awayHistory, awayTeam);

                    // Skip if either team has less than 5 matches
                    if (homeStats.matchCount < 5 || awayStats.matchCount < 5) {
                        continue;
                    }

                    // Calculate percentages
                    const homeWinBy2Plus = homeStats.matchCount > 0 ? (homeStats.winsBy2Plus / homeStats.matchCount * 100) : 0;
                    const homeLoseBy2Plus = homeStats.matchCount > 0 ? (homeStats.lossesby2Plus / homeStats.matchCount * 100) : 0;
                    const awayWinBy2Plus = awayStats.matchCount > 0 ? (awayStats.winsBy2Plus / awayStats.matchCount * 100) : 0;
                    const awayLoseBy2Plus = awayStats.matchCount > 0 ? (awayStats.lossesby2Plus / awayStats.matchCount * 100) : 0;

                    // Calculate handicap scores in both directions:
                    // 1. Home wins by 2+ AND Away loses by 2+ (home handicap -1.5)
                    const homeHandicapScore = homeWinBy2Plus + awayLoseBy2Plus;

                    // 2. Away wins by 2+ AND Home loses by 2+ (away handicap -1.5)
                    const awayHandicapScore = awayWinBy2Plus + homeLoseBy2Plus;

                    // Take the higher handicap score
                    const handicapScore = Math.max(homeHandicapScore, awayHandicapScore);
                    const handicapType = homeHandicapScore > awayHandicapScore ? 'home' : 'away';
                    const strongTeam = handicapType === 'home' ? match.home_team : match.away_team;
                    const weakTeam = handicapType === 'home' ? match.away_team : match.home_team;
                    const strongTeamWins = handicapType === 'home' ? homeStats.winsBy2Plus : awayStats.winsBy2Plus;
                    const strongTeamWinsPct = handicapType === 'home' ? homeWinBy2Plus : awayWinBy2Plus;
                    const weakTeamLosses = handicapType === 'home' ? awayStats.lossesby2Plus : homeStats.lossesby2Plus;
                    const weakTeamLossesPct = handicapType === 'home' ? awayLoseBy2Plus : homeLoseBy2Plus;

                    matchStats.push({
                        date: match.match_date,
                        league: match.league,
                        country: match.country || '',
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        homeStats,
                        awayStats,
                        handicapScore: parseFloat(handicapScore.toFixed(1)),
                        handicapType, // 'home' or 'away'
                        strongTeam,
                        weakTeam,
                        strongTeamWins,
                        strongTeamWinsPct: parseFloat(strongTeamWinsPct.toFixed(1)),
                        weakTeamLosses,
                        weakTeamLossesPct: parseFloat(weakTeamLossesPct.toFixed(1))
                    });
                }

                // Check if we have any valid matches
                if (matchStats.length === 0) {
                    showToast('Nie znaleziono mecz√≥w spe≈ÇniajƒÖcych kryteria (obie dru≈ºyny muszƒÖ mieƒá min. 5 zako≈Ñczonych mecz√≥w)', 'warning');
                    return;
                }

                // Sort by handicap score (descending) and take top 10
                matchStats.sort((a, b) => b.handicapScore - a.handicapScore);
                const top10 = matchStats.slice(0, 10);

                // Show results in modal
                showHandicap15Modal(top10, dateFrom, dateTo);

            } catch (error) {
                console.error('Error finding handicap 1.5:', error);
                showToast('B≈ÇƒÖd podczas wyszukiwania', 'error');
            }
        }

        async function findMostCorners() {
            const dateFrom = document.getElementById('bet-finder-date-from').value;
            const dateTo = document.getElementById('bet-finder-date-to').value;

            if (!dateFrom || !dateTo) {
                showToast('Wybierz zakres dat', 'error');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                showToast('Data "od" nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º "do"', 'error');
                return;
            }

            showToast('Wyszukujƒô mecze z najwiƒôkszƒÖ liczbƒÖ ro≈ºnych...', 'info');

            try {
                // Fetch upcoming matches
                const upcomingResponse = await fetch(`/api/database/matches?date_from=${dateFrom}&date_to=${dateTo}&is_finished=no&limit=10000`);

                if (!upcomingResponse.ok) {
                    const errorData = await upcomingResponse.json();
                    console.error('API Error:', errorData);
                    showToast(`B≈ÇƒÖd serwera: ${errorData.error || 'Nieznany b≈ÇƒÖd'}`, 'error');
                    return;
                }

                const upcomingMatches = await upcomingResponse.json();

                if (!Array.isArray(upcomingMatches)) {
                    console.error('Invalid response format:', upcomingMatches);
                    showToast('B≈ÇƒÖd: Nieprawid≈Çowy format odpowiedzi z serwera', 'error');
                    return;
                }

                if (upcomingMatches.length === 0) {
                    showToast('Nie znaleziono nadchodzƒÖcych mecz√≥w w wybranym zakresie', 'warning');
                    return;
                }

                showToast(`Znaleziono ${upcomingMatches.length} nadchodzƒÖcych mecz√≥w. Analizujƒô...`, 'info');

                // Calculate corner statistics for each match
                const matchStats = [];

                for (const match of upcomingMatches) {
                    const homeTeam = match.home_team;
                    const awayTeam = match.away_team;
                    const league = match.league;

                    // Fetch historical matches for both teams
                    const homeHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(homeTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const homeHistory = await homeHistoryResponse.json();

                    const awayHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(awayTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const awayHistory = await awayHistoryResponse.json();

                    // Calculate corner statistics
                    const homeStats = calculateCornerStats(homeHistory, homeTeam);
                    const awayStats = calculateCornerStats(awayHistory, awayTeam);

                    // Skip if either team has less than 5 matches OR no corner data
                    if (homeStats.matchCount < 5 || awayStats.matchCount < 5 || homeStats.cornersMatchCount === 0 || awayStats.cornersMatchCount === 0) {
                        continue;
                    }

                    // Calculate average corners
                    const homeAvgCorners = homeStats.totalCorners / homeStats.cornersMatchCount;
                    const awayAvgCorners = awayStats.totalCorners / awayStats.cornersMatchCount;
                    const combinedAvgCorners = homeAvgCorners + awayAvgCorners;

                    matchStats.push({
                        date: match.match_date,
                        league: match.league,
                        country: match.country || '',
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        homeStats,
                        awayStats,
                        homeAvgCorners: parseFloat(homeAvgCorners.toFixed(2)),
                        awayAvgCorners: parseFloat(awayAvgCorners.toFixed(2)),
                        averageCorners: parseFloat(combinedAvgCorners.toFixed(2))
                    });
                }

                // Check if we have any valid matches
                if (matchStats.length === 0) {
                    showToast('Nie znaleziono mecz√≥w z danymi o rzutach ro≈ºnych (obie dru≈ºyny muszƒÖ mieƒá min. 5 zako≈Ñczonych mecz√≥w z dostƒôpnymi statystykami)', 'warning');
                    return;
                }

                // Sort by average corners (descending) and take top 10
                matchStats.sort((a, b) => b.averageCorners - a.averageCorners);
                const top10 = matchStats.slice(0, 10);

                // Show results in modal
                showMostCornersModal(top10, dateFrom, dateTo);

            } catch (error) {
                console.error('Error finding most corners:', error);
                showToast('B≈ÇƒÖd podczas wyszukiwania', 'error');
            }
        }

        async function findLeastCorners() {
            const dateFrom = document.getElementById('bet-finder-date-from').value;
            const dateTo = document.getElementById('bet-finder-date-to').value;

            if (!dateFrom || !dateTo) {
                showToast('Wybierz zakres dat', 'error');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                showToast('Data "od" nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º "do"', 'error');
                return;
            }

            showToast('Wyszukujƒô mecze z najmniejszƒÖ liczbƒÖ ro≈ºnych...', 'info');

            try {
                // Fetch upcoming matches
                const upcomingResponse = await fetch(`/api/database/matches?date_from=${dateFrom}&date_to=${dateTo}&is_finished=no&limit=10000`);

                if (!upcomingResponse.ok) {
                    const errorData = await upcomingResponse.json();
                    console.error('API Error:', errorData);
                    showToast(`B≈ÇƒÖd serwera: ${errorData.error || 'Nieznany b≈ÇƒÖd'}`, 'error');
                    return;
                }

                const upcomingMatches = await upcomingResponse.json();

                if (!Array.isArray(upcomingMatches)) {
                    console.error('Invalid response format:', upcomingMatches);
                    showToast('B≈ÇƒÖd: Nieprawid≈Çowy format odpowiedzi z serwera', 'error');
                    return;
                }

                if (upcomingMatches.length === 0) {
                    showToast('Nie znaleziono nadchodzƒÖcych mecz√≥w w wybranym zakresie', 'warning');
                    return;
                }

                showToast(`Znaleziono ${upcomingMatches.length} nadchodzƒÖcych mecz√≥w. Analizujƒô...`, 'info');

                // Calculate corner statistics for each match
                const matchStats = [];

                for (const match of upcomingMatches) {
                    const homeTeam = match.home_team;
                    const awayTeam = match.away_team;
                    const league = match.league;

                    // Fetch historical matches for both teams
                    const homeHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(homeTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const homeHistory = await homeHistoryResponse.json();

                    const awayHistoryResponse = await fetch(
                        `/api/database/matches?team=${encodeURIComponent(awayTeam)}&league=${encodeURIComponent(league)}&is_finished=yes&sort=date_desc${selectedMatchCount ? `&limit=${selectedMatchCount}` : ''}`
                    );
                    const awayHistory = await awayHistoryResponse.json();

                    // Calculate corner statistics
                    const homeStats = calculateCornerStats(homeHistory, homeTeam);
                    const awayStats = calculateCornerStats(awayHistory, awayTeam);

                    // Skip if either team has less than 5 matches OR no corner data
                    if (homeStats.matchCount < 5 || awayStats.matchCount < 5 || homeStats.cornersMatchCount === 0 || awayStats.cornersMatchCount === 0) {
                        continue;
                    }

                    // Calculate average corners
                    const homeAvgCorners = homeStats.totalCorners / homeStats.cornersMatchCount;
                    const awayAvgCorners = awayStats.totalCorners / awayStats.cornersMatchCount;
                    const combinedAvgCorners = homeAvgCorners + awayAvgCorners;

                    matchStats.push({
                        date: match.match_date,
                        league: match.league,
                        country: match.country || '',
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        homeStats,
                        awayStats,
                        homeAvgCorners: parseFloat(homeAvgCorners.toFixed(2)),
                        awayAvgCorners: parseFloat(awayAvgCorners.toFixed(2)),
                        averageCorners: parseFloat(combinedAvgCorners.toFixed(2))
                    });
                }

                // Check if we have any valid matches
                if (matchStats.length === 0) {
                    showToast('Nie znaleziono mecz√≥w z danymi o rzutach ro≈ºnych (obie dru≈ºyny muszƒÖ mieƒá min. 5 zako≈Ñczonych mecz√≥w z dostƒôpnymi statystykami)', 'warning');
                    return;
                }

                // Sort by average corners (ascending) and take top 10
                matchStats.sort((a, b) => a.averageCorners - b.averageCorners);
                const top10 = matchStats.slice(0, 10);

                // Show results in modal
                showLeastCornersModal(top10, dateFrom, dateTo);

            } catch (error) {
                console.error('Error finding least corners:', error);
                showToast('B≈ÇƒÖd podczas wyszukiwania', 'error');
            }
        }

        function calculateCornerStats(matches, teamName) {
            let totalCorners = 0;
            let cornersMatchCount = 0;
            let matchCount = 0;
            const matchDetails = [];

            matches.forEach(match => {
                matchCount++;

                const isHome = match.home_team === teamName;

                // Only count matches with corner data
                if (match.home_corners != null && match.away_corners != null) {
                    const teamCorners = isHome ? match.home_corners : match.away_corners;
                    const opponentCorners = isHome ? match.away_corners : match.home_corners;
                    const totalMatchCorners = match.home_corners + match.away_corners;

                    totalCorners += teamCorners;
                    cornersMatchCount++;

                    // Store match details
                    matchDetails.push({
                        date: match.match_date,
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        homeGoals: match.home_goals,
                        awayGoals: match.away_goals,
                        homeCorners: match.home_corners,
                        awayCorners: match.away_corners,
                        totalCorners: totalMatchCorners,
                        teamCorners: teamCorners,
                        isHome: isHome
                    });
                }
            });

            return {
                totalCorners,
                cornersMatchCount,
                matchCount,
                avgCorners: cornersMatchCount > 0 ? parseFloat((totalCorners / cornersMatchCount).toFixed(2)) : 0,
                matches: matchDetails
            };
        }

        function calculateHandicapStats(matches, teamName) {
            let winsBy2Plus = 0;
            let lossesby2Plus = 0;
            let matchCount = 0;
            const matchDetails = [];

            matches.forEach(match => {
                const isHome = match.home_team === teamName;
                const goalsScored = isHome ? match.home_goals : match.away_goals;
                const goalsConceded = isHome ? match.away_goals : match.home_goals;
                const goalDifference = goalsScored - goalsConceded;

                matchCount++;

                // Check if win/loss by 2+ goals
                if (goalDifference >= 2) {
                    winsBy2Plus++;
                }
                if (goalDifference <= -2) {
                    lossesby2Plus++;
                }

                // Store match details
                matchDetails.push({
                    date: match.match_date,
                    homeTeam: match.home_team,
                    awayTeam: match.away_team,
                    homeGoals: match.home_goals,
                    awayGoals: match.away_goals,
                    goalDifference: Math.abs(goalDifference),
                    isWinBy2Plus: goalDifference >= 2,
                    isLossBy2Plus: goalDifference <= -2,
                    isHome: isHome
                });
            });

            return {
                winsBy2Plus,
                lossesby2Plus,
                matchCount,
                matches: matchDetails
            };
        }

        function calculateGoalStats(matches, teamName) {
            let totalGoalsScored = 0;
            let totalGoalsConceded = 0;
            let matchCount = 0;
            const matchDetails = []; // Store match details

            matches.forEach(match => {
                const isHome = match.home_team === teamName;
                const goalsScored = isHome ? match.home_goals : match.away_goals;
                const goalsConceded = isHome ? match.away_goals : match.home_goals;

                totalGoalsScored += goalsScored || 0;
                totalGoalsConceded += goalsConceded || 0;
                matchCount++;

                // Store match details
                matchDetails.push({
                    date: match.match_date,
                    homeTeam: match.home_team,
                    awayTeam: match.away_team,
                    homeGoals: match.home_goals,
                    awayGoals: match.away_goals,
                    totalGoals: (match.home_goals || 0) + (match.away_goals || 0),
                    isHome: isHome
                });
            });

            const totalGoals = totalGoalsScored + totalGoalsConceded;
            const avgGoals = matchCount > 0 ? (totalGoals / matchCount).toFixed(2) : 0;

            return {
                totalGoalsScored,
                totalGoalsConceded,
                totalGoals,
                matchCount,
                avgGoals: parseFloat(avgGoals),
                matches: matchDetails // Include match details
            };
        }

        // Store modal data globally
        let currentModalResults = null;
        let currentModalType = null;

        function showMostGoalsModal(results, dateFrom, dateTo) {
            if (results.length === 0) {
                showToast('Brak wynik√≥w do wy≈õwietlenia', 'warning');
                return;
            }

            // Store results for minimize/restore
            currentModalResults = results;
            currentModalType = 'most-goals';

            // Calculate total analyzed matches
            const totalMatchesAnalyzed = results.reduce((sum, r) => sum + r.homeStats.matchCount + r.awayStats.matchCount, 0);
            const formattedDateFrom = new Date(dateFrom).toLocaleDateString('pl-PL');
            const formattedDateTo = new Date(dateTo).toLocaleDateString('pl-PL');

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeModal()" style="z-index: 9999;"></div>
                <div class="modal-dialog" style="max-width: 1200px; z-index: 10000;">
                    <div class="modal-header">
                        <div>
                            <h2>‚öΩ TOP 10 - Najwiƒôcej bramek</h2>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">
                                üìÖ ${formattedDateFrom} - ${formattedDateTo} | üìä Analizowano ${totalMatchesAnalyzed} mecz√≥w
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                            <p style="margin: 0; color: #78350f; font-size: 14px; line-height: 1.6;">
                                <strong>‚ÑπÔ∏è O czym jest ten modal:</strong><br>
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najwy≈ºszƒÖ ≈õredniƒÖ bramek w ostatnich meczach. 
                                Im wy≈ºsza ≈ÇƒÖczna ≈õrednia, tym wiƒôksze prawdopodobie≈Ñstwo bramkowego spotkania.
                            </p>
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Data</th>
                                    <th>Liga</th>
                                    <th>Gospodarze</th>
                                    <th>Statystyki gospodarzy</th>
                                    <th>Go≈õcie</th>
                                    <th>Statystyki go≈õci</th>
                                    <th>≈ÅƒÖczna ≈õrednia</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                const homeStatsText = `${result.homeStats.totalGoalsScored}:${result.homeStats.totalGoalsConceded} (≈õr. ${result.homeStats.avgGoals})`;
                const awayStatsText = `${result.awayStats.totalGoalsScored}:${result.awayStats.totalGoalsConceded} (≈õr. ${result.awayStats.avgGoals})`;

                // Escape data for onclick attribute
                const resultData = JSON.stringify(result).replace(/"/g, '&quot;');

                modalHTML += `
                    <tr>
                        <td style="font-weight: 700; color: #667eea;">${index + 1}</td>
                        <td>${new Date(result.date).toLocaleDateString('pl-PL')}</td>
                        <td style="font-size: 12px; color: #666;">${result.league}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.homeTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.homeTeam}
                            </a>
                        </td>
                        <td>${homeStatsText}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.awayTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.awayTeam}
                            </a>
                        </td>
                        <td>${awayStatsText}</td>
                        <td style="font-weight: 700; font-size: 18px; color: #f5576c; cursor: pointer; text-decoration: underline;" 
                            onclick='showMatchDetailsModal(${resultData})' 
                            title="Kliknij aby zobaczyƒá szczeg√≥≈Çy mecz√≥w">
                            ${result.averageGoals}
                        </td>
                        <td>
                            <button onclick='addToWatchedMatches(${resultData}, "Najwiƒôcej bramek")' 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;" 
                                    title="Dodaj do obserwowanych">
                                ‚≠ê Dodaj
                            </button>
                        </td>
                    </tr>
                `;
            });

            modalHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Remove existing modal of ANY type before creating new one
            const existingModal = document.getElementById('bet-finder-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bet-finder-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Save to localStorage for persistence
            addOpenModal('most-goals', results, false, dateFrom, dateTo);
        }

        function showLeastGoalsModal(results, dateFrom, dateTo) {
            if (results.length === 0) {
                showToast('Brak wynik√≥w do wy≈õwietlenia', 'warning');
                return;
            }

            // Store results for minimize/restore
            currentModalResults = results;
            currentModalType = 'least-goals';

            // Calculate total analyzed matches
            const totalMatchesAnalyzed = results.reduce((sum, r) => sum + r.homeStats.matchCount + r.awayStats.matchCount, 0);
            const formattedDateFrom = new Date(dateFrom).toLocaleDateString('pl-PL');
            const formattedDateTo = new Date(dateTo).toLocaleDateString('pl-PL');

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeModal()" style="z-index: 9999;"></div>
                <div class="modal-dialog" style="max-width: 1200px; z-index: 10000;">
                    <div class="modal-header">
                        <div>
                            <h2>üßä TOP 10 - Najmniej bramek</h2>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">
                                üìÖ ${formattedDateFrom} - ${formattedDateTo} | üìä Analizowano ${totalMatchesAnalyzed} mecz√≥w
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                            <p style="margin: 0; color: #1e3a8a; font-size: 14px; line-height: 1.6;">
                                <strong>‚ÑπÔ∏è O czym jest ten modal:</strong><br>
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najni≈ºszƒÖ ≈õredniƒÖ bramek w ostatnich meczach. 
                                Im ni≈ºsza ≈ÇƒÖczna ≈õrednia, tym wiƒôksze prawdopodobie≈Ñstwo defensywnego, ma≈Ço bramkowego meczu.
                            </p>
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Data</th>
                                    <th>Liga</th>
                                    <th>Gospodarze</th>
                                    <th>Statystyki gospodarzy</th>
                                    <th>Go≈õcie</th>
                                    <th>Statystyki go≈õci</th>
                                    <th>≈ÅƒÖczna ≈õrednia</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                const homeStatsText = `${result.homeStats.totalGoalsScored}:${result.homeStats.totalGoalsConceded} (≈õr. ${result.homeStats.avgGoals})`;
                const awayStatsText = `${result.awayStats.totalGoalsScored}:${result.awayStats.totalGoalsConceded} (≈õr. ${result.awayStats.avgGoals})`;

                // Escape data for onclick attribute
                const resultData = JSON.stringify(result).replace(/"/g, '&quot;');

                modalHTML += `
                    <tr>
                        <td style="font-weight: 700; color: #3b82f6;">${index + 1}</td>
                        <td>${new Date(result.date).toLocaleDateString('pl-PL')}</td>
                        <td style="font-size: 12px; color: #666;">${result.league}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.homeTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.homeTeam}
                            </a>
                        </td>
                        <td>${homeStatsText}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.awayTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.awayTeam}
                            </a>
                        </td>
                        <td>${awayStatsText}</td>
                        <td style="font-weight: 700; font-size: 18px; color: #3b82f6; cursor: pointer; text-decoration: underline;" 
                            onclick='showMatchDetailsModal(${resultData})' 
                            title="Kliknij aby zobaczyƒá szczeg√≥≈Çy mecz√≥w">
                            ${result.averageGoals}
                        </td>
                        <td>
                            <button onclick='addToWatchedMatches(${resultData}, "Najmniej bramek")' 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;" 
                                    title="Dodaj do obserwowanych">
                                ‚≠ê Dodaj
                            </button>
                        </td>
                    </tr>
                `;
            });

            modalHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Remove existing modal of ANY type before creating new one
            const existingModal = document.getElementById('bet-finder-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bet-finder-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Save to localStorage for persistence
            addOpenModal('least-goals', results, false, dateFrom, dateTo);
        }

        function showHandicap15Modal(results, dateFrom, dateTo) {
            currentModalResults = results;
            currentModalType = 'handicap-15';

            // Calculate total analyzed matches
            const totalMatchesAnalyzed = results.reduce((sum, r) => sum + r.homeStats.matchCount + r.awayStats.matchCount, 0);
            const formattedDateFrom = new Date(dateFrom).toLocaleDateString('pl-PL');
            const formattedDateTo = new Date(dateTo).toLocaleDateString('pl-PL');

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeModal()" style="z-index: 9999;"></div>
                <div class="modal-dialog" style="max-width: 1500px; z-index: 10000;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div>
                            <h2>üéØ TOP 10 - Handicap 1.5</h2>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">
                                üìÖ ${formattedDateFrom} - ${formattedDateTo} | üìä Analizowano ${totalMatchesAnalyzed} mecz√≥w
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                            <p style="margin: 0; color: #78350f; font-size: 14px; line-height: 1.6;">
                                <strong>‚ÑπÔ∏è O czym jest ten modal:</strong><br>
                                Znajduje mecze gdzie jedna dru≈ºyna czƒôsto wygrywa r√≥≈ºnicƒÖ ‚â•2 bramek, a druga czƒôsto przegrywa r√≥≈ºnicƒÖ ‚â•2 bramek. 
                                Wysoki wynik H-1.5 wskazuje na potencjalnie jednostronne spotkanie.
                            </p>
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Data</th>
                                    <th>Liga</th>
                                    <th>Gospodarze</th>
                                    <th>Go≈õcie</th>
                                    <th>Silna dru≈ºyna</th>
                                    <th>Wygrane ‚â•2</th>
                                    <th>% wygranych</th>
                                    <th>S≈Çaba dru≈ºyna</th>
                                    <th>Pora≈ºki ‚â•2</th>
                                    <th>% pora≈ºek</th>
                                    <th>Wynik H-1.5</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                // Escape data for onclick attribute
                const resultData = JSON.stringify(result).replace(/"/g, '&quot;');

                // Determine which team is strong and weak
                const advantageIcon = result.handicapType === 'home' ? 'üè†' : '‚úàÔ∏è';

                modalHTML += `
                    <tr>
                        <td style="font-weight: 700; color: #f59e0b;">${index + 1}</td>
                        <td>${new Date(result.date).toLocaleDateString('pl-PL')}</td>
                        <td style="font-size: 12px; color: #666;">${result.league}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.homeTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.homeTeam}
                            </a>
                        </td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.awayTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.awayTeam}
                            </a>
                        </td>
                        <td style="font-weight: 700; color: #f59e0b;">
                            ${advantageIcon} ${result.strongTeam}
                        </td>
                        <td style="font-weight: 600; color: #059669;">
                            ${result.strongTeamWins}
                        </td>
                        <td style="font-weight: 700; color: #059669;">
                            ${result.strongTeamWinsPct}%
                        </td>
                        <td style="font-weight: 600; color: #dc2626;">
                            ${result.weakTeam}
                        </td>
                        <td style="font-weight: 600; color: #991b1b;">
                            ${result.weakTeamLosses}
                        </td>
                        <td style="font-weight: 700; color: #991b1b;">
                            ${result.weakTeamLossesPct}%
                        </td>
                        <td style="font-weight: 700; font-size: 18px; color: #f59e0b; cursor: pointer; text-decoration: underline;" 
                            onclick='showMatchDetailsModal(${resultData})' 
                            title="Kliknij aby zobaczyƒá szczeg√≥≈Çy mecz√≥w">
                            ${result.handicapScore}
                        </td>
                        <td>
                            <button onclick='addToWatchedMatches(${resultData}, "Handicap 1.5")' 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;" 
                                    title="Dodaj do obserwowanych">
                                ‚≠ê Dodaj
                            </button>
                        </td>
                    </tr>
                `;
            });

            modalHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Remove existing modal of ANY type before creating new one
            const existingModal = document.getElementById('bet-finder-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bet-finder-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Save to localStorage for persistence
            addOpenModal('handicap-15', results, false, dateFrom, dateTo);
        }

        function showMostCornersModal(results, dateFrom, dateTo) {
            currentModalResults = results;
            currentModalType = 'most-corners';

            // Calculate total analyzed matches
            const totalMatchesAnalyzed = results.reduce((sum, r) => sum + r.homeStats.cornersMatchCount + r.awayStats.cornersMatchCount, 0);
            const formattedDateFrom = new Date(dateFrom).toLocaleDateString('pl-PL');
            const formattedDateTo = new Date(dateTo).toLocaleDateString('pl-PL');

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeModal()" style="z-index: 9999;"></div>
                <div class="modal-dialog" style="max-width: 1400px; z-index: 10000;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                        <div>
                            <h2>‚öΩ TOP 10 - Najwiƒôcej ro≈ºnych</h2>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">
                                üìÖ ${formattedDateFrom} - ${formattedDateTo} | üìä Analizowano ${totalMatchesAnalyzed} mecz√≥w
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">
                            <p style="margin: 0; color: #4c1d95; font-size: 14px; line-height: 1.6;">
                                <strong>‚ÑπÔ∏è O czym jest ten modal:</strong><br>
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najwy≈ºszƒÖ ≈õredniƒÖ rzut√≥w ro≈ºnych w ostatnich meczach. 
                                Im wy≈ºsza ≈ÇƒÖczna ≈õrednia, tym wiƒôcej mo≈ºna spodziewaƒá siƒô ro≈ºnych w nadchodzƒÖcym meczu.
                            </p>
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Data</th>
                                    <th>Liga</th>
                                    <th>Gospodarze</th>
                                    <th>≈ör. ro≈ºnych</th>
                                    <th>Go≈õcie</th>
                                    <th>≈ör. ro≈ºnych</th>
                                    <th>≈ÅƒÖczna ≈õrednia</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                // Escape data for onclick attribute
                const resultData = JSON.stringify(result).replace(/"/g, '&quot;');

                modalHTML += `
                    <tr>
                        <td style="font-weight: 700; color: #8b5cf6;">${index + 1}</td>
                        <td>${new Date(result.date).toLocaleDateString('pl-PL')}</td>
                        <td style="font-size: 12px; color: #666;">${result.league}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.homeTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.homeTeam}
                            </a>
                        </td>
                        <td style="font-weight: 600; color: #6d28d9;">
                            ${result.homeAvgCorners} (${result.homeStats.cornersMatchCount} mecz√≥w)
                        </td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.awayTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.awayTeam}
                            </a>
                        </td>
                        <td style="font-weight: 600; color: #6d28d9;">
                            ${result.awayAvgCorners} (${result.awayStats.cornersMatchCount} mecz√≥w)
                        </td>
                        <td style="font-weight: 700; font-size: 18px; color: #8b5cf6; cursor: pointer; text-decoration: underline;" 
                            onclick='showMatchDetailsModal(${resultData})' 
                            title="Kliknij aby zobaczyƒá szczeg√≥≈Çy mecz√≥w">
                            ${result.averageCorners}
                        </td>
                        <td>
                            <button onclick='addToWatchedMatches(${resultData}, "Najwiƒôcej ro≈ºnych")' 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;" 
                                    title="Dodaj do obserwowanych">
                                ‚≠ê Dodaj
                            </button>
                        </td>
                    </tr>
                `;
            });

            modalHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Remove existing modal of ANY type before creating new one
            const existingModal = document.getElementById('bet-finder-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bet-finder-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Save to localStorage for persistence
            addOpenModal('most-corners', results, false, dateFrom, dateTo);
        }

        function showLeastCornersModal(results, dateFrom, dateTo) {
            currentModalResults = results;
            currentModalType = 'least-corners';

            // Calculate total analyzed matches
            const totalMatchesAnalyzed = results.reduce((sum, r) => sum + r.homeStats.cornersMatchCount + r.awayStats.cornersMatchCount, 0);
            const formattedDateFrom = new Date(dateFrom).toLocaleDateString('pl-PL');
            const formattedDateTo = new Date(dateTo).toLocaleDateString('pl-PL');

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeModal()" style="z-index: 9999;"></div>
                <div class="modal-dialog" style="max-width: 1400px; z-index: 10000;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);">
                        <div>
                            <h2>üéØ TOP 10 - Najmniej ro≈ºnych</h2>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">
                                üìÖ ${formattedDateFrom} - ${formattedDateTo} | üìä Analizowano ${totalMatchesAnalyzed} mecz√≥w
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ec4899;">
                            <p style="margin: 0; color: #831843; font-size: 14px; line-height: 1.6;">
                                <strong>‚ÑπÔ∏è O czym jest ten modal:</strong><br>
                                Znajduje mecze gdzie obie dru≈ºyny majƒÖ najni≈ºszƒÖ ≈õredniƒÖ rzut√≥w ro≈ºnych w ostatnich meczach. 
                                Im ni≈ºsza ≈ÇƒÖczna ≈õrednia, tym mniej ro≈ºnych mo≈ºna spodziewaƒá siƒô w nadchodzƒÖcym meczu.
                            </p>
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Data</th>
                                    <th>Liga</th>
                                    <th>Gospodarze</th>
                                    <th>≈ör. ro≈ºnych</th>
                                    <th>Go≈õcie</th>
                                    <th>≈ör. ro≈ºnych</th>
                                    <th>≈ÅƒÖczna ≈õrednia</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                // Escape data for onclick attribute
                const resultData = JSON.stringify(result).replace(/"/g, '&quot;');

                modalHTML += `
                    <tr>
                        <td style="font-weight: 700; color: #ec4899;">${index + 1}</td>
                        <td>${new Date(result.date).toLocaleDateString('pl-PL')}</td>
                        <td style="font-size: 12px; color: #666;">${result.league}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.homeTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.homeTeam}
                            </a>
                        </td>
                        <td style="font-weight: 600; color: #be185d;">
                            ${result.homeAvgCorners} (${result.homeStats.cornersMatchCount} mecz√≥w)
                        </td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.awayTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.awayTeam}
                            </a>
                        </td>
                        <td style="font-weight: 600; color: #be185d;">
                            ${result.awayAvgCorners} (${result.awayStats.cornersMatchCount} mecz√≥w)
                        </td>
                        <td style="font-weight: 700; font-size: 18px; color: #ec4899; cursor: pointer; text-decoration: underline;" 
                            onclick='showMatchDetailsModal(${resultData})' 
                            title="Kliknij aby zobaczyƒá szczeg√≥≈Çy mecz√≥w">
                            ${result.averageCorners}
                        </td>
                        <td>
                            <button onclick='addToWatchedMatches(${resultData}, "Najmniej ro≈ºnych")' 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;" 
                                    title="Dodaj do obserwowanych">
                                ‚≠ê Dodaj
                            </button>
                        </td>
                    </tr>
                `;
            });

            modalHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Remove existing modal of ANY type before creating new one
            const existingModal = document.getElementById('bet-finder-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bet-finder-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Save to localStorage for persistence
            addOpenModal('least-corners', results, false, dateFrom, dateTo);
        }

        function showGoalAdvantageModal(results, dateFrom, dateTo) {
            currentModalResults = results;
            currentModalType = 'goal-advantage';

            // Calculate total analyzed matches
            const totalMatchesAnalyzed = results.reduce((sum, r) => sum + r.homeStats.matchCount + r.awayStats.matchCount, 0);
            const formattedDateFrom = new Date(dateFrom).toLocaleDateString('pl-PL');
            const formattedDateTo = new Date(dateTo).toLocaleDateString('pl-PL');

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeModal()" style="z-index: 9999;"></div>
                <div class="modal-dialog" style="max-width: 1400px; z-index: 10000;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div>
                            <h2>‚ö° TOP 10 - Przewaga bramek</h2>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">
                                üìÖ ${formattedDateFrom} - ${formattedDateTo} | üìä Analizowano ${totalMatchesAnalyzed} mecz√≥w
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                            <p style="margin: 0; color: #064e3b; font-size: 14px; line-height: 1.6;">
                                <strong>‚ÑπÔ∏è O czym jest ten modal:</strong><br>
                                Znajduje mecze gdzie jedna dru≈ºyna du≈ºo strzela, a druga du≈ºo traci. 
                                Wysoki wynik przewagi wskazuje na idealny moment na zak≈Çad - silna forma ofensywna spotyka siƒô ze s≈ÇabƒÖ defensywƒÖ.
                            </p>
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Data</th>
                                    <th>Liga</th>
                                    <th>Gospodarze</th>
                                    <th>Go≈õcie</th>
                                    <th>Silna dru≈ºyna</th>
                                    <th>≈ör. strzela</th>
                                    <th>S≈Çaba dru≈ºyna</th>
                                    <th>≈ör. traci</th>
                                    <th>Wynik przewagi</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                // Escape data for onclick attribute
                const resultData = JSON.stringify(result).replace(/"/g, '&quot;');

                // Determine which team is strong and weak
                const advantageIcon = result.advantageType === 'home' ? 'üè†' : '‚úàÔ∏è';

                modalHTML += `
                    <tr>
                        <td style="font-weight: 700; color: #10b981;">${index + 1}</td>
                        <td>${new Date(result.date).toLocaleDateString('pl-PL')}</td>
                        <td style="font-size: 12px; color: #666;">${result.league}</td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.homeTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.homeTeam}
                            </a>
                        </td>
                        <td style="font-weight: 600;">
                            <a href="#" class="team-link" onclick="openTeamStats('${result.awayTeam.replace(/'/g, "\\'")}'); return false;">
                                ${result.awayTeam}
                            </a>
                        </td>
                        <td style="font-weight: 700; color: #10b981;">
                            ${advantageIcon} ${result.strongTeam}
                        </td>
                        <td style="font-weight: 600; color: #059669;">
                            ${result.strongTeamScored}
                        </td>
                        <td style="font-weight: 600; color: #dc2626;">
                            ${result.weakTeam}
                        </td>
                        <td style="font-weight: 600; color: #991b1b;">
                            ${result.weakTeamConceded}
                        </td>
                        <td style="font-weight: 700; font-size: 18px; color: #10b981; cursor: pointer; text-decoration: underline;" 
                            onclick='showMatchDetailsModal(${resultData})' 
                            title="Kliknij aby zobaczyƒá szczeg√≥≈Çy mecz√≥w">
                            ${result.advantageScore}
                        </td>
                        <td>
                            <button onclick='addToWatchedMatches(${resultData}, "Przewaga bramek")' 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;" 
                                    title="Dodaj do obserwowanych">
                                ‚≠ê Dodaj
                            </button>
                        </td>
                    </tr>
                `;
            });

            modalHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Remove existing modal of ANY type before creating new one
            const existingModal = document.getElementById('bet-finder-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'bet-finder-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            addOpenModal('goal-advantage', results, false, dateFrom, dateTo);
        }

        // Track multiple minimized modals
        let minimizedModals = new Map(); // modalId -> { title, results }
        let minimizedMatchModals = new Map(); // modalId -> { match details data }

        // Minimized match cards persistence
        function saveMinimizedMatchCards() {
            const cardsData = Array.from(minimizedMatchModals.entries()).map(([id, data]) => ({
                id,
                data
            }));
            localStorage.setItem('minimizedMatchCards', JSON.stringify(cardsData));
        }

        function loadMinimizedMatchCards() {
            const saved = localStorage.getItem('minimizedMatchCards');
            if (saved) {
                try {
                    const cardsData = JSON.parse(saved);
                    cardsData.forEach(({ id, data }) => {
                        minimizedMatchModals.set(id, data);

                        // Recreate the minimized card
                        const miniCardId = `minimized-match-card-${id}`;
                        if (!document.getElementById(miniCardId)) {
                            const miniCard = document.createElement('div');
                            miniCard.id = miniCardId;
                            miniCard.className = 'minimized-match-card';
                            miniCard.innerHTML = `
                                <div class="minimized-card-content" onclick="restoreMatchDetailsModal('${id}')">
                                    <span class="minimized-card-icon">üìä</span>
                                    <span class="minimized-card-text">${data.homeTeam} vs ${data.awayTeam}</span>
                                </div>
                                <button class="minimized-card-close" onclick="closeMatchDetailsCompletely(event, '${id}')">√ó</button>
                            `;
                            document.body.appendChild(miniCard);
                        }
                    });
                    repositionMinimizedMatchCards();
                } catch (e) {
                    console.error('Error loading minimized match cards:', e);
                }
            }
        }

        // Open modals management (persistent across page reloads)
        let openModals = [];

        function loadOpenModals() {
            const saved = localStorage.getItem('openModals');
            if (saved) {
                try {
                    openModals = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading open modals:', e);
                    openModals = [];
                }
            }
        }

        function saveOpenModals() {
            localStorage.setItem('openModals', JSON.stringify(openModals));
        }

        function addOpenModal(modalType, results, isMinimized = false, dateFrom = null, dateTo = null) {
            // Remove existing modal of same type
            openModals = openModals.filter(m => m.type !== modalType);

            // Add new modal
            openModals.push({
                type: modalType,
                results: results,
                isMinimized: isMinimized,
                dateFrom: dateFrom,
                dateTo: dateTo,
                timestamp: new Date().toISOString()
            });

            saveOpenModals();
        }

        function updateModalMinimizedState(modalType, isMinimized) {
            const modal = openModals.find(m => m.type === modalType);
            if (modal) {
                modal.isMinimized = isMinimized;
                saveOpenModals();
            }
        }

        function removeOpenModal(modalType) {
            openModals = openModals.filter(m => m.type !== modalType);
            saveOpenModals();
        }

        function restoreOpenModals() {
            loadOpenModals();

            // Restore each open modal
            openModals.forEach(modal => {
                if (modal.results && modal.results.length > 0) {
                    // Show the modal first
                    switch (modal.type) {
                        case 'most-goals':
                            showMostGoalsModal(modal.results, modal.dateFrom, modal.dateTo);
                            break;
                        case 'least-goals':
                            showLeastGoalsModal(modal.results, modal.dateFrom, modal.dateTo);
                            break;
                        case 'goal-advantage':
                            showGoalAdvantageModal(modal.results, modal.dateFrom, modal.dateTo);
                            break;
                        case 'handicap-15':
                            showHandicap15Modal(modal.results, modal.dateFrom, modal.dateTo);
                            break;
                        case 'most-corners':
                            showMostCornersModal(modal.results, modal.dateFrom, modal.dateTo);
                            break;
                        case 'least-corners':
                            showLeastCornersModal(modal.results, modal.dateFrom, modal.dateTo);
                            break;
                    }

                    // If it was minimized, minimize it immediately after showing
                    if (modal.isMinimized) {
                        setTimeout(() => {
                            minimizeModal();
                        }, 50);
                    }
                }
            });
        }

        // Watched matches management
        let watchedMatches = [];

        function loadWatchedMatches() {
            const saved = localStorage.getItem('watchedMatches');
            if (saved) {
                try {
                    watchedMatches = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading watched matches:', e);
                    watchedMatches = [];
                }
            }
        }

        function saveWatchedMatches() {
            localStorage.setItem('watchedMatches', JSON.stringify(watchedMatches));
        }

        function addToWatchedMatches(match, searchType) {
            const matchId = `${match.homeTeam}-${match.awayTeam}-${match.date}-${match.league}`;

            // Check if already exists
            const exists = watchedMatches.some(m =>
                m.homeTeam === match.homeTeam &&
                m.awayTeam === match.awayTeam &&
                m.date === match.date &&
                m.league === match.league
            );

            if (exists) {
                showToast('Ten mecz jest ju≈º w obserwowanych', 'warning');
                return false;
            }

            // Add match with all data
            watchedMatches.push({
                id: matchId,
                date: match.date,
                league: match.league,
                country: match.country || '',
                homeTeam: match.homeTeam,
                awayTeam: match.awayTeam,
                searchType: searchType,
                stats: match, // Store all stats
                odds: '', // Empty by default, user can edit
                note: '', // Empty by default, user can add
                addedAt: new Date().toISOString()
            });

            saveWatchedMatches();
            showToast('Mecz dodany do obserwowanych', 'success');

            // Update watched matches modal if open
            updateWatchedMatchesModal();

            return true;
        }

        function removeFromWatchedMatches(matchId) {
            watchedMatches = watchedMatches.filter(m => m.id !== matchId);
            saveWatchedMatches();
            showToast('Mecz usuniƒôty z obserwowanych', 'info');
            updateWatchedMatchesModal();
        }

        function updateWatchedMatchesModal() {
            const modal = document.getElementById('watched-matches-modal');
            if (modal) {
                showWatchedMatchesModal();
            }
        }

        function minimizeModal() {
            const modal = document.getElementById('bet-finder-modal');
            if (!modal) return;

            // Get modal title to create unique ID
            const modalHeader = modal.querySelector('.modal-header h2');
            const modalTitle = modalHeader?.textContent || 'TOP 10';
            const modalId = modalTitle.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase(); // e.g., "top-10-najwi-cej-bramek"

            // Hide modal
            modal.style.display = 'none';

            // Store modal data
            minimizedModals.set(modalId, {
                title: modalTitle,
                results: currentModalResults
            });

            // Update minimized state in localStorage
            if (currentModalType) {
                updateModalMinimizedState(currentModalType, true);
            }

            // Create or update minimized card
            const miniCardId = `minimized-modal-card-${modalId}`;
            let miniCard = document.getElementById(miniCardId);

            if (!miniCard) {
                miniCard = document.createElement('div');
                miniCard.id = miniCardId;
                miniCard.className = 'minimized-card';
                miniCard.innerHTML = `
                    <div class="minimized-card-content" onclick="restoreModal('${modalId}')">
                        <span class="minimized-card-icon">‚öΩ</span>
                        <span class="minimized-card-text">${modalTitle}</span>
                    </div>
                    <button class="minimized-card-close" onclick="closeModalCompletely(event, '${modalId}')">√ó</button>
                `;
                document.body.appendChild(miniCard);
            } else {
                miniCard.style.display = 'flex';
            }

            // Reposition all minimized cards
            repositionMinimizedCards();
        }

        function repositionMinimizedCards() {
            // Only reposition TOP 10 modals (right side) - exclude left-side match cards
            const otherCards = Array.from(document.querySelectorAll('.minimized-card[style*="display: flex"], .minimized-card:not([style*="display: none"])'));

            // Position cards starting from bottom on the right side
            otherCards.forEach((card, index) => {
                card.style.bottom = `${20 + (index * 70)}px`;
            });
        }

        function restoreModal(modalId) {
            if (!modalId) {
                // Legacy support for old single modal
                modalId = Array.from(minimizedModals.keys())[0];
            }

            const miniCardId = `minimized-modal-card-${modalId}`;
            const miniCard = document.getElementById(miniCardId);
            if (miniCard) {
                miniCard.style.display = 'none';
            }

            // Get modal data
            const modalData = minimizedModals.get(modalId);
            if (modalData && modalData.results) {
                // Recreate the modal based on title
                if (modalData.title.includes('Najmniej bramek')) {
                    showLeastGoalsModal(modalData.results);
                    updateModalMinimizedState('least-goals', false);
                } else if (modalData.title.includes('Najmniej ro≈ºnych')) {
                    showLeastCornersModal(modalData.results);
                    updateModalMinimizedState('least-corners', false);
                } else if (modalData.title.includes('Przewaga')) {
                    showGoalAdvantageModal(modalData.results);
                    updateModalMinimizedState('goal-advantage', false);
                } else if (modalData.title.includes('Handicap')) {
                    showHandicap15Modal(modalData.results);
                    updateModalMinimizedState('handicap-15', false);
                } else if (modalData.title.includes('ro≈ºnych')) {
                    showMostCornersModal(modalData.results);
                    updateModalMinimizedState('most-corners', false);
                } else {
                    showMostGoalsModal(modalData.results);
                    updateModalMinimizedState('most-goals', false);
                }
            }

            repositionMinimizedCards();
        }

        function showWatchedMatchesModal() {
            // Sort by match date
            const sortedMatches = [...watchedMatches].sort((a, b) => new Date(a.date) - new Date(b.date));

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeWatchedMatchesModal()"></div>
                <div class="modal-dialog">
                    <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <h2>‚≠ê Obserwowane mecze (${watchedMatches.length})</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeWatchedMatchesModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeWatchedMatchesModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body" style="background: #f9fafb; padding: 25px;">
            `;

            if (sortedMatches.length === 0) {
                modalHTML += `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚≠ê</div>
                        <p style="font-size: 16px; margin: 0;">Brak obserwowanych mecz√≥w</p>
                        <p style="font-size: 14px; margin-top: 10px;">U≈ºyj przycisku "Dodaj do obserwowanych" w wynikach wyszukiwania</p>
                    </div>
                `;
            } else {
                modalHTML += `
                    <table class="results-table" style="background: white; border: 2px solid #e5e7eb;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Data</th>
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Liga</th>
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Mecz</th>
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Typ</th>
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Statystyki</th>
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Kurs</th>
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Notatka</th>
                                <th style="padding: 15px 12px; border-bottom: 2px solid #ef4444;">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedMatches.forEach((match, index) => {
                    const stats = match.stats;
                    let statsText = '';
                    const escapedMatchData = JSON.stringify(stats).replace(/"/g, '&quot;');
                    const countryCode = match.country ? match.country.substring(0, 3).toUpperCase() : '';

                    // Format statistics based on search type
                    if (match.searchType.includes('bramek')) {
                        if (stats.averageGoals) {
                            statsText = `≈ör.: ${stats.averageGoals}`;
                        }
                    } else if (match.searchType.includes('Przewaga')) {
                        if (stats.advantageScore) {
                            statsText = `${stats.advantageScore}`;
                        }
                    } else if (match.searchType.includes('Handicap')) {
                        if (stats.handicapScore) {
                            statsText = `${stats.handicapScore}`;
                        }
                    } else if (match.searchType.includes('ro≈ºnych')) {
                        if (stats.averageCorners) {
                            statsText = `≈ör.: ${stats.averageCorners}`;
                        }
                    }

                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f9fafb';
                    const hasNote = match.note && match.note.trim();

                    modalHTML += `
                        <tr style="background: ${rowBg}; border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 12px; font-weight: 600; color: #374151;">${new Date(match.date).toLocaleDateString('pl-PL')}</td>
                            <td style="padding: 12px; font-size: 13px; color: #6b7280;">
                                ${match.league}${countryCode ? ` <span style="color: #9ca3af;">(${countryCode})</span>` : ''}
                            </td>
                            <td style="padding: 12px;">
                                <a href="#" class="team-link" onclick="openTeamStats('${match.homeTeam.replace(/'/g, "\\'")}'); return false;">${match.homeTeam}</a>
                                <span style="color: #6b7280;"> vs </span>
                                <a href="#" class="team-link" onclick="openTeamStats('${match.awayTeam.replace(/'/g, "\\'")}'); return false;">${match.awayTeam}</a>
                            </td>
                            <td style="padding: 12px;">
                                <span style="background: #dbeafe; color: #1e40af; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">${match.searchType}</span>
                            </td>
                            <td style="padding: 12px; font-weight: 700; color: #ef4444; cursor: pointer; text-decoration: underline;" 
                                onclick='showMatchDetailsModal(${escapedMatchData});'
                                title="Kliknij aby zobaczyƒá szczeg√≥≈Çy">
                                ${statsText}
                            </td>
                            <td style="padding: 12px;">
                                <input type="number" step="0.01" min="1" placeholder="np. 1.85" 
                                    value="${match.odds || ''}"
                                    onchange="updateWatchedMatchOdds('${match.id}', this.value)"
                                    style="width: 80px; padding: 6px 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px; text-align: center; font-weight: 600;"
                                    onfocus="this.style.borderColor='#ef4444'"
                                    onblur="this.style.borderColor='#e5e7eb'">
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                ${hasNote ? `
                                    <div style="position: relative; display: inline-block;">
                                        <span class="note-icon" style="cursor: pointer; font-size: 20px;">üìã</span>
                                        <div class="note-tooltip" style="display: none; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 10px 15px; border-radius: 8px; min-width: 200px; max-width: 300px; white-space: pre-wrap; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.3); font-size: 13px; line-height: 1.5;">
                                            ${match.note.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                            <div style="position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #1f2937;"></div>
                                        </div>
                                    </div>
                                    <button onclick="editWatchedMatchNote('${match.id}')" 
                                        style="background: transparent; border: none; cursor: pointer; font-size: 16px; margin-left: 5px;" 
                                        title="Edytuj notatkƒô">‚úèÔ∏è</button>
                                ` : `
                                    <button onclick="editWatchedMatchNote('${match.id}')" 
                                        style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"
                                        onmouseover="this.style.background='#059669'" 
                                        onmouseout="this.style.background='#10b981'">
                                        üìù Dodaj
                                    </button>
                                `}
                            </td>
                            <td style="padding: 12px;">
                                <button 
                                    onclick="removeFromWatchedMatches('${match.id}')" 
                                    style="background: #dc2626; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap;"
                                    onmouseover="this.style.background='#b91c1c'" 
                                    onmouseout="this.style.background='#dc2626'">
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </td>
                        </tr>
                    `;
                });

                modalHTML += `
                        </tbody>
                    </table>
                `;
            }

            modalHTML += `
                    </div>
                </div>
            `;

            // Remove existing watched matches modal
            const existingModal = document.getElementById('watched-matches-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'watched-matches-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Scroll to modal after it's added to DOM
            setTimeout(() => {
                const modalDialog = modalContainer.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);

            // Add hover listeners for note tooltips
            setTimeout(() => {
                document.querySelectorAll('.note-icon').forEach(icon => {
                    const tooltip = icon.nextElementSibling;
                    icon.addEventListener('mouseenter', () => tooltip.style.display = 'block');
                    icon.addEventListener('mouseleave', () => tooltip.style.display = 'none');
                });
            }, 100);
        }

        function minimizeWatchedMatchesModal() {
            const modal = document.getElementById('watched-matches-modal');
            if (modal) {
                modal.remove();
            }

            // Always show the watched matches minimized card
            ensureWatchedMatchesCard();
        }

        function closeWatchedMatchesModal() {
            const modal = document.getElementById('watched-matches-modal');
            if (modal) {
                modal.remove();
            }
        }

        function updateWatchedMatchOdds(matchId, odds) {
            const match = watchedMatches.find(m => m.id === matchId);
            if (match) {
                match.odds = odds;
                saveWatchedMatches();
                ensureWatchedMatchesCard();
            }
        }

        function editWatchedMatchNote(matchId) {
            const match = watchedMatches.find(m => m.id === matchId);
            if (!match) return;

            const currentNote = match.note || '';
            const newNote = prompt('Wprowad≈∫ notatkƒô dla tego meczu:', currentNote);

            if (newNote !== null) { // User didn't cancel
                match.note = newNote.trim();
                saveWatchedMatches();
                showWatchedMatchesModal(); // Refresh modal
                showToast('Notatka zaktualizowana', 'success');
            }
        }

        function restoreWatchedMatchesModal() {
            const miniCard = document.getElementById('minimized-watched-matches-card');
            if (miniCard) {
                miniCard.style.display = 'flex';
            }
            showWatchedMatchesModal();
        }

        function ensureWatchedMatchesCard() {
            let miniCard = document.getElementById('minimized-watched-matches-card');

            if (!miniCard) {
                miniCard = document.createElement('div');
                miniCard.id = 'minimized-watched-matches-card';
                miniCard.className = 'minimized-match-card'; // Use left-side style
                miniCard.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                miniCard.innerHTML = `
                    <div class="minimized-card-content" onclick="restoreWatchedMatchesModal()">
                        <span class="minimized-card-icon">‚≠ê</span>
                        <span class="minimized-card-text">Obserwowane (${watchedMatches.length})</span>
                    </div>
                `;
                document.body.appendChild(miniCard);
            } else {
                // Update count
                const textSpan = miniCard.querySelector('.minimized-card-text');
                if (textSpan) {
                    textSpan.textContent = `Obserwowane (${watchedMatches.length})`;
                }
                miniCard.style.display = 'flex';
            }

            repositionMinimizedMatchCards(); // Use left-side positioning
        }

        function closeModal() {
            const modal = document.getElementById('bet-finder-modal');
            if (modal) {
                // Show confirmation dialog for TOP 10 modals
                const confirmed = confirm('Czy na pewno chcesz zamknƒÖƒá ten modal?');
                if (!confirmed) {
                    return; // User cancelled, don't close
                }

                modal.remove();

                // Remove from localStorage if it's a TOP 10 modal
                if (currentModalType) {
                    removeOpenModal(currentModalType);
                }
            }

            // DON'T remove minimized cards - they should stay!
            // Only clear currentModalResults for the active modal
            currentModalResults = null;
            currentModalType = null;
        }

        function closeModalCompletely(event, modalId) {
            event.stopPropagation();

            if (modalId) {
                // Close specific minimized card
                const miniCardId = `minimized-modal-card-${modalId}`;
                const miniCard = document.getElementById(miniCardId);
                if (miniCard) {
                    miniCard.remove();
                }
                minimizedModals.delete(modalId);
                repositionMinimizedCards();
            } else {
                // Close main modal (when clicking X on the open modal)
                closeModal();
            }
        }

        function openTeamStats(teamName) {
            // Close/minimize current modal
            minimizeModal();

            // Switch to database tab
            switchTab('database');

            // Wait for tab to load, then set team filter
            setTimeout(() => {
                // Scroll to database filters
                const databaseFilters = document.querySelector('.database-filters');
                if (databaseFilters) {
                    databaseFilters.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                // Set search input value
                const teamSearchInput = document.getElementById('filter-team-search');
                if (teamSearchInput) {
                    teamSearchInput.value = teamName;
                    // Trigger filtering to show matching teams
                    filterSelectOptions('filter-team', 'filter-team-search');
                }

                // Set the select value
                const teamSelect = document.getElementById('filter-team');
                if (teamSelect) {
                    teamSelect.value = teamName;

                    // Trigger search
                    applyFilters();
                }
            }, 100);
        }

        let currentMatchDetailsData = null; // Store current match details data

        function showMatchDetailsModal(result) {
            currentMatchDetailsData = result; // Store for minimize/restore

            // Separate matches by team
            const homeTeamMatches = result.homeStats.matches;
            const awayTeamMatches = result.awayStats.matches;

            // Sort by date descending
            homeTeamMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
            awayTeamMatches.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Check modal type
            const isAdvantageModal = result.hasOwnProperty('advantageType');
            const isHandicapModal = result.hasOwnProperty('handicapType');
            const isCornersModal = result.hasOwnProperty('averageCorners') && !result.hasOwnProperty('averageGoals');

            // Calculate combined average OR use advantage-specific averages
            const averageGoals = result.averageGoals;
            const averageCorners = result.averageCorners;

            // Function to generate table HTML
            function generateMatchTable(matches, teamName, isStrongTeam, avgThreshold) {
                let avgInfo = '';
                if (isCornersModal) {
                    avgInfo = `≈õr. ro≈ºnych ${matches.length > 0 ? (matches.reduce((sum, m) => sum + m.teamCorners, 0) / matches.length).toFixed(2) : 0}`;
                } else if (isHandicapModal) {
                    const totalWins = matches.filter(m => m.isWinBy2Plus).length;
                    const totalLosses = matches.filter(m => m.isLossBy2Plus).length;
                    avgInfo = isStrongTeam
                        ? `wygrane ‚â•2: ${totalWins}`
                        : `pora≈ºki ‚â•2: ${totalLosses}`;
                } else if (isAdvantageModal) {
                    avgInfo = isStrongTeam
                        ? `≈õr. strzela ${avgThreshold}`
                        : `≈õr. traci ${avgThreshold}`;
                } else {
                    avgInfo = `≈õr. ${matches.length > 0 ? (matches.reduce((sum, m) => sum + m.totalGoals, 0) / matches.length).toFixed(2) : 0}`;
                }

                let tableHTML = `
                    <div style="flex: 1; min-width: 0;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #1f2937; font-weight: 700; text-align: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            ${teamName} (${matches.length} mecz√≥w, ${avgInfo})
                        </h3>
                        <table class="matches-table" style="font-size: 13px;">
                            <thead>
                                <tr>
                                    <th style="padding: 8px;">Data</th>
                                    <th style="padding: 8px;">Mecz</th>
                                    <th style="padding: 8px;">Wynik</th>
                                    <th style="padding: 8px; text-align: center;">
                                        ${isCornersModal ? '‚öΩ Ro≈ºne' : (isHandicapModal ? (isStrongTeam ? 'üéØ R√≥≈ºnica' : 'üíî R√≥≈ºnica') : (isAdvantageModal ? (isStrongTeam ? '‚öΩ Strzela' : 'üö´ Traci') : 'Œ£'))}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                matches.forEach(match => {
                    let valueToCheck, isAboveAverage, rowColor, textColor, isUnexpectedResult = false;

                    if (isCornersModal) {
                        // For corners modal: check team corners against average
                        valueToCheck = match.teamCorners;
                        isAboveAverage = valueToCheck >= avgThreshold;
                    } else if (isHandicapModal) {
                        // For handicap modal: check goal difference
                        const isHome = match.isHome;
                        const goalsScored = isHome ? match.homeGoals : match.awayGoals;
                        const goalsConceded = isHome ? match.awayGoals : match.homeGoals;
                        const actualDifference = goalsScored - goalsConceded;

                        if (isStrongTeam) {
                            // Strong team: highlight wins by 2+
                            valueToCheck = match.goalDifference;
                            isAboveAverage = match.isWinBy2Plus;
                            // UNEXPECTED: Strong team LOST (negative difference)
                            isUnexpectedResult = actualDifference < 0;
                        } else {
                            // Weak team: highlight losses by 2+
                            valueToCheck = match.goalDifference;
                            isAboveAverage = match.isLossBy2Plus;
                            // UNEXPECTED: Weak team WON (positive difference)
                            isUnexpectedResult = actualDifference > 0;
                        }
                    } else if (isAdvantageModal) {
                        // For advantage modal: check scored/conceded against respective average
                        const isHome = match.isHome;
                        if (isStrongTeam) {
                            // Strong team: check goals SCORED
                            valueToCheck = isHome ? match.homeGoals : match.awayGoals;
                        } else {
                            // Weak team: check goals CONCEDED
                            valueToCheck = isHome ? match.awayGoals : match.homeGoals;
                        }
                        isAboveAverage = valueToCheck >= avgThreshold;
                    } else {
                        // For normal modals: check total goals
                        valueToCheck = match.totalGoals;
                        isAboveAverage = valueToCheck >= averageGoals;
                    }

                    // Check for unexpected results (only for handicap modal)
                    if (isHandicapModal && isUnexpectedResult) {
                        // STRONG RED for unexpected results
                        rowColor = '#dc2626';
                        textColor = '#ffffff';
                    } else {
                        rowColor = isAboveAverage ? '#d1fae5' : '#fee2e2';
                        textColor = isAboveAverage ? '#065f46' : '#991b1b';
                    }

                    const unexpectedIcon = (isHandicapModal && isUnexpectedResult) ? '‚ö†Ô∏è ' : '';

                    tableHTML += `
                        <tr style="background: ${rowColor};">
                            <td style="color: ${textColor}; padding: 8px; font-size: 12px;">${new Date(match.date).toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' })}</td>
                            <td style="color: ${textColor}; padding: 8px; font-size: 12px;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <span style="font-weight: ${match.isHome ? '600' : 'normal'};">${unexpectedIcon}${match.homeTeam}</span>
                                    <span style="font-weight: ${!match.isHome ? '600' : 'normal'};">${unexpectedIcon}${match.awayTeam}</span>
                                </div>
                            </td>
                            <td style="font-weight: 700; color: ${textColor}; padding: 8px;">${match.homeGoals}:${match.awayGoals}</td>
                            <td style="text-align: center; font-weight: 700; font-size: 16px; color: ${textColor}; padding: 8px;">
                                ${valueToCheck}
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                return tableHTML;
            }

            // Determine legend text and table parameters
            let legendText, infoText, leftTableParams, rightTableParams;

            if (isCornersModal) {
                const homeAvg = result.homeAvgCorners;
                const awayAvg = result.awayAvgCorners;

                legendText = `
                    <strong>Legenda:</strong> 
                    <span style="color: #059669; font-weight: 600;">üü¢ Zielony</span> = ro≈ºne ‚â• ≈õredniej dru≈ºyny | 
                    <span style="color: #dc2626; font-weight: 600;">üî¥ Czerwony</span> = ro≈ºne &lt; ≈õredniej dru≈ºyny
                `;

                infoText = `
                    <div>üìÖ Data meczu: ${new Date(result.date).toLocaleDateString('pl-PL')}</div>
                    <div>üèÜ Liga: ${result.league}</div>
                    <div>‚öΩ ≈ÅƒÖczna ≈õrednia ro≈ºnych: <strong style="font-size: 24px;">${averageCorners}</strong></div>
                    <div style="margin-top: 10px; font-size: 13px;">
                        <div style="color: #8b5cf6;">${result.homeTeam}: ≈õr. ${homeAvg} ro≈ºnych (${result.homeStats.cornersMatchCount} mecz√≥w z danymi)</div>
                        <div style="color: #6d28d9;">${result.awayTeam}: ≈õr. ${awayAvg} ro≈ºnych (${result.awayStats.cornersMatchCount} mecz√≥w z danymi)</div>
                    </div>
                `;

                leftTableParams = { isStrong: false, avg: homeAvg };
                rightTableParams = { isStrong: false, avg: awayAvg };
            } else if (isHandicapModal) {
                const isHomeStrong = result.strongTeam === result.homeTeam;
                const strongTeamWins = result.strongTeamWins;
                const strongTeamPct = result.strongTeamWinsPct;
                const weakTeamLosses = result.weakTeamLosses;
                const weakTeamPct = result.weakTeamLossesPct;

                legendText = `
                    <strong>Legenda:</strong> 
                    <span style="color: #059669; font-weight: 600;">üü¢ Zielony</span> = wygrana/pora≈ºka r√≥≈ºnicƒÖ ‚â•2 gole | 
                    <span style="color: #dc2626; font-weight: 600;">üî¥ Jasny czerwony</span> = r√≥≈ºnica &lt;2 gole | 
                    <span style="color: #dc2626; font-weight: 700; background: #dc2626; color: white; padding: 2px 6px; border-radius: 3px;">‚ö†Ô∏è MOCNY CZERWONY</span> = NIESPODZIANKA (silna przegra≈Ça / s≈Çaba wygra≈Ça)
                `;

                infoText = `
                    <div>üìÖ Data meczu: ${new Date(result.date).toLocaleDateString('pl-PL')}</div>
                    <div>üèÜ Liga: ${result.league}</div>
                    <div>üéØ Wynik Handicap -1.5: <strong style="font-size: 24px;">${result.handicapScore}</strong></div>
                    <div style="margin-top: 10px; font-size: 13px;">
                        <div style="color: #f59e0b;">üí™ Silna: ${result.strongTeam} (wygrane ‚â•2: ${strongTeamWins}, ${strongTeamPct}%)</div>
                        <div style="color: #dc2626;">üõ°Ô∏è S≈Çaba: ${result.weakTeam} (pora≈ºki ‚â•2: ${weakTeamLosses}, ${weakTeamPct}%)</div>
                    </div>
                `;

                if (isHomeStrong) {
                    leftTableParams = { isStrong: true, avg: 2 };
                    rightTableParams = { isStrong: false, avg: 2 };
                } else {
                    leftTableParams = { isStrong: false, avg: 2 };
                    rightTableParams = { isStrong: true, avg: 2 };
                }
            } else if (isAdvantageModal) {
                const isHomeStrong = result.strongTeam === result.homeTeam;
                const strongTeamAvg = result.strongTeamScored;
                const weakTeamAvg = result.weakTeamConceded;

                legendText = `
                    <strong>Legenda:</strong> 
                    <span style="color: #059669; font-weight: 600;">üü¢ Zielony</span> = warto≈õƒá ‚â• ≈õredniej | 
                    <span style="color: #dc2626; font-weight: 600;">üî¥ Czerwony</span> = warto≈õƒá &lt; ≈õredniej
                `;

                infoText = `
                    <div>üìÖ Data meczu: ${new Date(result.date).toLocaleDateString('pl-PL')}</div>
                    <div>üèÜ Liga: ${result.league}</div>
                    <div>‚ö° Wynik przewagi: <strong style="font-size: 24px;">${result.advantageScore}</strong></div>
                    <div style="margin-top: 10px; font-size: 13px;">
                        <div style="color: #10b981;">üí™ Silna: ${result.strongTeam} (≈õr. strzela ${strongTeamAvg})</div>
                        <div style="color: #dc2626;">üõ°Ô∏è S≈Çaba: ${result.weakTeam} (≈õr. traci ${weakTeamAvg})</div>
                    </div>
                `;

                if (isHomeStrong) {
                    leftTableParams = { isStrong: true, avg: strongTeamAvg };
                    rightTableParams = { isStrong: false, avg: weakTeamAvg };
                } else {
                    leftTableParams = { isStrong: false, avg: weakTeamAvg };
                    rightTableParams = { isStrong: true, avg: strongTeamAvg };
                }
            } else {
                legendText = `
                    <strong>Legenda:</strong> 
                    <span style="color: #059669; font-weight: 600;">üü¢ Zielony</span> = bramki ‚â• ≈õredniej (${averageGoals}) | 
                    <span style="color: #dc2626; font-weight: 600;">üî¥ Czerwony</span> = bramki &lt; ≈õredniej
                `;

                infoText = `
                    <div>üìÖ Data meczu: ${new Date(result.date).toLocaleDateString('pl-PL')}</div>
                    <div>üèÜ Liga: ${result.league}</div>
                    <div>‚öΩ ≈ÅƒÖczna ≈õrednia bramek: <strong style="font-size: 24px;">${averageGoals}</strong></div>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                        ${result.homeTeam}: ${result.homeStats.matchCount} mecz√≥w (≈õr. ${result.homeStats.avgGoals}) | 
                        ${result.awayTeam}: ${result.awayStats.matchCount} mecz√≥w (≈õr. ${result.awayStats.avgGoals})
                    </div>
                `;

                leftTableParams = { isStrong: false, avg: averageGoals };
                rightTableParams = { isStrong: false, avg: averageGoals };
            }

            let modalHTML = `
                <div class="modal-backdrop" onclick="minimizeMatchDetailsModal()"></div>
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h2>üìä Szczeg√≥≈Çy mecz√≥w</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="modal-minimize" onclick="minimizeMatchDetailsModal()" title="Minimalizuj">‚àí</button>
                            <button class="modal-close" onclick="closeMatchDetailsModal()">√ó</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">${result.homeTeam} vs ${result.awayTeam}</h3>
                            <div style="font-size: 14px; opacity: 0.9;">
                                ${infoText}
                            </div>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 13px; color: #374151;">
                            ${legendText}
                        </div>

                        <div style="display: flex; gap: 20px; align-items: flex-start;">
                            ${generateMatchTable(homeTeamMatches, `üè† ${result.homeTeam}`, leftTableParams.isStrong, leftTableParams.avg)}
                            ${generateMatchTable(awayTeamMatches, `‚úàÔ∏è ${result.awayTeam}`, rightTableParams.isStrong, rightTableParams.avg)}
                        </div>

                        <div style="margin-top: 20px; text-align: center; color: #6b7280; font-size: 13px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            ≈ÅƒÖcznie: ${homeTeamMatches.length + awayTeamMatches.length} mecz√≥w
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('match-details-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalContainer = document.createElement('div');
            modalContainer.id = 'match-details-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Scroll to modal after it's added to DOM
            setTimeout(() => {
                const modalDialog = modalContainer.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        function minimizeMatchDetailsModal() {
            const modal = document.getElementById('match-details-modal');
            if (!currentMatchDetailsData) return;

            // Create unique ID from match data
            const matchId = `${currentMatchDetailsData.homeTeam}-${currentMatchDetailsData.awayTeam}-${currentMatchDetailsData.date}`
                .replace(/[^a-zA-Z0-9]/g, '-')
                .toLowerCase();

            // Check if minimized card already exists
            const miniCardId = `minimized-match-card-${matchId}`;
            const existingMiniCard = document.getElementById(miniCardId);

            if (existingMiniCard) {
                // Card already exists, just show it and remove modal
                existingMiniCard.style.display = 'flex';
                if (modal) {
                    modal.remove();
                }
                repositionMinimizedMatchCards();
                return;
            }

            // No modal to minimize
            if (!modal) return;

            // Remove modal
            modal.remove();

            // Store modal data
            minimizedMatchModals.set(matchId, currentMatchDetailsData);
            saveMinimizedMatchCards(); // Save to localStorage

            // Create minimized card (we already checked it doesn't exist above)
            let miniCard = document.createElement('div');
            miniCard.id = miniCardId;
            miniCard.className = 'minimized-match-card';
            miniCard.innerHTML = `
                <div class="minimized-card-content" onclick="restoreMatchDetailsModal('${matchId}')">
                    <span class="minimized-card-icon">üìä</span>
                    <span class="minimized-card-text">${currentMatchDetailsData.homeTeam} vs ${currentMatchDetailsData.awayTeam}</span>
                </div>
                <button class="minimized-card-close" onclick="closeMatchDetailsCompletely(event, '${matchId}')">√ó</button>
            `;
            document.body.appendChild(miniCard);

            // Reposition all minimized match cards
            repositionMinimizedMatchCards();
        }

        function repositionMinimizedMatchCards() {
            const matchCards = Array.from(document.querySelectorAll('.minimized-match-card[style*="display: flex"], .minimized-match-card:not([style*="display: none"])'));

            // Position cards vertically on the left side
            matchCards.forEach((card, index) => {
                card.style.bottom = `${20 + (index * 70)}px`; // Stack from bottom
            });
        }

        function restoreMatchDetailsModal(matchId) {
            const miniCardId = `minimized-match-card-${matchId}`;
            const miniCard = document.getElementById(miniCardId);
            if (miniCard) {
                miniCard.style.display = 'none';
            }

            // Get modal data
            const matchData = minimizedMatchModals.get(matchId);
            if (matchData) {
                showMatchDetailsModal(matchData);
            }

            repositionMinimizedMatchCards();
        }

        function closeMatchDetailsCompletely(event, matchId) {
            event.stopPropagation();

            const miniCardId = `minimized-match-card-${matchId}`;
            const miniCard = document.getElementById(miniCardId);
            if (miniCard) {
                miniCard.remove();
            }

            // Remove from map
            minimizedMatchModals.delete(matchId);
            saveMinimizedMatchCards(); // Save to localStorage
            repositionMinimizedMatchCards();
        }

        function closeMatchDetailsModal() {
            const modal = document.getElementById('match-details-modal');
            if (modal) {
                modal.remove();
            }
            currentMatchDetailsData = null;
        }

        // ===== BACKGROUND IMPORT FUNCTIONS =====
        let backgroundJobsInterval = null;
        let showHiddenJobs = false;

        function toggleHiddenJobs() {
            showHiddenJobs = !showHiddenJobs;
            const btn = document.getElementById('toggle-hidden-btn');

            if (showHiddenJobs) {
                btn.innerHTML = 'üëÅÔ∏è Poka≈º Aktywne';
                btn.style.background = '#f59e0b';
            } else {
                btn.innerHTML = 'üëÅÔ∏è Poka≈º Ukryte';
                btn.style.background = '#6b7280';
            }

            refreshBackgroundJobs();
        }

        async function showBackgroundImportDialog() {
            const modal = document.getElementById('background-import-modal');
            const leaguesList = document.getElementById('background-leagues-list');

            // Load leagues
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                let html = '';
                data.leagues.forEach(league => {
                    html += `
                        <label style="display: block; padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; transition: background 0.2s;"
                               onmouseover="this.style.background='#e0e0e0'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" value="${league.id}" class="background-league-checkbox" style="margin-right: 8px;">
                            <span style="font-weight: 600;">${league.name}</span>
                            <span style="color: #666; font-size: 12px;"> (${league.country})</span>
                        </label>
                    `;
                });

                leaguesList.innerHTML = html;

                // Set default dates (last 7 days)
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);

                document.getElementById('background-date-from').value = weekAgo.toISOString().split('T')[0];
                document.getElementById('background-date-to').value = today.toISOString().split('T')[0];

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading leagues:', error);
                alert('B≈ÇƒÖd podczas ≈Çadowania lig: ' + error.message);
            }
        }

        function closeBackgroundImportDialog() {
            document.getElementById('background-import-modal').style.display = 'none';
        }

        async function createBackgroundJob() {
            const checkboxes = document.querySelectorAll('.background-league-checkbox:checked');
            const leagueIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const dateFrom = document.getElementById('background-date-from').value;
            const dateTo = document.getElementById('background-date-to').value;

            if (leagueIds.length === 0) {
                alert('Wybierz przynajmniej jednƒÖ ligƒô');
                return;
            }

            if (!dateFrom || !dateTo) {
                alert('Wybierz zakres dat');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                alert('Data poczƒÖtkowa nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º ko≈Ñcowa');
                return;
            }

            try {
                const response = await fetch('/api/import-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leagueIds, dateFrom, dateTo })
                });

                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd tworzenia zadania');
                }

                const result = await response.json();

                closeBackgroundImportDialog();
                alert(`‚úÖ Zadanie utworzone! ID: ${result.jobId}\n\nImport rozpocznie siƒô automatycznie w ciƒÖgu 60 sekund.`);

                // Refresh jobs list
                await refreshBackgroundJobs();

                // Start auto-refresh if not already running
                if (!backgroundJobsInterval) {
                    backgroundJobsInterval = setInterval(refreshBackgroundJobs, 5000);
                }
            } catch (error) {
                console.error('Error creating job:', error);
                alert('B≈ÇƒÖd podczas tworzenia zadania: ' + error.message);
            }
        }

        async function refreshBackgroundJobs() {
            const container = document.getElementById('background-jobs-list');

            try {
                const url = showHiddenJobs ? '/api/import-jobs?showHidden=true' : '/api/import-jobs';
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd pobierania zada≈Ñ');
                }

                const jobs = await response.json();

                if (jobs.length === 0) {
                    const message = showHiddenJobs
                        ? 'Brak ukrytych zada≈Ñ.'
                        : 'Brak zada≈Ñ. Kliknij "Nowe Zadanie" aby utworzyƒá pierwsze.';
                    container.innerHTML = `<p style="color: #666; text-align: center; padding: 20px;">${message}</p>`;

                    // Stop auto-refresh if no jobs
                    if (backgroundJobsInterval) {
                        clearInterval(backgroundJobsInterval);
                        backgroundJobsInterval = null;
                    }
                    return;
                }

                let html = '';
                let hasActiveJobs = false;

                jobs.forEach(job => {
                    const createdAt = new Date(job.created_at).toLocaleString('pl-PL');
                    const dateFrom = new Date(job.date_from).toLocaleDateString('pl-PL');
                    const dateTo = new Date(job.date_to).toLocaleDateString('pl-PL');
                    const leagues = typeof job.leagues === 'string' ? JSON.parse(job.leagues) : job.leagues;
                    const progress = job.progress ? (typeof job.progress === 'string' ? JSON.parse(job.progress) : job.progress) : {};

                    const completedLeagues = progress.completed_leagues || [];
                    const totalLeagues = leagues.length;
                    const progressPercent = totalLeagues > 0 ? Math.round((completedLeagues.length / totalLeagues) * 100) : 0;

                    const statusClass = `job-status-${job.status}`;
                    const statusText = {
                        'pending': 'Oczekuje',
                        'running': 'W trakcie',
                        'paused': 'Wstrzymane',
                        'completed': 'Zako≈Ñczone',
                        'failed': 'B≈ÇƒÖd',
                        'rate_limited': 'Limit API'
                    }[job.status] || job.status;

                    if (job.status === 'running' || job.status === 'rate_limited') {
                        hasActiveJobs = true;
                    }

                    html += `
                        <div class="job-card">
                            <div class="job-header">
                                <div class="job-title">Zadanie #${job.id}</div>
                                <span class="job-status-badge ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="job-info">
                                <div>üìÖ Utworzone: ${createdAt}</div>
                                <div>üóìÔ∏è Zakres: ${dateFrom} ‚Üí ${dateTo}</div>
                                <div>üèÜ Ligi: ${totalLeagues}</div>
                                <div>‚úÖ Uko≈Ñczone ligi: ${completedLeagues.length}/${totalLeagues}</div>
                            </div>
                            
                            ${job.status === 'running' || job.status === 'paused' || job.status === 'rate_limited' ? `
                                <div class="job-progress">
                                    <div>Postƒôp: ${progressPercent}%</div>
                                    <div class="job-progress-bar-container">
                                        <div class="job-progress-bar" style="width: ${progressPercent}%">
                                            ${progressPercent}%
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${job.error_message ? `
                                <div style="background: #ffebee; border-left: 4px solid #d32f2f; padding: 10px; margin-top: 10px; border-radius: 4px;">
                                    <strong>B≈ÇƒÖd:</strong> ${job.error_message}
                                </div>
                            ` : ''}
                            
                            ${job.status === 'rate_limited' && job.rate_limit_reset_at ? `
                                <div style="background: #fff3e0; border-left: 4px solid #f57c00; padding: 10px; margin-top: 10px; border-radius: 4px;">
                                    ‚è±Ô∏è Wznowienie po: ${new Date(job.rate_limit_reset_at).toLocaleString('pl-PL')}
                                </div>
                            ` : ''}
                            
                            <div class="job-actions">
                                ${job.status === 'running' || job.status === 'pending' ? `
                                    <button class="job-action-btn" onclick="pauseJob(${job.id})">‚è∏Ô∏è Wstrzymaj</button>
                                ` : ''}
                                ${job.status === 'rate_limited' ? `
                                    <button class="job-action-btn" style="background: #f57c00; color: white;" onclick="retryJob(${job.id})" title="Wymu≈õ pr√≥bƒô importu - sprawdzi limit API i spr√≥buje wznowiƒá">üîÑ Retry Now</button>
                                    <button class="job-action-btn" onclick="pauseJob(${job.id})">‚è∏Ô∏è Wstrzymaj</button>
                                ` : ''}
                                ${job.status === 'paused' ? `
                                    <button class="job-action-btn" onclick="resumeJob(${job.id})">‚ñ∂Ô∏è Wzn√≥w</button>
                                ` : ''}
                                <button class="job-action-btn" onclick="viewJobLogs(${job.id})">üìÑ Logi</button>
                                ${showHiddenJobs ? `
                                    <button class="job-action-btn" onclick="unhideJob(${job.id})" title="Przywr√≥ƒá zadanie na listƒô">‚Ü©Ô∏è Przywr√≥ƒá</button>
                                ` : `
                                    <button class="job-action-btn" onclick="hideJob(${job.id})" title="Ukryj zadanie z listy">üëÅÔ∏è Ukryj</button>
                                `}
                                ${job.status !== 'running' && job.status !== 'pending' ? `
                                    <button class="job-action-btn danger" onclick="deleteJob(${job.id})" title="Usu≈Ñ zadanie (nieodwracalne)">üóëÔ∏è Usu≈Ñ</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // Manage auto-refresh
                if (hasActiveJobs && !backgroundJobsInterval) {
                    backgroundJobsInterval = setInterval(refreshBackgroundJobs, 5000);
                } else if (!hasActiveJobs && backgroundJobsInterval) {
                    clearInterval(backgroundJobsInterval);
                    backgroundJobsInterval = null;
                }

            } catch (error) {
                console.error('Error refreshing jobs:', error);
                container.innerHTML = '<p style="color: #d32f2f; text-align: center; padding: 20px;">‚ùå B≈ÇƒÖd podczas ≈Çadowania zada≈Ñ</p>';
            }
        }

        async function pauseJob(jobId) {
            if (!confirm('Czy na pewno wstrzymaƒá to zadanie?')) return;

            try {
                const response = await fetch(`/api/import-jobs/${jobId}/pause`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd wstrzymywania zadania');
                }

                await refreshBackgroundJobs();
            } catch (error) {
                console.error('Error pausing job:', error);
                alert('B≈ÇƒÖd podczas wstrzymywania zadania: ' + error.message);
            }
        }

        async function resumeJob(jobId) {
            try {
                const response = await fetch(`/api/import-jobs/${jobId}/resume`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd wznawiania zadania');
                }

                await refreshBackgroundJobs();

                // Start auto-refresh
                if (!backgroundJobsInterval) {
                    backgroundJobsInterval = setInterval(refreshBackgroundJobs, 5000);
                }
            } catch (error) {
                console.error('Error resuming job:', error);
                alert('B≈ÇƒÖd podczas wznawiania zadania: ' + error.message);
            }
        }

        async function retryJob(jobId) {
            try {
                const response = await fetch(`/api/import-jobs/${jobId}/retry`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                alert(data.message || 'Pr√≥ba importu zainicjowana. Worker sprawdzi limity API i spr√≥buje wznowiƒá zadanie.');

                await refreshBackgroundJobs();

                // Start auto-refresh
                if (!backgroundJobsInterval) {
                    backgroundJobsInterval = setInterval(refreshBackgroundJobs, 5000);
                }
            } catch (error) {
                console.error('Error retrying job:', error);
                alert('B≈ÇƒÖd podczas pr√≥by ponownego importu: ' + error.message);
            }
        }

        async function viewJobLogs(jobId) {
            try {
                const response = await fetch(`/api/import-jobs/${jobId}/logs`);
                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd pobierania log√≥w');
                }

                const data = await response.json();

                if (data.logs.length === 0) {
                    alert('Brak log√≥w dla tego zadania');
                    return;
                }

                // Create modal to display logs
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                        <h2>üìÑ Logi zadania #${jobId}</h2>
                        <div style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; overflow-y: auto; max-height: 500px; font-family: 'Courier New', monospace; font-size: 12px; margin: 20px 0;">
                            ${data.logs.map(line => `<div style="margin-bottom: 4px;">${line}</div>`).join('')}
                        </div>
                        <div style="text-align: center;">
                            <button class="btn" style="background: #718096; color: white;" onclick="this.closest('.modal').remove()">
                                Zamknij
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

            } catch (error) {
                console.error('Error viewing logs:', error);
                alert('B≈ÇƒÖd podczas pobierania log√≥w: ' + error.message);
            }
        }

        async function hideJob(jobId) {
            if (!confirm('Czy na pewno ukryƒá to zadanie? Bƒôdzie nadal dostƒôpne w widoku ukrytych zada≈Ñ.')) return;

            try {
                const response = await fetch(`/api/import-jobs/${jobId}/hide`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd ukrywania zadania');
                }

                await refreshBackgroundJobs();
                alert('‚úÖ Zadanie ukryte');
            } catch (error) {
                console.error('Error hiding job:', error);
                alert('B≈ÇƒÖd podczas ukrywania zadania: ' + error.message);
            }
        }

        async function unhideJob(jobId) {
            try {
                const response = await fetch(`/api/import-jobs/${jobId}/unhide`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd przywracania zadania');
                }

                await refreshBackgroundJobs();
                alert('‚úÖ Zadanie przywr√≥cone');
            } catch (error) {
                console.error('Error unhiding job:', error);
                alert('B≈ÇƒÖd podczas przywracania zadania: ' + error.message);
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('‚ö†Ô∏è Czy na pewno USUNƒÑƒÜ to zadanie?\n\nTa operacja jest NIEODWRACALNA!\nWszystkie dane zadania, w tym logi, zostanƒÖ utracone.')) return;

            try {
                const response = await fetch(`/api/import-jobs/${jobId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd usuwania zadania');
                }

                await refreshBackgroundJobs();
                alert('‚úÖ Zadanie usuniƒôte');
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('B≈ÇƒÖd podczas usuwania zadania: ' + error.message);
            }
        }

        // Load jobs on page load
        if (document.getElementById('background-jobs-list')) {
            refreshBackgroundJobs();
        }
    </script>

    <!-- Stat Details Modal -->
    <div id="statModal" class="modal-backdrop" onclick="closeStatModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <button class="modal-close" onclick="closeStatModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Match details will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Modal functions
        function showStatModal(statLabel, matchesData, highlightValue = null) {
            const modal = document.getElementById('statModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = statLabel;

            // Clear previous content
            modalBody.innerHTML = '';

            if (!matchesData || matchesData.length === 0) {
                modalBody.innerHTML = '<p style="text-align: center; color: #999;">Brak danych do wy≈õwietlenia</p>';
            } else {
                matchesData.forEach(match => {
                    const matchItem = document.createElement('div');
                    matchItem.className = 'modal-match-item';

                    // Date
                    const dateEl = document.createElement('div');
                    dateEl.className = 'modal-match-date';
                    dateEl.textContent = match.date;

                    // Opponent with home/away indicator
                    const opponentEl = document.createElement('div');
                    opponentEl.className = 'modal-match-opponent';
                    opponentEl.textContent = `${match.opponent} (${match.homeAway})`;

                    // Result badge (W/D/L)
                    const resultEl = document.createElement('div');
                    resultEl.className = `modal-match-result ${match.resultClass}`;
                    resultEl.textContent = match.result;

                    // Value
                    const valueEl = document.createElement('div');
                    valueEl.className = 'modal-match-value';
                    if (highlightValue !== null && match.value === highlightValue) {
                        valueEl.classList.add('highlight');
                    }
                    valueEl.textContent = match.displayValue;

                    matchItem.appendChild(dateEl);
                    matchItem.appendChild(opponentEl);
                    matchItem.appendChild(resultEl);
                    matchItem.appendChild(valueEl);

                    modalBody.appendChild(matchItem);
                });
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeStatModal(event) {
            if (event && event.target !== event.currentTarget) return;

            const modal = document.getElementById('statModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeStatModal();
            }
        });

        // Initialize watched matches on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadWatchedMatches();
            ensureWatchedMatchesCard();
            loadMinimizedMatchCards(); // Restore minimized match cards
            restoreOpenModals();
            initBetFinder(); // Initialize bet finder as default tab
        });
    </script>
</body>

</html>